---
title: "Running the hake docker container on Windows"
output: rmarkdown::html_vignette
date: "This document was rendered on `r hake::curr_time_date()`"
vignette: >
  %\VignetteIndexEntry{Running the hake docker container on Windows}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE,
                      comment = "#>")
```

```{r setup, echo = FALSE, message = FALSE, results = "hide", warning = FALSE}
```

This vignette assumes you have installed Docker on your local Windows machine.
If it is an IT-controlled machine it is unlikely they will allow it to be
installed as the docker service requires root access to run the containers,
which they see as a vulnerability.

1. Acquire the [srv directory](https://drive.google.com/drive/folders/11KCdlsgk0hj3NlQY1aV6C99QBEP1GyQV)
   from Google Drive (need share permission) and place it wherever you want
   on your computer. Copy the absolute path of its location somewhere like
   the clipboard. For example, if you were on Windows, downloaded it and
   copied it into the directory `C:\work\hake`, copy the directory
   `c:\work\hake\srv` to the clipboard or make note of it. This folder
   contains an exact replica of the `/srv` directory structure on the server,
   so the code in the Docker container does not need to be modified to run
   the same as on the server. The directories contain only SS3 input files and
   the output RDS files for the models, not all the MCMC files and SS3 output
   files, so the download is not too long.

1. `git clone` the hake package from GitHub: \
   `git clone https://github.com/pacific-hake/hake-assessment`

1. You must link the directory on your computer from the download with the
   `/srv` directory inside the Docker container. Continuing the example
   above, the directory name `c:\work\hake\srv` where you stored the downloaded
   `srv` folder is in the clipboard. Edit the file `docker/run-hake-docker.sh`
   file and find this line:  \

   `elif [[ "$OSTYPE" == "msys" ]]; then` \
   
   then find your name, for example:

   `if [[ "$USERNAME" == "grandin" ]]; then`
   `  SRV_DIR="d:/WORK/A_Species/Hake/srv"`

   Set your `SRV_DIR` to the directory you pasted to the clipboard, which for
   this example was `c:\work\hake\srv`. Delete the `printf` message and
   `exit 1` associated with your name and save. If you commit this change
   to the repository it will be remembered for the future and you will not
   have to do this step again when you want to run the Docker container.

1. Open a Bash terminal and navigate to the `docker` directory of the
   `hake-assessment` repository. On Windows, open `Powershell` or `cmd`
   and type `bash` to open a bash shell.

1. Run `./run-hake-docker.sh`

1. Once the Docker Bash terminal starts, you can connect to the Rstudio server:

   - If you type `ls /srv` it will be listing the contents of your linked
     directory on your local machine (`c:\work\hake\srv` for the example
     above).
   - In the Bash terminal, type: `/init`. This will start the Rstudio server
     and leave the terminal in a paused state.
   - Open a browser.
   - In the URL bar, type `localhost:8787`
   - The Rstudio login page will appear. In the user box type `rstudio`. In
     the password box, type `a`.
   - Rstudio will open in your browser. You will start in the `doc` directory
     (this is the directory in which the main document is built).
   - To build the document in full now, type `render()`. For more information
     on building the document, see the `README.md` file for the [hake
     assessment repository](https://github.com/pacific-hake/hake-assessment).
   - To exit, click the button on the top right of the RStudio server page
     which says `rstudio` to its left and looks like an arrow pointing to
     the right off a white square, OR type `q()` at the console.
   - Go back to the Docker Bash terminal and press Ctrl-c a couple of times
     to return to the Bash prompt.
   - Type `exit` to close the Docker container.

## Introduction

The hake docker build files are found in the `docker` directory. The
`Dockerfile` is the primary script to build the image and the sub-directory
`ubuntu-essentials` contains the build files to create the starting image for
the hake docker image.

## Structure of the Docker image
**cgrandin/ubuntu-essentials** is based on the **rocker/tidyverse:latest**
image. See [The Rocker Project](https://rocker-project.org/). It contains
the latest versions of everything in it. Currently (December 2023) it
contains: \

1. Ubuntu 22.04 LTS Operating System

1. R version 4.3.2 (2023-10-31)

1. RStudio 2023.12.0 Build 369

1. Ubuntu packages added that are needed by the hake assessment project

## Contents of the **Dockerfile**

**cgrandin/hake** contains: \

1. [ADMB](https://github.com/admb-project/admb) release version 13.1
   (12-22-2023) built from source.
   
1. [SS3](https://github.com/nmfs-ost/ss3-source-code) release version 3.30.22
   (2023-10-31) built from source.
   
1. TexLive 2023 (texlive-base version) (https://www.tug.org/texlive/)

1. Many R packages that are either directly required by the hake project or
   dependency packages of those required.

1. A clone of the GitHub repository for the hake assessment in the directory: \
   `/home/rstudio/hake`
   
1. New environment variables:
   - $HOME (`/home/rstudio`)
   - $INST (`/usr/bin`)
   - $ADMB_HOME (`/usr/bin/admb/build/admb`)
   - $ADMB_AD2CSV (`/usr/bin/admb/contrib/ad2csv`)
   - $SS3_EXE_NAME (`ss3_2024`)
   - $SS3_HOME (`/usr/bin/ss3`)
   - $TEXLIVE_HOME (`/usr/local/texlive/2023/bin/x86_64-linux`)
   - $MANPATH (`/usr/local/texlive/2023/texmf-dist/doc/man`)
   - $INFOPATH (`/usr/local/texlive/2023/texmf-dist/doc/info`)

1. The **$PATH** environment variable has new paths added from the above list:
   - $HOME
   - $ADMB_HOME/bin
   - $ADMB_AD2CSV
   - $SS3_HOME
   - $TEXLIVE_HOME



To have **<span style="color:green;">Verified</span>** appear on your GitHub

