---
title: "**\\TitleFont{Status of the Pacific Hake (whiting) stock in U.S. and Canadian waters in `r params$assess_yr`}**"
params:
  sp: "Pacific Hake"
  common_name: "Pacific whiting"
  science_name: "Merluccius productus"
  simple_name: "hake"
  survey_name: "Joint U.S. and Canadian Integrated Acoustic and Trawl Survey"
  assess_yr: 2023
  last_assess_yr: 2022
  model_version: "01"
  last_yr_model_version: "01"
author: |
  Joint Technical Committee of the Pacific Hake/Whiting Agreement \
  Between the Governments of the United States and Canada \
  \
  \
date: "`r format(Sys.time(), '%B %d')`\\textsuperscript{th}, `r format(Sys.time(), '%Y')`"
header: "Draft working paper --- Do not cite or circulate" # or "" to omit
output:
 bookdown::pdf_document2:
   latex_engine: pdflatex
   keep_tex: true
   toc: false
   fig_caption: yes
   includes:
     in_header: "preamble.tex"
fontsize: 11pt
urlcolor: blue
header-includes:
  - \usepackage{sectsty}
  - \usepackage{titling}
  - \pagenumbering{gobble}
  - \pretitle{\begin{center}}
  - \posttitle{\end{center}\begin{center}\LARGE\includegraphics[width=12cm]{main-figures/hake-picture.png}\\[\bigskipamount]\end{center}}
  - \pagenumbering{arabic}
  - \lfoot{DRAFT -- `r params$sp` assessment `r params$assess_yr`}
link-citations: true
bibliography: bib/refs.bib
---

```{r setup, echo=FALSE, cache=FALSE, message=FALSE, results='hide', warning=FALSE}
library(knitr)
devtools::load_all(here::here())
if (is_latex_output()) {
  knitr_figs_dir <- "knitr-figs-pdf/"
  knitr_cache_dir <- "knitr-cache-pdf/"
  fig_out_type <- "png"
} else {
  knitr_figs_dir <- "knitr-figs-docx/"
  knitr_cache_dir <- "knitr-cache-docx/"
  fig_out_type <- "png"
}
fig_asp <- 0.618
fig_width <- 9
fig_out_width <- "6in"
fig_dpi <- 180
fig_align <- "center"
fig_pos <- "htb"
opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>",
  fig.path = knitr_figs_dir,
  cache.path = knitr_cache_dir,
  fig.asp = fig_asp,
  fig.width = fig_width,
  out.width = fig_out_width,
  echo = FALSE,
  autodep = FALSE,
  cache = TRUE,
  cache.lazy = FALSE,
  cache.comments = FALSE,
  dev = fig_out_type,
  dpi = fig_dpi,
  fig.align = fig_align,
  fig.pos = fig_pos)

if(file.exists("hake.tex")){
  system("./clean")
}
```

\newpage

This document reports the collaborative efforts of the official U.S. and
Canadian members of the Joint Technical Committee, and others that
contributed significantly.

\

Authors of this document are (all authors contribute extensively so the order rotates annually):
<!-- Note that there are two spaces at the end of the following four author lines -->

Aaron M. Berger^1^  
Chris J. Grandin^2^  
Kelli F. Johnson^3^  
Andrew M. Edwards^2^  

\

^1^ *Northwest Fisheries Science Center, National Marine
  Fisheries Service, National Oceanic and Atmospheric Administration,
  U.S. Department of Commerce, 2032 SE OSU Dr. Bldg. 955, Newport, OR
  97365-5275, USA*

^2^ *Pacific Biological Station, Fisheries and Oceans Canada,
  3190 Hammond Bay Road, Nanaimo, B.C. V9T 6N7, Canada*

^3^ *Northwest Fisheries Science Center, National Marine Fisheries
  Service, National Oceanic and Atmospheric Administration, U.S. Department of
  Commerce, 2725 Montlake Blvd. East, Seattle, WA 98112-2097, USA*


TABLE OF CONTENTS GOES HERE - DO NOT DELETE OR MODIFY THIS LINE


<!--chapter:end:000-launcher.rmd-->

```{r load-packages-chunk, echo = FALSE}

# To install rnaturalearthhires (it was hard to find with Google):
# devtools::install_github("ropensci/rnaturalearthhires")
# devtools::install_github("pbs-assess/gfutilities")
message("Loading R packages...")
pacman::p_load(
  # Alphabetical order
  adnuts,
  cli, coda, cowplot, crayon,
  data.tree, date, dplyr,
  future, furrr,
  gfutilities, ggh4x, ggplot2, ggpubr, ggrepel, grDevices, grid,
  gridGraphics, gridExtra, gtools,
  here,
  kableExtra, knitr,
  lubridate,
  maps, maptools, matrixcalc,
  parallel, purrr,
  r4ss, RColorBrewer, readr, reshape2, rgeos, rnaturalearth, rnaturalearthhires, rstan,
  scales, shinystan, sf, stringr,
  testthat, tictoc, tidyr, tools,
  xtable)
message("Finished loading R packages...")
```

<!--chapter:end:001-load-packages.rmd-->

```{r load-globals-chunk, echo = FALSE}

meta <- rmarkdown::metadata

sp <- meta$`params`$sp
common_name <- meta$`params`$common_name
science_name <- meta$`params`$science_name
simple_name <- meta$`params`$simple_name
survey_name <- meta$`params`$survey_name
assess_yr <- meta$`params`$assess_yr
last_assess_yr <- meta$`params`$last_assess_yr
model_version <- meta$`params`$model_version
last_yr_model_version <- meta$`params`$last_yr_model_version

sys_info <- Sys.info()
computer_name <- sys_info[["nodename"]]
os_name <- sys_info[["sysname"]]
user_name <- sys_info[["user"]]

rootd_doc <- here::here("doc")
rootd_data <- here::here("inst/extdata/data")
rootd_models <- ifelse(computer_name == "hake-precision",
                       "/srv/hake/models",
                       here::here("models"))
models_dir <- file.path(rootd_models,
                        assess_yr,
                        paste0(model_version, "-version"))
last_yr_models_dir <- file.path(rootd_models,
                                last_assess_yr,
                                paste0(last_yr_model_version, "-version"))

output_csv_dir <- here::here(rootd_doc, "out-csv")

ct_levels_path <- "catch-levels"
default_hr_path <- "default-hr"
stable_catch_path <- "stable-catch"
spr_100_path <- "spr-100"
forecasts_path <- "forecasts"
retrospectives_path <- "retrospectives"

ss_executable <- "ss3"
starter_file_name <- "starter.ss"
par_file_name <- "ss.par"
forecast_file_name <- "forecast.ss"
weight_at_age_file_name <- "wtatage.ss"
posts_file_name <- "posteriors.sso"
derposts_file_name <- "derived_posteriors.sso"
report_file_name <- "Report.sso"
compreport_file_name <- "CompReport.sso"

# Custom catch levels calculations
# The tolerance in the spr away from 1 for the calculation of catch for SPR = 1
ct_levels_spr_tol <- 0.001
# The tolerance in tonnes. The iterations will stop if the difference between the
#  projected biomass between the first and second years is less than this
ct_levels_catch_tol <- 100
# The maximum number of iterations to do. If this is reached, then no catch value could
#  be found within the tolerances above
ct_levels_max_iter <- 20

forecast_yrs <- assess_yr:(assess_yr + 3)
forecast_yrs_extra <- assess_yr:(assess_yr + 3)
forecast_probs <- c(0.05, 0.25, 0.5, 0.75, 0.95)

retrospective_yrs <- 1:10
plot_retro_yrs <- 1:5

show_ss_output <- FALSE

theme_set(hake_theme())

# -----------------------------------------------------------------------------
# Data start and endpoint variables
# -----------------------------------------------------------------------------
recruit_dev_start_yr <- 1946
unfished_eq_yr <- 1964
start_yr <- 1966
start_yr_age_comps <- 1975
end_yr <- assess_yr
last_data_yr <- end_yr - 1
survey_start_yr <- 1995
survey_end_yr <- 2021
surv_yrs <- c(1995, 1998, 2001, 2003, 2005, 2007,
              2009, 2011, 2012, 2013, 2015, 2017,
              2019, 2021)

# tick marks for time series plot (not catch time series though)
big_ticks <- seq(1970, end_yr + 4, 5)
small_ticks <- start_yr:max(big_ticks)

# -----------------------------------------------------------------------------
# Key posteriors used in the assessment
# -----------------------------------------------------------------------------
key_posteriors <- c("NatM",
                    "SR_LN",
                    "SR_BH_steep",
                    "Q_extraSD_Acoustic_Survey",
                    "ln\\(DM_theta\\)_Age_P1",
                    "ln\\(DM_theta\\)_Age_P2")
key_posteriors_titles <- c("Natural mortality",
                           expression(ln(R[0])),
                           "Steepness",
                           "Survey extra SD",
                           "Dirichlet-multinomial fishery",
                           "Dirichlet-multinomial survey")
key_posteriors_file <- "keyposteriors.csv"
nuisance_posteriors_file <- "nuisanceposteriors.csv"
```

<!--chapter:end:002-load-globals.rmd-->

<!-- Load all data tables into global variables
     The files are loaded from the package installation, so you must
     build and install the package before trying to run this code or
     build the document -->

```{r load-data-tables-chunk, echo = FALSE}
library(readr)
# Data file names and loading ----
load_dir <- system.file("extdata", "data", package = "hake")
if(load_dir == ""){
  stop("The directory containing the data tables does not exist. Install the ",
       "`hake` package and try again",
       call. = FALSE)
}
if(!dir.exists(load_dir)){
  stop("The directory `", load_dir, "` does not exist. Install the `hake` ",
       "package and try again",
       call. = FALSE)
}
message("Loading all data tables (csv files) from `",
        load_dir,
        "`")

# Assessment history and changes ----
pkg <- "hake"
assess_history_df <-
  read_csv(file.path(load_dir, "assessment-history.csv"),
           col_types = cols(),
           show_col_types = FALSE)
assess_history_probs_df <-
  read_csv(file.path(load_dir, "assessment-history-probs.csv"),
           col_types = cols(),
           comment = "#",
           show_col_types = FALSE)
assess_changes_df <-
  read_csv(file.path(load_dir, "assessment-changes.csv"),
           col_types = cols(),
           show_col_types = FALSE)
assess_history_disp_df <-
  read_csv(file.path(load_dir, "assessment-history-SSBdispersion.csv"),
           col_types = cols(),
           show_col_types = FALSE)

# Maturity and weight-at-age ----
ovary_samples_df <-
  read_csv(file.path(load_dir, "ovary-samples.csv"),
           col_types = cols(),
           show_col_types = FALSE)
maturity_ogives_df <-
  read_csv(file.path(load_dir, "maturity-table.csv"),
           col_types = cols(),
           show_col_types = FALSE)
maturity_samples_df <-
  read_csv(file.path(load_dir, "hake-maturity-data.csv"),
           guess_max = Inf,
           show_col_types = FALSE)
weight_age_extrapolation_mask <-
  read_csv(file.path(load_dir, "wtatage_all_samplesize.csv"),
           col_types = cols(),
           show_col_types = FALSE)

# Catch and TAC ----
ct <-
  read_csv(file.path(load_dir, "landings-tac-history.csv"),
           col_types = cols(),
           show_col_types = FALSE) |> 
  mutate(`U.S. Total` =
           `U.S. Foreign` +
           `U.S. Joint-venture` +
           `U.S. Mothership` +
           `U.S. Catcher-processor` +
           `U.S. Shore-based` +
           `U.S. Research`,
         `Canada Total` =
           `Canada Foreign` +
           `Canada Joint-venture` +
           `Canada Shoreside` +
           `Canada Freezer-trawler`,
         Total = `U.S. Total` + `Canada Total`,
         us_prop = `U.S. Total` / Total * 100,
         can_prop = `Canada Total` / Total * 100,
         us_attain = `U.S. Total` / `U.S. TAC` * 100,
         can_attain = `Canada Total` / `Canada TAC` * 100,
         tot_attain = `Total` / `Total TAC` * 100)

catch_targets_df <-
  read_csv(file.path(load_dir, "catch-targets-biomass.csv"),
           col_types = cols(),
           show_col_types = FALSE)
further_tac_df <-
  read_csv(file.path(load_dir, "further-tac-details.csv"),
           col_types = cols(),
           comment = "#",
           show_col_types = FALSE)
# * Canadian catch ----
can_ft_catch_by_month_df <-
  read_csv(file.path(load_dir, "can-ft-catch-by-month.csv"),
           col_types = cols(),
           show_col_types = FALSE)
can_ss_catch_by_month_df <-
  read_csv(file.path(load_dir, "can-ss-catch-by-month.csv"),
           col_types = cols(),
           show_col_types = FALSE)
can_jv_catch_by_month_df <-
  read_csv(file.path(load_dir, "can-jv-catch-by-month.csv"),
           col_types = cols(),
           show_col_types = FALSE)
# * US catch ----
us_ss_catch_by_month_df <-
  read_csv(file.path(load_dir, "us-shore-catch-by-month.csv"),
           col_types = cols(),
           show_col_types = FALSE)
us_cp_catch_by_month_df <-
  read_csv(file.path(load_dir, "us-cp-catch-by-month.csv"),
           col_types = cols(),
           show_col_types = FALSE)
us_ms_catch_by_month_df <-
  read_csv(file.path(load_dir, "us-ms-catch-by-month.csv"),
           col_types = cols(),
           show_col_types = FALSE)
us_ti_ct_by_month_df <-
  read_csv(file.path(load_dir, "us-ti-catch-by-month.csv"),
           col_types = cols(),
           show_col_types = FALSE)
us_research_catch_by_month_df <-
  read_csv(file.path(load_dir, "us-research-catch-by-month.csv"),
           col_types = cols(),
           show_col_types = FALSE)

# Sampling data ----
sampling_history_df <-
  read_csv(file.path(load_dir, "fishery-sampling-history.csv"),
           col_types = cols(),
           show_col_types = FALSE)
# * Canada sampling ----
can_ages_lst <-
  load_can_age_data(file.path(load_dir, "can-age-data.csv"))
can_ft_num_fish <-
  read_csv(file.path(load_dir, "can-ft-num-fish-aged.csv"),
           col_types = cols(),
           show_col_types = FALSE)
can_ss_num_fish <-
  read_csv(file.path(load_dir, "can-ss-num-fish-aged.csv"),
           col_types = cols(),
           show_col_types = FALSE)
can_jv_num_fish <-
  read_csv(file.path(load_dir, "can-jv-num-fish-aged.csv"),
           col_types = cols(),
           show_col_types = FALSE)
can_ss_age_df <- can_ages_lst[[1]]
can_ft_age_df <- can_ages_lst[[2]]
# * US sampling ----
us_ss_age_df <-
  read_csv(file.path(load_dir, "us-shore-age-data.csv"),
           col_types = cols(),
           show_col_types = FALSE)
us_cp_age_df <-
  read_csv(file.path(load_dir, "us-cp-age-data.csv"),
           col_types = cols(),
           show_col_types = FALSE)
us_ms_age_df <-
  read_csv(file.path(load_dir, "us-ms-age-data.csv"),
           col_types = cols(),
           show_col_types = FALSE)

# Survey data ----
kriging_pars_df <-
  read_csv(file.path(load_dir, "kriging-parameters.csv"),
           col_types = cols(),
           comment = "#",
           show_col_types = FALSE)
survey_history_df <-
  read_csv(file.path(load_dir, "survey-history.csv"),
           col_types = cols(),
           show_col_types = FALSE)
survey_by_country_df <-
  read_csv(file.path(load_dir, "survey-by-country.csv"),
           col_types = cols(),
           comment = "#",
           show_col_types = FALSE)

# Depth data ----
# * Canada depths ----
can_ft_bottom_depth_df <-
  read_csv(file.path(load_dir, "depth-can-ft-bottom.csv"),
           col_types = cols(),
           show_col_types = FALSE)
can_ss_bottom_depth_df <-
  read_csv(file.path(load_dir, "depth-can-ss-bottom.csv"),
           col_types = cols(),
           show_col_types = FALSE)
can_ft_gear_depth_df <-
  read_csv(file.path(load_dir, "depth-can-ft-gear.csv"),
           col_types = cols(),
           show_col_types = FALSE)
can_ss_gear_depth_df <-
  read_csv(file.path(load_dir, "depth-can-ss-gear.csv"),
           col_types = cols(),
           show_col_types = FALSE)
# * US depths ----
us_atsea_fishing_depth_df <-
  read_csv(file.path(load_dir, "depth-us-atsea-fishing.csv"),
           col_types = cols(),
           show_col_types = FALSE)
us_atsea_bottom_depth_df <-
  read_csv(file.path(load_dir, "depth-us-atsea-bottom.csv"),
           col_types = cols(),
           show_col_types = FALSE)

# At-age output data table file names ----
out_est_naa_file <- "estimated-numbers-at-age.csv"
out_est_eaa_file <- "estimated-exploitation-at-age.csv"
out_est_caa_file <- "estimated-catch-at-age.csv"
out_est_caa_bio_file <- "estimated-catch-at-age-biomass.csv"
out_est_baa_file <- "estimated-biomass-at-age.csv"
```

<!--chapter:end:003-load-data-tables.rmd-->

```{r source-load-models, echo = FALSE}
source(here::here("doc/004-load-models.R"))
```

<!--chapter:end:004-load-models.rmd-->

<!-- Place LaTeX macros here, and R variables in the knitr chunk below -->
\newcommand{\FSPRthirtyfive}{\mathrm{F_{SPR=35\%}}}
\newcommand{\FSPRforty}{\mathrm{F_{SPR=40\%}}}
\newcommand{\FSPRfortyfive}{\mathrm{F_{SPR=45\%}}}
\newcommand{\FSPRfifty}{\mathrm{F_{SPR=50\%}}}
\newcommand{\BSPRforty}{\mathrm{B_{SPR=40\%}}}
\newcommand{\SPRforty}{\mathrm{SPR_{40\%}}}
\newcommand{\Ffortyten}{$\Fforty$--40:10}
\newcommand{\Ffortyfivefortyten}{$\Ffortyfive$--40:10}
\newcommand{\FishingRate}{(1 - $\mathrm{SPR(F)}$)/(1 - $\SPRforty$)}
\newcommand{\Fforty}{\mathrm{F_{40\%}}}
\newcommand{\Bforty}{\mathrm{B_{40\%}}}
\newcommand{\Ffortyfive}{\mathrm{F_{45\%}}}
\newcommand{\Btwentyfive}{\mathrm{B_{25\%}}}
\newcommand{\Bten}{\mathrm{B_{10\%}}}
\newcommand{\Bzero}{\mathrm{B_{0}}}
\newcommand{\Rzero}{\mathrm{R_{0}}}
\newcommand{\Bmsy}{\mathrm{B_{MSY}}}
\newcommand{\Fmsy}{\mathrm{F_{MSY}}}
\newcommand{\Fspr}{\mathrm{F_{SPR}}}

```{r load-custom-knitr-variables-chunk, echo = FALSE}
# Put any variables you intend to use in the text here.
# The function f() is for formatting and is defined in
# r-functions/utilities.r

# -----------------------------------------------------------------------------
# The forecasting yrs and probabilities can be set to whatever is required, the
#  code is set up to automatically accommodate changes
#  Change them in all.R
# -----------------------------------------------------------------------------

# -----------------------------------------------------------------------------
# ct_levels is a list of N 3-item lists of catch levels with values:
#  1. values for catch to forecast
#  2. their pretty names to appear in the document
#  3. their directory names
# Each element of the list is a list of length equal to the
# number of elements in forecast_yrs.
# See the calc.ct.levels() and fetch.ct.levels() functions
#  is load-models.R for details. The NA's below will be populated in each model
#  by those two functions.

# -----------------------------------------------------------------------------
nf <- length(forecast_yrs)
ct_levels <-
  list(list(rep(0.01, nf), "No Fishing", "01-0"),
       list(rep(180000, nf), "180,000 t", "02-180000"),
       list(rep(225000, nf), "225,000 t", "03-225000"),
       list(rep(270000, nf), "270,000 t", "04-270000"),
       list(c(320000, 288000, 259200, 233280), "320,000 t 10% red.", "05-320000-10"),
       list(rep(325000, nf), "2022 catch: 325,000 t", "06-325000"),
       list(rep(350000, nf), "350,000 t", "07-350000"),
       list(c(350000, 315000, 283500, 255150), "350,000 t 10% red.", "08-350000-10"),
       list(rep(380000, nf), "380,000 t", "09-380000"),
       list(c(380000, 342000, 307800, 277020), "380,000 t 10% red.", "10-380000-10"),
       list(rep(430000, nf), "430,000 t", "11-430000"),
       list(rep(545000, nf), "2022 TAC: 545,000 t", "12-545000"),
       list(rep(NA, nf), "FI=100%", "13-spr-100"),
       list(rep(NA, nf), "Default Harvest Policy", "14-default-hr"),
       list(rep(NA, nf), "Stable Catch", "15-stable-catch"))

# -----------------------------------------------------------------------------
# Indices for the forecasts list, which list items above are the TAC case and
#  default policy case
# This is used in the one-page summary and a plot comparing several catch cases,
#  and elsewhere
# -----------------------------------------------------------------------------
ct_levels_num <- length(ct_levels)
ct_actual_ind <- 6
ct_tac_ind <- 12
ct_spr100_ind <- 13
ct_default_policy_ind <- 14
ct_stable_ind <- 15
ct_reduction_rows <- c(5, 8, 10)
ct_constant_rows <- c(1, 2, 3, 4, 6, 7, 9, 11, 12)
ct_constant_str <- paste(letters[ct_constant_rows], collapse = ", ")
ct_reduction_str <- paste(letters[ct_reduction_rows], collapse = ", ")

# Could probably extract automatically from bridge_models_desc[[1]][1]
ss_version <- "3.30.20"

# Credible interval -----------------------------------------------------------
cred_int <- c(0.025, 0.5, 0.975)

# Shortened names -------------------------------------------------------------
mc <- base_model$mcmccalcs
extramc <- base_model$extra_mcmc

# Attainment in the past ------------------------------------------------------
ct_last10 <- ct |>
  filter(Year %in% (end_yr - 10):(end_yr - 1))
ct_last5 <- ct |>
  filter(Year %in% (end_yr - 5):(end_yr - 1))
ct_last2 <- ct |>
  filter(Year %in% (end_yr - 2):(end_yr - 1))
ct_last1 <- ct |>
  filter(Year == end_yr - 1)
ct_secondlast <- ct |>
  filter(Year == end_yr - 2)
us_last_5_yrs_attainment <- ct_last5 |>
  pull(`us_attain`) |>
  mean() |>
  f(1)
us_last_2_yrs_attainment <- ct_last2 |>
  pull(`us_attain`) |>
  mean() |>
  f(0)
can_last_5_yrs_attainment <- ct_last5 |>
  pull(`can_attain`) |>
  mean() |>
  f(1)
can_last_2_yrs_attainment <- ct_last2 |>
  pull(`can_attain`) |>
  mean() |>
  f(0)
tot_last_5_yrs_attainment <- ct_last5 |>
  pull(`tot_attain`) |>
  mean() |>
  f(1)
tot_last_10_yrs_attainment <- ct_last10 |>
  pull(`tot_attain`) |>
  mean() |>
  f(1)
tot_last_yr_attainment <- ct_last1 |>
  pull(`tot_attain`) |>
  mean() |>
  f(1)
tot_2015_attainment <- ct |>
  filter(Year == 2015) |>
  pull(`tot_attain`) |>
  mean() |>
  f(1)
tot_9192_attainment <- ct |>
  filter(Year %in% 1991:1992) |>
  pull(`tot_attain`) |>
  mean() |>
  f(0)
tot_9399_attainment <- ct |>
  filter(Year %in% 1993:1999) |>
  pull(`tot_attain`) |>
  mean() |>
  f(0)

# Allotments ------------------------------------------------------------------
can_allotment_percent <- 26.12
us_allotment_percent <- 73.88
# ... allotments in catch -----------------------------------------------------
can_allotment_percent_last_yr <- f(pull(ct_last1, `Canada TAC`) /
                                     pull(ct_last1, `Total TAC`) * 100, 2)
us_allotment_percent_last_yr <- f(pull(ct_last1, `U.S. TAC`) /
                                    pull(ct_last1, `Total TAC`) * 100, 2)
# Further TAC sources ---------------------------------------------------------
ft <- further_tac_df # (defined in inst/extdata/data/02-load-data-tables.rnw)
last_yr_us_tribal <- ft |>
  filter(Year == last_data_yr) |>
  pull(us_tribal_quota)
last_yr_us_research <- ft |>
  filter(Year == last_data_yr) |>
  pull(us_research_quota)
last_yr_us_non_tribal <- ft |>
  filter(Year == last_data_yr) |>
  pull(us_nontribal_quota)
last_yr_us_tribal_quota_reallocated <- ft |>
  filter(Year == last_data_yr) |>
  pull(us_tribal_quota_reallocated)
last_yr_us_tribal_reallocate_dates <- ft |>
  filter(Year == last_data_yr) |>
  pull(us_tribal_reallocate_dates)
last_yr_us_tribal_reallocate_dates_f <-
  format(as.Date(as.character(last_yr_us_tribal_reallocate_dates),
                 "%d-%b"),
         "%B %d")
last_yr_us_tribal_max_landed <- ft |>
  filter(Year == last_data_yr) |>
  pull(us_tribal_max_landed)
last_yr_us_shore_quota_reallocated <- ft |>
  filter(Year == last_data_yr) |>
  pull(us_shore_reallocated)
last_yr_us_cp_quota_reallocated <- ft |>
  filter(Year == last_data_yr) |>
  pull(us_cp_reallocated)
last_yr_us_ms_quota_reallocated <- ft |>
  filter(Year == last_data_yr) |>
  pull(us_ms_reallocated)

# Catch -----------------------------------------------------------------------
# ... recent catch ------------------------------------------------------------
last_5_yrs_total_ct <- ct_last5 |>
  pull(Total)
long_term_avge_ct <- mean(ct$Total)
ct_limit_quantiles <-
  f(as.numeric(quantile(base_model$mcmc[[paste0("ForeCatch_",
                                                end_yr)]],
                        probs = cred_int)))
names(ct_limit_quantiles) <- c("lower", "median", "upper")
# ... recent catch, last year -------------------------------------------------
last_yr_landings <- ct_last1 |>
  pull(Total) |>
  f(0)
last_yr_tac <- ct_last1 |>
  pull(`Total TAC`) |>
  f(0)
# ... catch over the last 10 years --------------------------------------------
ct_last_10yrs <- ct |>
  slice_tail(n = 10)
ct_mean_10yrs <- f(mean(ct_last_10yrs$Total))
ct_us_mean_10yrs <- f(mean(ct_last_10yrs$`U.S. Total`))
ct_can_mean_10yrs <- f(mean(ct_last_10yrs$`Canada Total`))
# ... US Catch by fleet, last year --------------------------------------------
last_yr_us_research_ct <- ct |>
  filter(Year == last_data_yr) |>
  pull(`U.S. Research`)
last_yr_us_cp_ct <- ct |>
  filter(Year == last_data_yr) |>
  pull(`U.S. Catcher-processor`)
last_yr_us_ms_ct <- ct |>
  filter(Year == last_data_yr) |>
  pull(`U.S. Mothership`)
last_yr_us_shore_ct <- ct |>
  filter(Year == last_data_yr) |>
  pull(`U.S. Shore-based`)
last_yr_us_ti_ct <- us_ti_ct_by_month_df |>
  filter(year == last_data_yr) |>
  pull(catch) |>
  sum()
catcher_processor_ct <- ((ct_last1 |>
                            pull(`U.S. Catcher-processor`)) /
                           (last_yr_us_cp_quota_reallocated) * 100) |>
  f(1)
mothership_ct <- ((ct_last1 |>
                     pull(`U.S. Mothership`)) /
                    (last_yr_us_ms_quota_reallocated) * 100) |>
  f(1)
shore_based_ct <- ((ct_last1 |>
                      pull(`U.S. Shore-based`) -
                      last_yr_us_ti_ct) /
                     (last_yr_us_shore_quota_reallocated) * 100) |>
  f(1)

# Attainment ------------------------------------------------------------------
# ... US Attainment, catch, and TAC -------------------------------------------
last_yr_us_landings <- ct_last1 |>
  pull(`U.S. Total`) |>
  f(0)
last_yr_us_attained <- ct_last1 |>
  pull(us_attain) |>
  f(1)
last_2yr_us_attained_diff <- (ct_last1 |>
                                pull(us_attain) -
                                ct_secondlast |>
                                pull(us_attain)) |>
  f(1)
last_yr_us_tac <- ct_last1 |>
  pull(`U.S. TAC`) |>
  f(0)
# ... US Attainment by fleet, last year ---------------------------------------
last_yr_us_cp_ct_percent <- f(last_yr_us_cp_ct /
                                   last_yr_us_cp_quota_reallocated * 100,
                                 1)
last_yr_us_ms_ct_percent <- f(last_yr_us_ms_ct /
                                   last_yr_us_ms_quota_reallocated * 100,
                                 1)
last_yr_us_shore_ct_percent <- f(last_yr_us_shore_ct /
                                      last_yr_us_shore_quota_reallocated * 100,
                                    1)

# ... Canada Attainment, catch, and TAC ---------------------------------------
last_yr_can_carryover <- ft |>
  filter(Year == last_data_yr) |>
  pull(can_carried_over) |>
  f(0)
last_yr_can_attained <- ct_last1 |>
  pull(can_attain) |>
  f(1)
last_2yr_can_attained_diff <- ((ct_last1 |>
                                  pull(can_attain)) -
                                 (ct_secondlast |>
                                    pull(can_attain))) |>
  f(1)
last_yr_can_landings <- ct_last1 |>
  pull(`Canada Total`) |>
  f(0)
last_yr_can_tac <- ct_last1 |>
  pull(`Canada TAC`) |>
  f(0)
last_yr_can_tac.jv <- ft |>
  filter(Year == last_data_yr) |>
  pull(can_jv_tac) |>
  f(0)
last_yr_can_shoreside_tac <- ((ct_last1 |>
                                   pull(`Canada TAC`)) -
                                  (ft |>
                                     filter(Year == last_data_yr) |>
                                     pull(can_jv_tac))) |>
  f(0)
latest_yr_can_jv <- ct |>
  filter(`Canada Joint-venture` > 0) |>
  pull(Year) |>
  max()
last_yr_can_shore <- ct_last1 |>
  pull(`Canada Shoreside`) |>
  f(0)
last_yr_can_freezer <- ct_last1 |>
  pull(`Canada Freezer-trawler`) |>
  f(0)
last_yr_can_jv <- ct_last1 |>
  pull(`Canada Joint-venture`) |>
  f(0)
last_yr_can_shore_percent <- ((ct_last1 |>
                                 pull(`Canada Shoreside`)) /
                                (ct_last1 |>
                                   pull(`Canada Total`)) * 100) |>
  f(1)
last_yr_can_freezer_percent <- ((ct_last1 |>
                                   pull(`Canada Freezer-trawler`)) /
                                  (ct_last1 |>
                                     pull(`Canada Total`)) * 100) |>
  f(1)
last_yr_can_jv_percent <- ((ct_last1 |>
                              pull(`Canada Joint-venture`)) /
                             (ct_last1 |>
                                pull(`Canada Total`)) * 100) |>
  f(1)
# Years since 2000 (including 2000) that JV catch has been zero
terminal_yr_us_jv_foreign <- ct |>
  filter(`U.S. Foreign` > 0 | `U.S. Joint-venture` > 0) %>%
  slice(nrow(.)) |>
  pull(Year)
first_yr_us_atsea <- ct |>
  filter(`U.S. Catcher-processor` > 0 | `U.S. Mothership` > 0) |>
  slice(1) |>
  pull(Year)

# Survey values ---------------------------------------------------------------
survey_biomass <- base_model$dat$CPUE |>
  filter(index == 2) |>
  pull(var = obs, name = year) / 1e6

survey_comps <- base_model$dat$agecomp |>
  filter(FltSvy == 2)
rownames(survey_comps) <- survey_comps$Yr

survey_last_yr <- survey_comps %>%
  slice(nrow(.))

survey_last_yr_age <- survey_last_yr |>
  select(matches("^a", ignore.case = FALSE)) |>
  unlist(1) |>
  sort(decreasing = TRUE)
names(survey_last_yr_age) <- gsub("^a", "", names(survey_last_yr_age))

survey_a2_prop <- f(survey_last_yr_age[names(survey_last_yr_age) == 2], 1)
last_survey_yr <- max(as.numeric(names(survey_biomass)))
# Millions of tonnes
last_survey_yr_biomass <- base_model$dat$CPUE |>
  filter(index == 2, year == max(year)) |>
  mutate(obs = obs / 1e6) |>
  pull(obs) |>
  f(2)
penult_survey_yr <- base_model$dat$CPUE |>
  filter(index == 2) |>
  pull(year) |>
  sort() %>%
  `[`(length(.) - 1)

# How many times higher is the last survey than the one before it?
last_factor_penult <- base_model$dat$CPUE |>
  filter(index == 2) |>
  mutate(new = obs / lag(obs)) |>
  filter(year %in% c(last_survey_yr)) |>
  pull(new) |>
  f(1)

# Age-1 survey
survey_age1_yrs <- base_model$dat$CPUE |>
  filter(index == 3) |>
  pull(year)
# Spawning Biomass and Depletion estimates ------------------------------------
curr_depl_lower <- f(mc$dlower[names(mc$dlower) == end_yr] * 100, 0)
curr_depl_median <- f(mc$dmed[names(mc$dmed) == end_yr] * 100, 0)
curr_depl_upper <- f(mc$dupper[names(mc$dupper) == end_yr] * 100, 0)
# These are millions of tons:
curr_bio_lower <- f(mc$slower[names(mc$slower) == end_yr], 3)
curr_bio_median <- f(mc$smed[names(mc$smed) == end_yr], 3)
curr_bio_upper <- f(mc$supper[names(mc$supper) == end_yr], 3)
# These are metric tonnes:
curr_bio_lower_tonnes <- f(mc$slower[names(mc$slower) == end_yr] * 1e6, 0)
curr_bio_median_tonnes <- f(mc$smed[names(mc$smed) == end_yr] * 1e6, 0)
curr_bio_upper_tonnes <- f(mc$supper[names(mc$supper) == end_yr] * 1e6, 0)
# ... spawning biomass for previous year --------------------------------------
# (calculated in this assessment) in millions of tonnes and then tonnes
prev_bio_lower <- f(mc$slower[names(mc$slower) == last_data_yr], 3)
prev_bio_median <- f(mc$smed[names(mc$smed) == last_data_yr], 3)
prev_bio_upper <- f(mc$supper[names(mc$supper) == last_data_yr], 3)
prev_bio_lower_tonnes <- f(mc$slower[names(mc$slower) == last_data_yr] * 1e6, 0)
prev_bio_median_tonnes <- f(mc$smed[names(mc$smed) == last_data_yr] * 1e6, 0)

ratio_bio_median_curr_last <- mc$smed[names(mc$smed) == end_yr] /
  mc$smed[names(mc$smed) == last_data_yr]
if(ratio_bio_median_curr_last > 1){
  diff_bio_median_last_curr <-
    f((mc$smed[names(mc$smed) == end_yr] /
                mc$smed[names(mc$smed) == last_data_yr] - 1) * 100)
  diff_bio_median_last_curr_text <- "higher than"
}else{
  diff_bio_median_last_curr <-
    f((mc$smed[names(mc$smed) == end_yr] /
         mc$smed[names(mc$smed) == last_data_yr]) * 100)
  diff_bio_median_last_curr_text <- "of"
}
prev_bio_upper_tonnes <- f(mc$supper[names(mc$supper) == last_data_yr] * 1e6, 0)
# ... spawning biomass for previous year (last year's assessment) -------------
prev_bio_lower_last_assess <-
  f(last_yr_base_model$mcmccalcs$slower[names(mc$slower) == last_data_yr], 3)
prev_bio_median_last_assess <-
  f(last_yr_base_model$mcmccalcs$smed[names(mc$smed) == last_data_yr], 3)
prev_bio_upper_last_assess <-
  f(last_yr_base_model$mcmccalcs$supper[names(mc$supper) == last_data_yr], 3)

# Forecasting -----------------------------------------------------------------
# ... first forecast year depletion and spawning biomass estimates ------------
fore_tac_mcmc_yr1 <- base_model$forecasts[[1]][[ct_tac_ind]]$mcmccalcs
# ... second forecast year depletion and spawning biomass estimates -----------
fore_tac_mcmc_yr2 <- base_model$forecasts[[2]][[ct_tac_ind]]$mcmccalcs
# Biomass medians for last year's TAC catch level -----------------------------
endyr_plus_3_fore <- base_model$forecasts[[as.character(end_yr + 3)]]
endyr_plus_3_fore_tac_catch <- endyr_plus_3_fore[[ct_tac_ind]]$biomass |>
  as_tibble(rownames = "year")
last_yr_tac_fore_1_biomass <- endyr_plus_3_fore_tac_catch |>
  filter(year == end_yr) |>
  mutate(`50%` = `50%` * 100) |>
  pull(`50%`)

last_yr_tac_fore_2_biomass <- endyr_plus_3_fore_tac_catch |>
  filter(year == end_yr + 1) |>
  mutate(`50%` = `50%` * 100) |>
  pull(`50%`)

last_yr_tac_fore_3_biomass <- endyr_plus_3_fore_tac_catch |>
  filter(year == end_yr + 2) |>
  mutate(`50%` = `50%` * 100) |>
  pull(`50%`)

curr_catch_tac_value <- ct_levels[[ct_tac_ind]][[1]][1]
catch_col <- sym(paste0("ForeCatch_", end_yr))
yr_prob_col <- paste0("SSB_", end_yr + 1, "<SSB_", end_yr)
last_yr_tac_risk_1_biomass_decline <-
  base_model$risks[[as.character(end_yr)]] |>
  as_tibble() |>
  filter(!!catch_col == curr_catch_tac_value) |>
  pull(yr_prob_col) |>
  f()

catch_col <- sym(paste0("ForeCatch_", end_yr + 1))
yr_prob_col <- paste0("SSB_", end_yr + 2, "<SSB_", end_yr + 1)
last_yr_tac_risk_2_biomass_decline <-
  base_model$risks[[as.character(end_yr + 1)]] |>
  as_tibble() |>
  filter(!!catch_col == curr_catch_tac_value) |>
  pull(yr_prob_col) |>
  f()

yr_prob_col <- paste0("Bratio_", end_yr + 2, "<0.40")
last_yr_tac_risk_2_bforty <-
  base_model$risks[[as.character(end_yr + 1)]] |>
  as_tibble() |>
  filter(!!catch_col == curr_catch_tac_value) |>
  pull(yr_prob_col) |>
  f()

catch_col <- sym(paste0("ForeCatch_", end_yr + 2))
yr_prob_col <- paste0("SSB_", end_yr + 3, "<SSB_", end_yr + 2)
last_yr_tac_risk_3_biomass_decline <-
  base_model$risks[[as.character(end_yr + 2)]] |>
  as_tibble() |>
  filter(!!catch_col == curr_catch_tac_value) |>
  pull(yr_prob_col) |>
  f()

# Numbers at age calculations for bubble plot caption -------------------------
median_nat_no_yr <- extramc$natage_median |>
  select(-Yr)
# Billions of fish
max_median_nat <- f(max(median_nat_no_yr) / 1e3, 1)
yr_of_max_median_nat_ind <- which(median_nat_no_yr == max(median_nat_no_yr))
yr_of_max_median_nat <- extramc$natage_median[yr_of_max_median_nat_ind, "Yr"]

# Executive Summary and Assessment section ------------------------------------
num_mcmc_samples <- dim(base_model$mcmc)[1]
median_bio_min <- f(min(mc$smed[names(mc$smed) %in% start_yr:end_yr]), 3)
median_bio_min_yr <- names(which.min(mc$smed[names(mc$smed) %in% start_yr:end_yr]))
median_intensity <- mc$pmed
median_intensity_2007_to_2010 <- median_intensity[c("2007", "2008", "2009", "2010")]
median_intensity_2007_to_2010_min <- f(min(median_intensity_2007_to_2010) * 100, 0)
median_intensity_2007_to_2010_max <- f(max(median_intensity_2007_to_2010) * 100, 0)
median_intensity_2007_to_2011 <- median_intensity[c("2007", "2008", "2009", "2010", "2011")]
median_intensity_2007_to_2011_min <- f(min(median_intensity_2007_to_2011) * 100, 0)
median_intensity_2007_to_2011_max <- f(max(median_intensity_2007_to_2011) * 100, 0)
# Includes > end_yr
median_intensity_above_one_all_yrs <- names(which(mc$pmed > 1))
median_intensity_above_one_yrs <- median_intensity_above_one_all_yrs[
         median_intensity_above_one_all_yrs < end_yr]
median_intensity_above_1_text <- paste(
  ifelse(
    test = !length(median_intensity_above_one_all_yrs),
    "for all years",
    "except for the years "
  ),
  str_flatten(
    median_intensity_above_one_all_yrs,
    collapse = ", ",
    last = ", and "
  ),
  sep = ""
)
median_intensity_2010 <- f(mc$pmed["2010"] * 100, 1)
median_intensity_2015 <- f(mc$pmed["2015"] * 100, 1)
median_intensity_2017 <- f(mc$pmed["2017"] * 100, 1)
median_intensity_2018 <- f(mc$pmed["2018"] * 100, 1)
median_intensity_2019 <- f(mc$pmed["2019"] * 100, 1)
median_intensity_2020 <- f(mc$pmed["2020"] * 100, 1)
median_intensity_2021 <- f(mc$pmed["2021"] * 100, 1)
median_intensity_2022 <- f(mc$pmed["2022"] * 100, 1)
median_intensity_penult_yr <- f(mc$pmed[as.character(end_yr - 1)] * 100, 1)
median_relative_bio <- mc$dmed
# Remove extra non-year columns to avoid warnings below
median_relative_bio <-
  median_relative_bio[grepl("^[0-9]+$",
                            names(median_relative_bio))]
median_relative_bio <-
  median_relative_bio[names(median_relative_bio) %in% start_yr:end_yr]
median_relative_bio_2007_to_2010 <-
  median_relative_bio[c("2007", "2008", "2009", "2010")]
median_relative_bio_2007_to_2010_min <-
  f(min(median_relative_bio_2007_to_2010), 2)
median_relative_bio_2007_to_2010_max <-
  f(max(median_relative_bio_2007_to_2010), 2)
median_relative_bio_2007_to_2011 <-
  median_relative_bio[c("2007", "2008", "2009", "2010", "2011")]
median_relative_bio_2007_to_2011_min <-
  f(min(median_relative_bio_2007_to_2011), 2)
median_relative_bio_2007_to_2011_max <-
  f(max(median_relative_bio_2007_to_2011), 2)
# When below target, 0.4
median_relative_bio_below_target <-
  median_relative_bio[median_relative_bio < 0.4]
# Has been above target since
median_relative_bio_above_target_since <-
  max(as.numeric(names(median_relative_bio_below_target)), na.rm = TRUE) + 1
median_relative_bio_2017 <- f(mc$dmed["2017"] * 100, 1)

# Recruitments in current assessment vs last assessment -----------------------
prev_assess_recruitment_lower  <- last_yr_base_model$mcmccalcs$rlower
prev_assess_recruitment_med  <- last_yr_base_model$mcmccalcs$rmed
# Want years onlt
prev_assess_recruitment_med <- 
  prev_assess_recruitment_med[grepl("^[0-9]{4}$", names(prev_assess_recruitment_med))]
prev_assess_recruitment_upper <- last_yr_base_model$mcmccalcs$rupper

# Current assessment w/o final projection year --------------------------------
# since not in previous assessment)
compareable_names <- names(mc$rlower) %in%
  names(prev_assess_recruitment_lower)
recruitment_med_to_compare <- mc$rmed[compareable_names]

# Biomass probabilities -------------------------------------------------------
# ... biomass declines next year to year after with zero catch ----------------
zero_catch_prob_bio_down_1 <- f(base_model$risks[[1]][1, 2])
# ... biomass declines year after next to year after that with 0 catch --------
zero_catch_prob_bio_down_2 <- f(base_model$risks[[2]][1, 2])
# ... biomass declines 2 years after next to year after that with 0 catch -----
zero_catch_prob_bio_down_3 <- f(base_model$risks[[3]][1,2])
# ... current biomass being above/below B40%, B25%, and B10% ------------------
probs_curr_b40 <-
  f(mean(base_model$mcmc[[paste0("Bratio_",
                                 assess_yr)]] > 0.40) * 100,
    1)
probs_curr_b25 <-
  f(mean(base_model$mcmc[[paste0("Bratio_",
                                 assess_yr)]] > 0.25) * 100,
    1)
probs_curr_b10 <-
  f(mean(base_model$mcmc[[paste0("Bratio_",
                                 assess_yr)]] > 0.10) * 100,
    0)
probs_curr_below_b40 <-
  f(mean(base_model$mcmc[[paste0("Bratio_",
                                 assess_yr)]] < 0.40) * 100,
    1)
probs_curr_below_b25 <-
  f(mean(base_model$mcmc[[paste0("Bratio_",
                                 assess_yr)]] < 0.25) * 100,
    1)

# Reference point probabilities -----------------------------------------------
# ... reference points next year given largest catch this year ----------------
largest_next_catch_index <-
  which.max(base_model$risks[[1]][, paste0("ForeCatch_", assess_yr)])
largest_next_catch <-
  f(base_model$risks[[1]][largest_next_catch_index, paste0("ForeCatch_",
                                                           assess_yr)],
    0)
prob_next_over_b10 <-
  f(100 - as.numeric(base_model$risks[[1]][largest_next_catch_index,
                                           paste0("Bratio_",
                                                  assess_yr + 1,
                                                  "<0.10")]),
    0)
prob_next_over_b40 <-
  f(100 - as.numeric(base_model$risks[[1]][largest_next_catch_index,
                                           paste0("Bratio_",
                                                  assess_yr + 1, "<0.40")]),
    0)
# ... Canadian (DFO) provisional reference points -----------------------------
dfo_probs_curr <-
  base_model$risks[[1]][ ,(ncol(base_model$risks[[1]])-2):ncol(base_model$risks[[1]])]
dfo_probs_fore <- base_model$risks[[2]][,(ncol(base_model$risks[[2]])-2):ncol(base_model$risks[[2]])]
# ... next year DFO probs given largest catch this year -----------------------
dfo_prob_next_over_40bmsy <-
  f(dfo_probs_fore[largest_next_catch_index, paste0("SSB_",
                                                    assess_yr + 1,
                                                    ">0.4SSB_MSY")])
dfo_prob_next_over_80bmsy <-
  f(dfo_probs_fore[largest_next_catch_index, paste0("SSB_",
                                                    assess_yr + 1,
                                                    ">0.8SSB_MSY")])
dfo_prob_next_over_bmsy <-
  f(dfo_probs_fore[largest_next_catch_index, paste0("SSB_",
                                                    assess_yr + 1,
                                                    ">SSB_MSY")])
# ... US (PFMC) stock size reference points based on default Treaty HCR -------
next_treaty_catch <-
  f(base_model$catch.levels[[ct_default_policy_ind]][[1]][1], 0)
pfmc_prob_next_yr_below_b40 <-
  f(base_model$risks[[1]][ct_default_policy_ind, paste0("Bratio_",
                                                        assess_yr + 1,
                                                        "<0.40")], 0)
pfmc_prob_next_yr_below_b25 <-
  f(base_model$risks[[1]][ct_default_policy_ind, paste0("Bratio_",
                                                        assess_yr + 1,
                                                        "<0.25")], 0)
same_catch_as_last_yr <-
  f(base_model$catch.levels[[ct_actual_ind]][[1]][1], 0)
same_catch_prob_next_year_below_b40 <-
  f(base_model$risks[[1]][ct_actual_ind, paste0("Bratio_",
                                                assess_yr + 1,
                                                "<0.40")], 0)
same_catch_prob_yr_after_next_below_b40 <-
  f(base_model$risks[[2]][ct_actual_ind, paste0("Bratio_",
                                                assess_yr + 2,
                                                "<0.40")], 0)
# ... Prob most recent relative fishing intensity is above target of 1 --------
probs_curr_rel_fish_intens_above_1 <-
  f(sum(base_model$mcmc[[paste0("SPRratio_", end_yr - 1)]] > 1) /
    nrow(base_model$mcmc) * 100,
    1)
catches_below_200000_since_1986 <-
  number_to_word(length(filter(ct, `Total` <= 200000,
                               Year > 1986)$Year))

# Age compositions ------------------------------------------------------------
# Canadian year range for ages
can_age_yrs <- can_ages_lst |> map(~{rownames(.x)}) |> unlist() |> unique() |> sort()
can_age_yrs_min <- min(can_age_yrs)
can_age_yrs_max <- max(can_age_yrs)
# ... age composition data for data section -----------------------------------
survey.age.years <-
  base_model$dat$agecomp[base_model$dat$agecomp$FltSvy == 2, ]$Yr
max_fishery_age_prop <- get_age_comp_limits(base_model, type = 1)
max_survey_age_prop <- get_age_comp_limits(base_model, type = 2)
# ... Canadian Freezer trawlers age data --------------------------------------
last_year_can_ages_ft <-
  can_ages_lst[[2]][rownames(can_ages_lst[[2]]) == last_data_yr, ]
ft_age_prop_holder <- get.age.prop(last_year_can_ages_ft, 1)
max_freezer_trawler_age_prop_age <- ft_age_prop_holder[1]
max_freezer_trawler_age_prop <- f(ft_age_prop_holder[2] * 100, 1)
ft_age_prop_holder <- get.age.prop(last_year_can_ages_ft, 2)
second_freezer_trawler_age_prop_age <- ft_age_prop_holder[1]
second_freezer_trawler_age_prop <- f(ft_age_prop_holder[2] * 100, 1)
ft_age_prop_holder <- get.age.prop(last_year_can_ages_ft, 3)
third_freezer_trawler_age_prop_age <- ft_age_prop_holder[1]
third_freezer_trawler_age_prop <- f(ft_age_prop_holder[2] * 100, 1)
ft_age_prop_holder <- get.age.prop(last_year_can_ages_ft, 4)
fourth_freezer_trawler_age_prop_age <- ft_age_prop_holder[1]
fourth_freezer_trawler_age_prop <- f(ft_age_prop_holder[2] * 100, 1)
# ... Canadian Shoreside age data ---------------------------------------------
last_yr_can_ages_ss <-
  can_ages_lst[[1]][rownames(can_ages_lst[[1]]) == last_data_yr, ]
ss_age_prop_holder <- get.age.prop(last_yr_can_ages_ss, 1)
max_shoreside_age_prop_age <- ss_age_prop_holder[1]
max_shoreside_age_prop <- f(ss_age_prop_holder[2] * 100, 1)
ss_age_prop_holder <- get.age.prop(last_yr_can_ages_ss, 2)
second_shoreside_age_prop_age <- ss_age_prop_holder[1]
second_shoreside_age_prop <- f(ss_age_prop_holder[2] * 100, 1)
ss_age_prop_holder <- get.age.prop(last_yr_can_ages_ss, 3)
third_shoreside_age_prop_age <- ss_age_prop_holder[1]
third_shoreside_age_prop <- f(ss_age_prop_holder[2] * 100, 1)
ss_age_prop_holder <- get.age.prop(last_yr_can_ages_ss, 4)
fourth_shoreside_age_prop_age <- ss_age_prop_holder[1]
fourth_shoreside_age_prop <- f(ss_age_prop_holder[2] * 100, 1)
# ... US age data -------------------------------------------------------------
us_age_n_cp <- us_cp_age_df[us_cp_age_df$year == last_data_yr, "n.hauls"] |> 
  pull()
us_age_n_ms <- us_ms_age_df[us_ms_age_df$year == last_data_yr, "n.hauls"] |> 
  pull()
us_last_yr_age_cp <- us_cp_age_df[us_cp_age_df$year == last_data_yr,
                                 grep("^a",
                                      colnames(us_cp_age_df))]
us_last_yr_age_cp <-
  us_last_yr_age_cp[order(unlist(us_last_yr_age_cp[1, , drop = TRUE]),
                            decreasing = TRUE)] |> 
  unlist()
us_age_1_prop_age_cp <- as.numeric(gsub("^a", "", names(us_last_yr_age_cp)[1]))
us_age_1_prop_cp <- f(us_last_yr_age_cp[1] * 100, 1)
us_age_2_prop_age_cp <- as.numeric(gsub("^a", "", names(us_last_yr_age_cp)[2]))
us_age_2_prop_cp <- f(us_last_yr_age_cp[2] * 100, 1)
us_age_3_prop_age_cp <- as.numeric(gsub("^a", "", names(us_last_yr_age_cp)[3]))
us_age_3_prop_cp <- f(us_last_yr_age_cp[3] * 100, 1)
us_age_4_prop_age_cp <- as.numeric(gsub("^a", "", names(us_last_yr_age_cp)[4]))
us_age_4_prop_cp <- f(us_last_yr_age_cp[4] * 100, 1)
us_last_yr_age_ms <- us_ms_age_df[us_ms_age_df$year == last_data_yr,
                                    grep("^a",
                                         colnames(us_ms_age_df))]
us_last_yr_age_ms <-
  us_last_yr_age_ms[order(unlist(us_last_yr_age_ms[1, , drop = TRUE]),
                            decreasing = TRUE)] |> 
  unlist()
us_age_1_prop_age_ms <- as.numeric(gsub("^a", "", names(us_last_yr_age_ms)[1]))
us_age_1_prop_ms <- f(us_last_yr_age_ms[1] * 100, 1)
us_age_2_prop_age_ms <- as.numeric(gsub("^a", "", names(us_last_yr_age_ms)[2]))
us_age_2_prop_ms <- f(us_last_yr_age_ms[2] * 100, 1)
us_age_3_prop_age_ms <- as.numeric(gsub("^a", "", names(us_last_yr_age_ms)[3]))
us_age_3_prop_ms <- f(us_last_yr_age_ms[3] * 100, 1)
us_age_4_prop_age_ms <- as.numeric(gsub("^a", "", names(us_last_yr_age_ms)[4]))
us_age_4_prop_ms <- f(us_last_yr_age_ms[4] * 100, 1)
us_last_yr_age_shore <- us_ss_age_df[us_ss_age_df$year == last_data_yr,
                                       grep("^a",
                                            colnames(us_ss_age_df))]

us_last_yr_age_shore <-
  us_last_yr_age_shore[order(unlist(us_last_yr_age_shore[1, , drop = TRUE]),
                             decreasing = TRUE)] |> 
  unlist()
us_age_1_prop_age_shore <-
  as.numeric(gsub("^a", "", names(us_last_yr_age_shore)[1]))
us_age_1_prop_shore <-
  f(us_last_yr_age_shore[1] * 100, 1)
us_age_2_prop_age_shore <-
  as.numeric(gsub("^a", "", names(us_last_yr_age_shore)[2]))
us_age_2_prop_shore <-
  f(us_last_yr_age_shore[2] * 100, 1)
us_age_3_prop_age_shore <-
  as.numeric(gsub("^a", "", names(us_last_yr_age_shore)[3]))
us_age_3_prop_shore <-
  f(us_last_yr_age_shore[3] * 100, 1)
us_age_4_prop_age_shore <-
  as.numeric(gsub("^a", "", names(us_last_yr_age_shore)[4]))
us_age_4_prop_shore <-
  f(us_last_yr_age_shore[4] * 100, 1)

# Recruitment -----------------------------------------------------------------
#  ... years median recruitment is below the mean of the median ---------------
# recruitments for years > 2010 and < (end_yr - 1) ; end_yr - 1 won't be well
# estimated
recruitment_med_since_2010 <-
  mc$rmed[which(names(mc$rmed) %in% 2010:end_yr &
                  names(mc$rmed) %in% start_yr:(end_yr - 1))]
yrs_since_2010_recruitment_med_below_mean <- names(recruitment_med_since_2010[recruitment_med_since_2010  < mean(mc$rmed)])
# ... est, recruitment in 2014 and 2016 in billions ---------------------------
recruitment_med_in_2014 <- f(mc$rmed["2014"], 3)
last_assess_recruitment_med_in_2014 <-
  f(last_yr_base_model$mcmccalcs$rmed["2014"], 3)
prob_percent_2014_rec_gt_2010_rec <-
  f(mean(base_model$mcmc$Recr_2014 > base_model$mcmc$Recr_2010) * 100, 0)
prob_percent_2016_rec_gt_2010_rec <-
  f(mean(base_model$mcmc$Recr_2016 > base_model$mcmc$Recr_2010) * 100, 1)
prob_percent_2020_rec_gt_2010_rec <-
  f(mean(base_model$mcmc$Recr_2020 > base_model$mcmc$Recr_2010) * 100, 0)
prob_percent_2014_rec_gt_2016_rec <-
  f(mean(base_model$mcmc$Recr_2014 > base_model$mcmc$Recr_2016) * 100, 0)
recruitment_lower_in_2016 <- f(mc$rlower["2016"], 3)
recruitment_med_in_2016 <- f(mc$rmed["2016"], 3)
recruitment_upper_in_2016 <- f(mc$rupper["2016"], 3)
prob_percent_2016_rec_gt_2010_rec <-
  f(mean(base_model$mcmc$Recr_2016 > base_model$mcmc$Recr_2010) * 100, 1)
sd_med_recr_dev_estimates <-
  f(sd(mc$devmed[names(mc$devmed) >= 1970 &
                   names(mc$devmed) <= (last_data_yr - 2)]), 2)
prob_percent_2010_rec_gt_1980_rec <-
  f(mean(base_model$mcmc$Recr_2010 >
           base_model$mcmc$Recr_1980) * 100, 0)
prob_percent_2010_rec_gt_1980_rec_last_yr_assess <-
  f(mean(last_yr_base_model$mcmc$Recr_2010 >
           last_yr_base_model$mcmc$Recr_1980) * 100, 0)

# Exploitation ----------------------------------------------------------------
exploitation_med_2010 <- f(mc$fmed["2010"],2)
exploitation_med_2012 <- f(mc$fmed["2012"],2)
exploitation_med_2011 <- f(mc$fmed["2011"],2)
exploitation_med_2015 <- f(mc$fmed["2015"],2)
exploitation_med_2017 <- f(mc$fmed["2017"],2)
exploitation_med_2018 <- f(mc$fmed["2018"],2)
exploitation_med_2019 <- f(mc$fmed["2019"],2)
exploitation_med_2020 <- f(mc$fmed["2020"],2)
exploitation_med_penult_yr <- f(mc$fmed[as.character(last_data_yr)], 2)

# Priors settings from the control file ---------------------------------------
param_details <- table_param_est_bounds(base_model,
                                        start.rec.dev.yr = recruit_dev_start_yr,
                                        end.rec.dev.yr = end_yr - 1,
                                        return.xtable = FALSE)
m_prior <- split_prior_info(param_details[rownames(param_details) == "m.vals", ][4],
                            dec_points = 2,
                            first_to_lower = TRUE)
# ... Dirichlet Multinomial priors --------------------------------------------
effn_priors <- base_model$parameters |>
  as_tibble() |>
  select(Label, Prior, Pr_SD) |>
  filter(grepl("DM_theta", Label))
effn_prior <- unlist(effn_priors[1, ])
sel_phi_val <- base_model$parameters |>
  as_tibble() |>
  filter(Label == "AgeSel_P3_Fishery(1)_dev_se") |>
  pull(Value)

# Cohort specifics ------------------------------------------------------------
# ... Cohort catch ------------------------------------------------------------
cohort_catch_1999 <- sum(cohort_catch(base_model, 1999))
cohort_catch_2010 <- sum(cohort_catch(base_model, 2010))
cohort_catch_2014 <- sum(cohort_catch(base_model, 2014))
cohort_catch_2016 <- sum(cohort_catch(base_model, 2016))
cohort_catch_2017 <- sum(cohort_catch(base_model, 2017))
cohort_catch_2020 <- sum(cohort_catch(base_model, 2020))
# ... Cumulative sums of Cohorts for use in JMC presentation ------------------
cohort_cum_sum_1999 <- cumsum(cohort_catch(base_model, 1999))
cohort_cum_sum_2010 <- cumsum(cohort_catch(base_model, 2010))
cohort_cum_sum_2014 <- cumsum(cohort_catch(base_model, 2014))
cohort_cum_sum_2016 <- cumsum(cohort_catch(base_model, 2016))
cohort_cum_sum_2017 <- cumsum(cohort_catch(base_model, 2017))
cohort_cum_sum_2020 <- cumsum(cohort_catch(base_model, 2020))
ages_1999 <- as.numeric(names(cohort_cum_sum_1999)) - 1999
ages_2010 <- as.numeric(names(cohort_cum_sum_2010)) - 2010
ages_2014 <- as.numeric(names(cohort_cum_sum_2014)) - 2014
ages_2016 <- as.numeric(names(cohort_cum_sum_2016)) - 2016
ages_2017 <- as.numeric(names(cohort_cum_sum_2017)) - 2017
ages_2020 <- as.numeric(names(cohort_cum_sum_2020)) - 2020
# ... Cohort medians, credible intervals --------------------------------------
rec_2010 <- get_rec_ci(last_yr_base_model, base_model, 2010)
rec_2014 <- get_rec_ci(last_yr_base_model, base_model, 2014)
rec_2016 <- get_rec_ci(last_yr_base_model, base_model, 2016)
rec_2017 <- get_rec_ci(last_yr_base_model, base_model, 2017)
rec_2020 <- get_rec_ci(last_yr_base_model, base_model, 2020)

# Estimated prop at age (numbers) of the catch in first forecast year ---------
fore_catch_prop <-
  as.data.frame(t(as.numeric(f(apply(extramc$natsel.prop, 2, median) * 100))))
names(fore_catch_prop) <- paste0("Age", 0:20)

# Credible intervals for age5 -------------------------------------------------
# (pick the biggest cohort from fore_catch_prop; note natsel.prop columns
# start with age-0).
fore_catch_prop_age2_lower <- quantile(extramc$natsel.prop[, 3],
                                       cred_int[1]) * 100
fore_catch_prop_age2_upper <- quantile(extramc$natsel.prop[, 3],
                                       cred_int[3]) * 100
fore_catch_prop_age3_lower <- quantile(extramc$natsel.prop[, 4],
                                       cred_int[1]) * 100
fore_catch_prop_age3_upper <- quantile(extramc$natsel.prop[, 4],
                                       cred_int[3]) * 100
fore_catch_prop_age6_lower <- quantile(extramc$natsel.prop[, 7],
                                       cred_int[1]) * 100
fore_catch_prop_age6_upper <- quantile(extramc$natsel.prop[, 7],
                                       cred_int[3]) * 100
fore_catch_prop_age7_lower <- quantile(extramc$natsel.prop[, 8],
                                       cred_int[1]) * 100
fore_catch_prop_age7_upper <- quantile(extramc$natsel.prop[, 8],
                                       cred_int[3]) * 100

# Estimated prop at age (catch) of catch in first forecast year ---------------
fore_catch_prop_wt_age2_median <- median(extramc$natselwt.prop[, 3]) * 100
fore_catch_prop_wt_age3_median <- median(extramc$natselwt.prop[, 4]) * 100
fore_catch_prop_wt_age4_median <- median(extramc$natselwt.prop[, 5]) * 100
fore_catch_prop_wt_age5_median <- median(extramc$natselwt.prop[, 6]) * 100
fore_catch_prop_wt_age6_median <- median(extramc$natselwt.prop[, 7]) * 100
fore_catch_prop_wt_age7_median <- median(extramc$natselwt.prop[, 8]) * 100
fore_catch_prop_wt_age10_median <- median(extramc$natselwt.prop[, 11]) * 100
fore_catch_prop_wt_age11_median <- median(extramc$natselwt.prop[, 12]) * 100

# Sigma_r, standard deviation of recruitment variability ----------------------
sigma_r <- f(base_model$sigma_R_in, 2)
sigma_r_sens <- sens_models[[1]][grep("Sigma R", sens_models_names[[1]])] |>
  map_dbl("sigma_R_in") |>
  f(2)
# Alternative sigma_r based on posterior of recdevs ---------------------------
# sigmar_R_info should not be used
calc_SD_of_devs <- function(posteriors, pattern = "Main") {
  posteriors %>%
    dplyr::select(dplyr::matches(pattern)) %>%
    apply(MARGIN = 1, FUN = sd) %>%
    median() %>%
    f(2)
}
calc_sum_rec_devs <- function(posteriors, pattern = "Main") {
  temp <- posteriors %>%
    dplyr::select(dplyr::matches(pattern)) %>%
    apply(MARGIN = 1, FUN = sum)
  c(mean = mean(temp), median = median(temp), range = range(temp))
}
sigma_r_alt_allyr <- calc_SD_of_devs(base_model$mcmc, pattern = "^[EML].+_RecrDev")
sigma_r_this_year_main <- calc_SD_of_devs(base_model$mcmc)
sigma_r_last_year_main <- calc_SD_of_devs(last_yr_base_model$mcmc)
sigma_r_sens1 <- sens_models[[1]] |> 
  map("mcmc") |> 
  map_chr(calc_SD_of_devs) |> 
  `names<-`(sens_models_names[[1]])
sigma_r_hi_main <- sigma_r_sens1[
  grep("Sigma.+1.[5-9]", names(sigma_r_sens1), value = TRUE)
]
sigma_r_lo_main <- sigma_r_sens1[
  grep("Sigma.+1.[0-4]", names(sigma_r_sens1), value = TRUE)
]

# Range of "main" recdevs -----------------------------------------------------
recr_era_main_tmp <- base_model$recruit$era == "Main"
recr_era_early_tmp <- base_model$recruit$era == "Early"
main.recdev.start <- min(base_model$recruit$Yr[recr_era_main_tmp])
main.recdev.end <- max(base_model$recruit$Yr[recr_era_main_tmp])
main.recdev.early <- min(base_model$recruit$Yr[recr_era_early_tmp])

# Range of "main" bias adjustment period for recdevs -------------------------
biasadjust_tmp <- base_model$recruit$biasadjuster ==
  max(base_model$recruit$biasadjuster)
main.recdevbias.start <-
  min(base_model$recruit$Yr[biasadjust_tmp])
main.recdevbias.end <-
  max(base_model$recruit$Yr[biasadjust_tmp])

# Weight-at-age for the base model --------------------------------------------
wt_at_age <-
  base_model$wtatage[, !grepl("comment", colnames(base_model$wtatage))] |>
  filter(Yr %in% start_yr_age_comps:(end_yr - 1),
         Fleet == 2) |>
  select(-c(Seas, Sex, Bio_Pattern, BirthSeas, Fleet)) |>
  rename(year = Yr)

# Define number of 'recent' years for several tables --------------------------
num_recent_yrs <- 10

# Dirichlet-Multinomial data weighting parameters MLE -------------------------
log_theta_fishery <-
  round(base_model$parameters["ln(EffN_mult)_1", "Value"], 3)
log_theta_survey <-
  round(base_model$parameters["ln(EffN_mult)_2", "Value"], 3)
theta_fishery <-
  exp(base_model$parameters["ln(EffN_mult)_1", "Value"])
theta_survey <-
  exp(base_model$parameters["ln(EffN_mult)_2", "Value"])
# Approximate MLE weights
dm_weight_fishery <- round(theta_fishery / (1 + theta_fishery), 3)
dm_weight_survey <- round(theta_survey / (1 + theta_survey), 3)
# MCMC medians for the fishery and survey, and quantiles (and low and high)
col_effn <- grep("^.*\\(DM_theta\\)_Age_P1$", colnames(base_model$mcmc))
# Probably shouldn't really round these values before then using them in the
#  weight calculations. Should use f() for values to be in document not round.
#  No time to look into now (Andy).
log_theta_fishery_median <-
  round(median(base_model$mcmc[, col_effn]), 3)
log_theta_fishery_lower <-
  round(quantile(base_model$mcmc[, col_effn], probs = cred_int[1]), 3)
log_theta_fishery_upper <-
  round(quantile(base_model$mcmc[, col_effn], probs = cred_int[3]), 3)
dm_weight_fishery_median <-
  f(median(exp(base_model$mcmc[, col_effn]) /
             (1 + exp(base_model$mcmc[, col_effn]))), 3)
dm_weight_fishery_lower <-
  f(exp(log_theta_fishery_lower) /
      (1 + exp(log_theta_fishery_lower)), 3)
dm_weight_fishery_upper <-
  f(exp(log_theta_fishery_upper) /
      ( 1 + exp(log_theta_fishery_upper)), 3)
col_effn <- grep("^.*\\(DM_theta\\)_Age_P2$", colnames(base_model$mcmc))
log_theta_survey_median <-
  round(median(base_model$mcmc[, col_effn]), 3)
log_theta_survey_lower <-
  round(quantile(base_model$mcmc[, col_effn],
                 probs = cred_int[1]), 3)
log_theta_survey_upper <-
  round(quantile(base_model$mcmc[, col_effn],
                 probs = cred_int[3]), 3)
dm_weight_survey_median <-
  f(median(exp(base_model$mcmc[, col_effn]) /
             (1 + exp(base_model$mcmc[, col_effn]))), 3)
dm_weight_survey_lower <-
  f(exp(log_theta_survey_lower) /
      (1 + exp(log_theta_survey_lower)), 3)
dm_weight_survey_upper <-
  f(exp(log_theta_survey_upper) /
      (1 + exp(log_theta_survey_upper)), 3)

# MCMC parameter estimates for base model -------------------------------------
# Need to change indexing if sensitivity models order changes in model-setup.R
# ... natural mortality -------------------------------------------------------
nat_m <-
  quantile(base_model$mcmc$NatM_uniform_Fem_GP_1,
           probs = cred_int)
nat_m_02 <-
  quantile(sens_models[[1]][[6]]$mcmc$NatM_uniform_Fem_GP_1,
           probs = cred_int)
nat_m_03 <-
  quantile(sens_models[[1]][[7]]$mcmc$NatM_uniform_Fem_GP_1,
           probs = cred_int)
nat_m_hamel <-
  quantile(sens_models[[1]][[8]]$mcmc$NatM_uniform_Fem_GP_1,
           probs = cred_int)

# ... steepness ---------------------------------------------------------------
steep <-
  quantile(base_model$mcmc$SR_BH_steep,
           probs = cred_int)
steep_prior_05 <-
  quantile(sens_models[[1]][[2]]$mcmc$SR_BH_steep,
           probs = cred_int)

# ... bratio ------------------------------------------------------------------
bratio_curr <-
  quantile(base_model$mcmc[[paste0("Bratio_", assess_yr)]],
           probs = cred_int)
bratio_age1 <-
  quantile(sens_models[[2]][[2]]$mcmc[[paste0("Bratio_", assess_yr)]],
           probs = cred_int)
# ... depletion ---------------------------------------------------------------
depl_curr <- mc$dmed[names(mc$dmed) == assess_yr]
# depl_no_ageerr <- sens_models_5$mcmccalcs$dmed[names(mc$dmed) == assess_yr]
# ... joint probability -------------------------------------------------------
# (%age) of being being both above the target relative fishing intensity in \Sexpr{end_yr-1}
# and below the $\Bforty$ (40\% of $B_0$) reference point at the start of \Sexpr{end_yr}
joint_percent_prob_above_below <-
  f(sum(base_model$mcmc[[paste0("Bratio_", end_yr)]] < 0.4 &
          base_model$mcmc[[paste0("SPRratio_", end_yr - 1)]] > 1) /
      nrow(base_model$mcmc) * 100,
    1)

# Probabilities for historical performance analyses ---------------------------
historical_probs_df <-
  combine_historical_probs(model = base_model,
                           hist_probs = assess_history_probs_df,
                           end = assess_yr - 1) |>
  as_tibble()

prob_decline_from_2019_to_2020_historic <-
  historical_probs_df |>
  filter(Year == 2019) |>
  select("P_decline") |>
  as.numeric() |>
  f()

prob_decline_from_2019_to_2020_curr <-
  historical_probs_df |>
  filter(Year == 2019) |>
  select("P_decline_curr") |>
  as.numeric() |>
  f()

prob_decline_from_2012_to_2013_historic <-
  historical_probs_df |>
  filter(Year == 2012) |>
  select("P_decline") |>
  as.numeric() |>
  f()

 prob_decline_from_2012_to_2013_curr <-
   historical_probs_df |>
   filter(Year == 2012) |>
   select("P_decline_curr") |>
   as.numeric() |>
   f()

 # Retrospective setup for the document ----------------------------------------
 retro_model_nms <- c(base_model_name,
                        map_chr(plot_retro_yrs, ~{
                          paste0("-", .x, ifelse(.x == 1, " year", " years"))
                        }))
 retro_lst <- list(base_model)
 for(i in plot_retro_yrs){
   retro_lst[[i + 1]] <- base_model$retros[[i]]
 }
 retro_models_end_yr <- c(end_yr, end_yr - plot_retro_yrs)
 # Assemble the retrospective list with the base as the first element
 d_obj_retro_biomass <-
   create_group_df_biomass(retro_lst,
                           retro_model_nms,
                           end_yrs = retro_models_end_yr)
 d_obj_retro_rel_biomass <-
   create_group_df_biomass(retro_lst,
                           retro_model_nms,
                           rel = TRUE,
                           end_yrs = retro_models_end_yr)
 d_obj_retro_recr <-
   create_group_df_recr(retro_lst,
                        retro_model_nms,
                        end_yrs = retro_models_end_yr)

 # Set up bridge model groups for plotting ------------------------------------
 iter <- 0
 d_obj_bridge_biomass <- map2(bridge_models, bridge_models_names, ~{
   iter <- iter + 1
   create_group_df_biomass(.x, .y,
                           end_yrs = bridge_model_end_yr[[iter]])
 })
 iter <- 0
 d_obj_bridge_rel_biomass <- map2(bridge_models, bridge_models_names, ~{
   iter <- iter + 1
   create_group_df_biomass(.x, .y,
                           rel = TRUE,
                           end_yrs = bridge_model_end_yr[[iter]])
 })
 iter <- 0
 d_obj_bridge_recdev <- map2(bridge_models, bridge_models_names, ~{
   iter <- iter + 1
   create_group_df_recr(.x, .y,
                        devs = TRUE,
                        end_yrs = bridge_model_end_yr[[iter]])
 })
 iter <- 0
 d_obj_bridge_age1_index <- map2(bridge_models, bridge_models_names, ~{
   iter <- iter + 1
   create_group_df_index(.x, .y,
                         survey_type = "age1")
 })
 iter <- 0
 d_obj_bridge_age2_index <- map2(bridge_models, bridge_models_names, ~{
   iter <- iter + 1
   create_group_df_index(.x, .y,
                         survey_type = "age2")
 })

 # Set up sensitivity model groups for plotting -------------------------------
 # Biomass  -------------------------------------------------------------------
 d_obj_sens_biomass <- map2(sens_models, sens_models_names, ~{
   create_group_df_biomass(.x, .y)
 })
 d_obj_sens_rel_biomass <- map2(sens_models, sens_models_names, ~{
   create_group_df_biomass(.x, .y, rel = TRUE)
 })
 d_obj_sens_recr <- map2(sens_models, sens_models_names, ~{
   create_group_df_recr(.x, .y)
 })
 d_obj_sens_recdev <- map2(sens_models, sens_models_names, ~{
   create_group_df_recr(.x, .y, devs = TRUE)
 })
 # extra mcmc required for these
 d_obj_sens_age1_index_grp2 <- map2(sens_models[2], sens_models_names[2], ~{
   create_group_df_index(.x, .y, "age1")
 })
 d_obj_sens_age1_index_grp3 <- map2(sens_models[3], sens_models_names[3], ~{
   create_group_df_index(.x, .y, "age1")
 })
 d_obj_sens_age1_index_grp4 <- map2(sens_models[4], sens_models_names[4], ~{
   create_group_df_index(.x, .y, "age1")
 })
 d_obj_sens_age2_index_grp2 <- map2(sens_models[2], sens_models_names[2], ~{
   create_group_df_index(.x, .y, "age2")
 })
 d_obj_sens_age2_index_grp3 <- map2(sens_models[3], sens_models_names[3], ~{
   create_group_df_index(.x, .y, "age2")
 })
 d_obj_sens_age2_index_grp4 <- map2(sens_models[4], sens_models_names[4], ~{
   create_group_df_index(.x, .y, "age2")
 })

 # Values used in management presentation
last_yr_catch_fore <- base_model$catch.levels[[ct_actual_ind]][[1]][1]
ct_col <- paste0("ForeCatch_", forecast_yrs[1])
ct_col_sym <- sym(ct_col)
decl_col <- paste0("SSB_", forecast_yrs[2], "<SSB_", forecast_yrs[1])
decl_col_sym <- sym(decl_col)
below40_col <- paste0("Bratio_", forecast_yrs[2], "<0.40")
below40_col_sym <- sym(below40_col)
prob_decl_yr1_zero_catch <- base_model$risks[[1]] |>
  as_tibble() |>
  filter(!!ct_col_sym < 1) |>
  pull(!!decl_col_sym) |>
  f()
prob_decl_yr1_other_catch <- base_model$risks[[1]] |>
  as_tibble() |>
  slice(2) |>
  pull(!!decl_col_sym) |>
  f()
prob_below_b40_yr1_last_yr_catch <- base_model$risks[[1]] |>
  as_tibble() |>
  filter(!!ct_col_sym == last_yr_catch_fore) |>
  pull(!!below40_col) |>
  f()

ct_col <- paste0("ForeCatch_", forecast_yrs[2])
ct_col_sym <- sym(ct_col)
decl_col <- paste0("SSB_", forecast_yrs[3], "<SSB_", forecast_yrs[2])
decl_col_sym <- sym(decl_col)
below40_col <- paste0("Bratio_", forecast_yrs[3], "<0.40")
below40_col_sym <- sym(below40_col)
prob_decl_yr2_zero_catch <- base_model$risks[[2]] |>
  as_tibble() |>
  filter(!!ct_col_sym < 1) |>
  pull(!!decl_col_sym) |>
  f()
prob_decl_yr2_other_catch <- base_model$risks[[2]] |>
  as_tibble() |>
  slice(2) |>
  pull(!!decl_col_sym) |>
  f()
prob_below_b40_yr2_last_yr_catch <- base_model$risks[[2]] |>
  as_tibble() |>
  filter(!!ct_col_sym == last_yr_catch_fore) |>
  pull(!!below40_col) |>
  f()
```

<!--chapter:end:005-load-knitr-variables.rmd-->

\newpage

\rfoot{One-page summary}

# One-page summary {-}

- The stock assessment model for `r assess_yr` has the same
population dynamics structure as the `r last_assess_yr` model.
The model is fit to an acoustic survey index of biomass, an
index of age-1 fish, annual commercial catch data, mean weight-at-age data,
and age-composition data from the survey and commercial fisheries.

- Updates to the data include:
<!-- the new biomass estimate and age-composition data from the acoustic survey conducted in `r survey_end_yr`, -->
fishery catch and age-composition data from `r end_yr-1`, weight-at-age data for
`r end_yr-1`,
<!-- the `r survey_end_yr` age-1 index estimate, -->
and minor changes to pre-`r end_yr-1` data.

- Coast-wide catch in `r end_yr-1` was `r last_yr_landings`~t
[t represents metric tons], 6% below the average over the most recent 10 years
(`r ct |> tail(10) |> pull(Total) |> mean() |> f()`~t),
out of a total allowable catch (TAC), adjusted for carryovers, of `r last_yr_tac` t.
The U.S. caught `r last_yr_us_landings`~t (`r last_yr_us_attained`% of their quota) and Canada caught `r last_yr_can_landings`~t
(`r last_yr_can_attained`% of their quota).

- The median estimate of the `r end_yr` relative spawning biomass
(female spawning biomass at the start of `r end_yr` divided by that at
unfished equilibrium, B~0~) is `r curr_depl_median`% but is highly
uncertain (with 95% credible interval from `r curr_depl_lower`% to
`r curr_depl_upper`%). The median relative spawning biomass
has increased since 2021, due to the estimated above average
2020 cohort entering maturity. The large,
but uncertain, size of the 2020 cohort is based on the 2021 age-1 index
estimate and the `r last_assess_yr` fishery age-composition data.

- The median estimate of female spawning biomass at the start
of `r end_yr` is `r curr_bio_median_tonnes`~t (with 95% credible
interval from `r curr_bio_lower_tonnes` to `r curr_bio_upper_tonnes`~t).
This is `r diff_bio_median_last_curr`% `r diff_bio_median_last_curr_text`
this assessment's median estimate for the `r end_yr-1` female spawning
biomass of `r prev_bio_median_tonnes`~t (with 95% credible interval
`r prev_bio_lower_tonnes`--`r prev_bio_upper_tonnes`~t).

- The estimated probability that female spawning biomass at the start of
`r assess_yr` is below the `r `$\Bforty$ (40% of $\Bzero$) reference point is
`r probs_curr_below_b40`%, and the probability that the relative fishing
intensity exceeded $\FSPRforty$ in `r end_yr-1` is
`r probs_curr_rel_fish_intens_above_1`%. The joint
probability of both these occurring is `r joint_percent_prob_above_below`%.

- Based on the default harvest rule, the estimated median catch limit for
`r min(forecast_yrs)` is `r ct_limit_quantiles["median"]`~t (with
95% credible interval from `r ct_limit_quantiles["lower"]` to
`r ct_limit_quantiles["upper"]`~t).

- Projections were conducted across a wide-range of catch levels due to
high uncertainty in estimates of recent and forecasted recruitment.
Projections setting the `r forecast_yrs[1]` and
`r forecast_yrs[2]` catches equal to the `r forecast_yrs[1] - 1`
coast-wide TAC of `r last_yr_tac` t show the estimated median relative
spawning biomass decreasing from `r f(last_yr_tac_fore_1_biomass)`% in
`r end_yr` to `r f(last_yr_tac_fore_2_biomass)`% in `r end_yr + 1` to
`r f(last_yr_tac_fore_3_biomass)`% in `r end_yr + 2`,
with a `r last_yr_tac_risk_2_bforty`% chance
of the female spawning biomass falling below $\Bforty$ in `r end_yr + 2`.
There is an estimated `r last_yr_tac_risk_1_biomass_decline`% chance of the
female spawning biomass declining from `r end_yr` to `r end_yr + 1`, an
`r last_yr_tac_risk_2_biomass_decline`% chance of it declining from
`r end_yr + 1` to `r end_yr + 2`, and an
`r last_yr_tac_risk_3_biomass_decline`% chance of it declining for these
constant catches.

<!--chapter:end:006-one-page-summary.rmd-->

\newpage

\rfoot{Executive summary}

# Executive summary {-}

## Stock {-}

This assessment reports the status of the coastal `r sp` (or `r common_name`,
*`r science_name`*) stock off the west coast of the United States and Canada
at the start of `r assess_yr`. This stock exhibits seasonal migratory
behavior, ranging from offshore and generally southern waters during the
winter spawning season to coastal areas between northern California and
northern British Columbia during the spring, summer, and fall when the
fishery is conducted. In years with warmer water the stock tends to move
farther to the north during the summer. Older `r simple_name` tend to migrate
farther north than younger fish in all years, with catches in the Canadian
zone typically consisting of fish greater than four years old. Separate, and
much smaller, populations of `r simple_name` occurring in the major inlets
of the Northeast Pacific Ocean, including the Strait of Georgia, Puget Sound,
and the Gulf of California, are not included in this analysis.

(ref:es-catches-cap) Total `r sp` catch used in the assessment by sector,
`r start_yr`--`r last_data_yr`. U.S. tribal catches are included in the
sectors where they are represented.

(ref:es-catches-alt) This figure shows that catches in four of the last six
years have been the largest in the time series.

```{r es-catches, fig.cap = "(ref:es-catches-cap)", fig.height = 4, fig.width = 8, is.fig = TRUE, alt.text = "(ref:es-catches-alt)"}
plot_catches(ct, leg.y.loc = 650)
```

## Catches {-}

Coast-wide fishery landings of `r sp` averaged `r f(mean(ct$Total))`~t
from `r min(ct$Year)` to `r max(ct$Year)`, with a low of
`r f(min(ct$Total))`~t in
`r ct$Year[ct$Total == min(ct$Total)]` and a peak of
`r f(max(ct$Total))`~t in
`r ct$Year[ct$Total == max(ct$Total)]`
(Figure \@ref(fig:es-catches)).
Prior to `r min(ct$Year)`, total removals were negligible compared to the
modern fishery. Over the early period (`r min(ct$Year)`--1990) most removals
were from foreign or joint-venture fisheries. Across the time series, annual
catch in U.S. waters averaged `r f(mean(ct[["U.S. Total"]]))`~t
(`r f(sum(ct[["U.S. Total"]]) / sum(ct$Total) * 100, 1)`% of the total catch),
while catch from Canadian waters averaged `r f(mean(ct[["Canada Total"]]))`~t.
Over the last 10 years, `r max(ct$Year) - 9`--`r max(ct$Year)`
(Table \@ref(tab:es-catches-tab)), the average coast-wide catch was
`r ct_mean_10yrs`~t with U.S. and Canadian catches averaging
`r ct_us_mean_10yrs`~t and `r ct_can_mean_10yrs`~t, respectively. Since 2017,
the coast-wide catch has been declining annually through `r end_yr - 1`,
when it was `r last_yr_landings`~t out of a total allowable catch (TAC,
adjusted for carryovers) of `r last_yr_tac`~t. Attainment in the U.S. was
`r last_yr_us_attained`% of its quota and in Canada it was
`r last_yr_can_attained`%.

```{r es-catches-tab, results = "asis", echo = FALSE}
table_catch(ct,
            start_yr = end_yr - 10,
            end_yr = end_yr - 1,
            caption = paste0(
              "Recent commercial fishery catch (t). Tribal catches are",
              "included in the sector totals. Research catch includes landed",
              "catch associated with certain research-related activities.",
              "Catch associated with surveys and discarded bycatch in",
              "fisheries not targeting hake is relatively small and not included in",
              "the table or model."))
```

In this document, the terms catch and landings are used interchangeably.
Estimates of discard within the target fishery are included, but discarding
of `r sp` in non-target fisheries is not. Discard from all fisheries, 
including those that do not target hake, is estimated to be less than 1% of
landings in recent years. During the last five years, catches were
considerably above the long-term average catch (`r f(long_term_avge_ct)`~t),
but have been in decline over that period (especially in Canada). Landings
between 2001 and 2008 were predominantly comprised of fish from the very large
1999 year class, with the cumulative removal (through `r end_yr - 1`) from
that cohort estimated at approximately
`r f(cohort_catch_1999 / 1e6, 2)` million~t. Through `r last_data_yr`, the
cumulative catch of the 2010, 2014, and 2016 year classes is estimated to be
about `r f(cohort_catch_2010 / 1e6, 2)` million~t,
`r f(cohort_catch_2014 / 1e6, 2)` million~t, and
`r f(cohort_catch_2016 / 1e6, 2)` million~t, respectively. In the
`r end_yr - 1` catch, `r top_coh(base_model, last_data_yr, 3, cap = FALSE)`.

## Data and assessment {-}

(ref:es-survey-biomass-cap) Acoustic survey biomass index of age-2+ fish
(millions of tons). Approximate 95% confidence intervals are based on
sampling variability (intervals without squid/hake apportionment
uncertainty in 2009 are displayed in black).
  
```{r es-survey-biomass, fig.cap = "(ref:es-survey-biomass-cap)", fig.height=5, fig.width=8, is.fig = TRUE, alt.text = "This figure shows that the survey estimate has decreased from 2019 to 2021."}
plot_survey_biomass(base_model, index = "age2")
```

(ref:es-survey-age1-cap) Relative index of age-1 fish (numbers of fish) and
approximate 95% confidence intervals based on sampling variability. The index
is relative because the survey does not attempt to sample all available age-1
fish and the analysis does not include kriging as is done to estimate age-2+
biomass.

```{r es-survey-age1, fig.cap = "(ref:es-survey-age1-cap)", fig.height = 5, fig.width = 8, is.fig = TRUE, alt.text = "This figure shows that the age-1 survey estimate has increased from 2019 to 2021."}
plot_survey_biomass(base_model, index = "age1", y_lim = c(0, 16))
```

This Joint Technical Committee (JTC) assessment depends on the fishery
landings (`r start_yr`--`r last_data_yr`), an acoustic survey biomass index
of age-2+ fish (Figure~\@ref(fig:es-survey-biomass) and age compositions
(`r survey_start_yr`--`r survey_end_yr`), a relative index of age-1 fish (Figure~\@ref(fig:es-survey-age1); `r survey_start_yr`--`r survey_end_yr`),
fishery age compositions (`r start_yr_age_comps`--`r last_data_yr`), and
mean weight-at-age data (`r start_yr_age_comps`--`r last_data_yr`). In 2011
the survey biomass index was the lowest in the time series and was followed
by the index increasing in 2012, 2013, and again in 2015 before decreasing to
near the time series average in 2017. The 2019 estimate is the fourth highest
of the series, and the 2021 estimate is near the time series average.
Age-composition data from the aggregated fisheries and the acoustic survey,
along with the age-1 index, provide data that facilitates estimating relative
cohort strength, i.e., strong and weak cohorts. The age-1 index suggests
particularly large numbers of age-1 fish in 2009, 2011, 2015, and 2021 (2008,
2010, 2014, and 2020 year classes, respectively), and is not available for
most even years (odd year classes). There is not data to inform the size of
the `r last_data_yr` year class.

The assessment uses a Bayesian estimation approach, sensitivity analyses, and
retrospective investigations to evaluate the potential consequences of
parameter uncertainty, alternative structural models, and historical
performance of the assessment model, respectively. The Bayesian approach
combines prior knowledge about natural mortality, stock-recruitment steepness
(a parameter for stock productivity), and several other parameters, with
likelihoods for the acoustic survey biomass index, acoustic survey
age-composition data, the relative age-1 index, and fishery age-composition
data. Integrating the joint posterior distribution over model parameters
provides probabilistic inferences about uncertain model parameters and
forecasts derived from those parameters; this is done via Markov chain Monte
Carlo sampling using the efficient No-U-Turn Sampler (NUTS) that was
successfully tested in 2020 and used in subsequent assessments. Sensitivity
analyses are used to identify alternative model assumptions that may also
be consistent with the data. All models, including bridging, sensitivity,
and retrospective models, use a Bayesian framework for estimation.
Retrospective analyses identify possible poor performance of the assessment
model with respect to future predictions. Past assessments have conducted
closed-loop simulations that provide insights into how alternative
combinations of survey frequency, assessment model selectivity assumptions,
changes in hake distribution, and harvest control rules affect expected
management outcomes given repeated application of these procedures over
the long-term. The results of past (and ongoing) closed-loop simulations
help inform decisions made for this assessment.

This `r assess_yr` assessment retained the same general population dynamics
structure as the base assessment model from `r last_assess_yr` and again is
configured using Stock Synthesis. This includes the continued use (since 2014)
of time-varying (rather than fixed) selectivity to maintain flexibility with
fishing dynamics given variability in `r sp` distribution patterns.

The Dirichlet-multinomial estimation approach to weighting composition data
was retained, and sensitivity to an alternative data-weighting approach was
investigated. Time-varying fecundity, which was introduced in 2019, was
retained. Assumptions for the forecast period for weight at age and
selectivity continue to be based on conditions during the last five years,
as done since the 2020 assessment. The main change from the `r last_assess_yr`
assessment is the addition of `r last_data_yr` data.

## Stock Biomass {-}

Results from the base model
indicate that since the 1960s, `r sp` female spawning biomass has ranged from
well below to above unfished equilibrium (Figures~\@ref(fig:es-biomass)
and~\@ref(fig:es-relative-biomass)). Model estimates suggest
that it was below the unfished equilibrium in the 1960s, at the start of the
assessment period, due to lower than average recruitment.

(ref:es-biomass-cap) Median (solid line) of the posterior
distribution for beginning of the year female spawning biomass
($B_t$ in year $t$; million t) through `r end_yr` (solid line) with 95%
posterior credibility intervals (shaded area). The left-most circle with a 95%
posterior credibility interval is the estimated unfished equilibrium biomass,
$B_0$.

```{r es-biomass, fig.cap = "(ref:es-biomass-cap)", fig.height = 5, fig.width = 8, is.fig = TRUE, alt.text = "This figure shows that the median spawning biomass has been increasing in size since 2021."}
plot_biomass(list(base_model),
             list(base_model_name),
             ylim = c(0, 5),
             point_shape = 1,
             leg_pos = "none")
```

(ref:es-relative-biomass-cap) Median (solid line) of the posterior
distribution for relative spawning biomass ($B_t / B_0$) through `r end_yr`
with 95% posterior credibility intervals (shaded area). Dashed horizontal
lines show 10%, 40%, and 100% of the unfished equilibrium ($B_0$).

```{r es-relative-biomass, fig.cap = "(ref:es-relative-biomass-cap)", fig.height = 5, fig.width = 8, is.fig = TRUE, alt.text = "This figure shows that the relative spawning biomass has been increasing since 2021. The value for 2023 is just above B0."}
plot_rel_biomass(list(base_model),
                 list(base_model_name),
                 point_shape = 1,
                 ylim = c(0, 3),
                 alpha = 0.2,
                 leg_pos = "none")
```

The stock is estimated to have increased rapidly and was above unfished
equilibrium in the mid-1970s and mid-1980s (after two large recruitment
events in the early 1980s). It then declined steadily to a low in 1999. This
was followed by a brief increase to a peak in 2002 as the very large 1999 year
class matured. The 1999 year class largely supported the fishery for several
years due to relatively small recruitment events between 2000 and 2007. With
the aging 1999 year class, median female spawning biomass declined throughout
the late 2000s, reaching a time-series low of `r median_bio_min` million~t in
`r median_bio_min_yr`. Median female spawning biomass is estimated to have
peaked again in 2013 and 2014 due to a very large 2010 year class and an
above-average 2008 year class. The subsequent decline from 2014 to 2016 is
primarily from the 2010 year class surpassing the age at which the gains in
weight from growth are greater than the losses in weight from mortality
(growth-mortality transition). The 2014 year class is estimated to be large,
though not as large as the 1999 and 2010 year classes, increasing the biomass
in 2017. The estimated biomass was relatively steady from 2017 to 2019 and then
declined in 2020 and 2021 due to the 2014 and 2016 year classes moving through
the growth-mortality transition during a period of high catches. The increase
in female spawning biomass since 2021 is due to the expected above average
2020 cohort entering maturity and the recent declining trend in catch.

The median estimate of the `r end_yr` relative spawning biomass (female
spawning biomass at the start of `r end_yr` divided by that at unfished
equilibrium, $B_0$) is `r curr_depl_median`%. However, the uncertainty
is particularly large this year, with a 95% posterior credibility interval
from `r curr_depl_lower`% to `r curr_depl_upper`%
(Table~\@ref(tab:es-biomass-tab), due to high uncertainty about the size of
the 2020 cohort, which has not yet been sampled in the acoustic survey
biomass index of age-2+ fish. The median estimate of the `r end_yr` female
spawning biomass is `r curr_bio_median` million~t (with a 95% posterior credibility interval from
`r curr_bio_lower` to `r curr_bio_upper` million~t. The current estimate of the
`r end_yr - 1` female spawning biomass is `r prev_bio_median`
(`r prev_bio_lower`--`r prev_bio_upper`) million~t. This is higher than the
`r prev_bio_median_last_assess` (`r prev_bio_lower_last_assess`--
`r prev_bio_upper_last_assess`) million~t estimated in the `r end_yr - 1`
assessment. The increase appears to be due to the addition of 2022 fishery
age-composition data, which suggests the 2020 cohort may be larger than the
age-1 index alone was indicating in the last assessment.

```{r es-biomass-tab, results = "asis", echo = FALSE}
table_biomass(base_model,
              start_yr = end_yr - 9,
              end_yr = end_yr,
              font_size = 12,
              caption = paste0(
                "Recent trends in estimated beginning of the year female ",
                "spawning biomass (SSB; thousand~t) and spawning biomass ",
                "relative to estimated unfished equilibrium (Rel. SSB; \\%)."))
```

## Recruitment {-}

```{r es-recruitment-tab, results = "asis", echo = FALSE}
table_recruitment(base_model,
                  start_yr = end_yr - 10,
                  end_yr = end_yr - 1,
                  font_size = 12,
                  caption = paste0(
                    "Estimates of recent recruitment (millions of age-0 ",
                    "fish) and recruitment deviations, where deviations ",
                    "below (above) zero indicate recruitment below ",
                    "(above) that estimated from the stock-recruit ",
                    "relationship."))
```

The addition of `r last_data_yr` data does not substantially change estimates
of historical recruitment but recent recruitment estimates have changed
substantially. For example, this assessment's median estimate of the 2020
recruitment is
`r f(((recruitment_med_to_compare - prev_assess_recruitment_med)["2020"]), 1)`~billion
fish higher than in the last assessment (a 
`r f(((((recruitment_med_to_compare - prev_assess_recruitment_med)["2020"]) /
(prev_assess_recruitment_med)["2020"]) * 100), 0)`% increase). Similarly,
estimates for 2019 and 2021 recruitments have changed by
`r f(((((recruitment_med_to_compare - prev_assess_recruitment_med)["2019"]) /
(prev_assess_recruitment_med)["2019"]) * 100), 0)`%
(`r f((recruitment_med_to_compare - prev_assess_recruitment_med)["2019"], 1)`~billion
fish) and
`r f(((((recruitment_med_to_compare - prev_assess_recruitment_med)["2021"]) /
(prev_assess_recruitment_med)["2021"]) * 100), 0)`%
(`r f(((recruitment_med_to_compare - prev_assess_recruitment_med)["2021"]), 1)`~billion
fish), respectively, but the general notion remains that recent recruitment is
highly uncertain.

`r sp` have low to moderate recruitment with occasional large year classes
(Table~\@ref(tab:es-recruitment-tab) and Figure~\@ref(fig:es-recruitment)).

(ref:es-recruitment-cap) Medians (solid circles) and means ($\mathrm{X}$) of the
posterior distribution for recruitment (billions of age-0 fish) with 95%
posterior credibility intervals (blue, vertical lines). The median of the
posterior distribution for mean unfished equilibrium recruitment ($R_0$) is
shown as the horizontal dashed line with the 95% posterior credibility
interval shaded between the dotted lines.

```{r es-recruitment, fig.cap = "(ref:es-recruitment-cap)", fig.height = 5, fig.width = 8, is.fig = TRUE, alt.text = "This figure shows that recruitment for each cohort. There are currently three above-average cohorts in the stock with 2020 being the fourth. The 2020 cohort is highly uncertain which can be seen in the size of the credible interval."}
plot_recruitment(list(base_model),
                 list(base_model_name),
                 single_line_color = "blue",
                 inc_means = TRUE,
                 leg_pos = "none")
```

Large year classes in 1980, 1984, and 1999 supported much of the commercial
catch from the 1980s to the mid-2000s. From 2000 to 2007, estimated
recruitment was at some of the lowest values in the time series but this
was followed by an above average 2008 year class. The strong 2010 year class
comprised `r top_coh(base_model, 2014, ret_cohort = 2010)`% of the
coast-wide commercial catch in 2014,
`r top_coh(base_model, 2016, ret_cohort = 2010)`% of the 2016 catch,
`r top_coh(base_model, 2018, ret_cohort = 2010)`% of the 2018 catch,
`r top_coh(base_model, 2020, ret_cohort = 2010)`% of the 2020 catch, and
`r top_coh(base_model, 2022, ret_cohort = 2010)`% of the 2022 catch.
The decline from 2014 to 2016 was partly due to the large influx of the 2014
year class (`r top_coh(base_model, 2016, ret_cohort = 2014)`% of the 2016
catch was age-2 fish from the 2014 year class; this was larger than the
proportion of age-2 fish, `r top_coh(base_model, 2012, ret_cohort = 2010)`%,
from the 2010 year class in 2012). Since 2010, the model currently
estimates small 2011, 2012, 2013, 2015, 2018, 2019 and 2021 year classes
(median recruitment well below the mean of all median recruitments).

The 2014 and 2016 year classes are both larger than average, with 2014
larger than 2016 but smaller than 2010. With the inclusion of the
relative age-1 index, there is information beyond just fishery encounters in
the data to estimate the size of the 2020 year class. Collectively, these
data indicate that the 2020 year class is likely well above average. The
much smaller 2019 year class is informed by the `r last_survey_yr`
biomass index and fishery data but is not informed by the relative age-1
index, and the 2021 year class is informed only by 2022 fishery data.
There is no information in the data to estimate the sizes of the
`r end_yr - 1` and `r end_yr` year classes. Retrospective analyses of
year-class strength for young fish have shown the estimates of recent
recruitment to be unreliable prior to at least a model age of three (i.e.,
fish observed at age two) without a survey in the most recent year and
two (i.e., fish observed at age one) with a survey. While the 2020 cohort
was observed by the relative age-1 index in 2021, it will not be observed
by the acoustic survey until 2023.

## Default harvest policy {-}

The default \Ffortyten harvest policy prescribes the maximum rate of fishing
mortality to equal $\FSPRforty$. This rate gives a spawning potential ratio (SPR)
of 40%, meaning that the female spawning biomass per recruit with $\FSPRforty$ is
40% of that without fishing. If female spawning biomass is below $\Bforty$
(40% of $B_0$), the policy reduces the TAC linearly until it equals zero at
$\Bten$ (10% of $B_0$). Relative fishing intensity for fishing rate
$\mathrm{F}$ is \FishingRate, where $\SPRforty$ is an SPR of 40%;
it is reported here interchangeably as a proportion or a percentage. A
relative fishing intensity above 1.0 means fishing at a rate above $\FSPRforty$.

## Exploitation status {-}

```{r es-fishing-intensity-tab, results = "asis", echo = FALSE}
table_fishing_intensity(base_model,
                        start_yr = end_yr - 10,
                        end_yr = end_yr - 1,
                        digits = 3,
                        font_size = 12,
                        caption = paste0(
                          "Recent estimates of relative fishing intensity, ",
                          "\\FishingRate, and exploitation ",
                          "fraction (catch divided by age-2+ biomass)."))
```

The median estimated relative fishing intensity on the stock is below the
management level of 1.0 `r median_intensity_above_1_text` (see 
Table~\@ref(tab:es-fishing-intensity-tab) for recent years and
Figure~\@ref(fig:es-fishing-intensity)).

(ref:es-fishing-intensity-cap) Trend in median relative fishing intensity
(relative to the $\FSPRforty$ management level) through `r end_yr - 1`} with
95% posterior credibility intervals. The $\FSPRforty$ management level defined
in the Joint U.S.-Canada Agreement for `r sp` is shown as a horizontal line
at 1.0.

```{r es-fishing-intensity, fig.cap = "(ref:es-fishing-intensity-cap)", fig.height = 5, fig.width = 8, is.fig = TRUE, alt.text = "This figure shows that we have been below the management value of 1 for FSPR 40 percent throughout the entire time series."}
plot_fishing_intensity(base_model)
```

Median exploitation fraction (catch divided by biomass of fish of age-2 and
above) peaked in 2006 and reached similar levels in 1999 and 2008
(Figure~\@ref(fig:es-exploitation-fraction). Over the last five years, the
median estimated exploitation fraction was the highest in 2020 followed
closely by 2021 before dropping by nearly half in 2022
(Table~\@ref(tab:es-fishing-intensity-tab). Median relative fishing intensity is
estimated to have declined from `r median_intensity_2010`% in 2010 to 
`r median_intensity_2015`% in 2015. It then leveled off around 70% from 2016
to 2019 before declining to `r median_intensity_2022`% in 2022. The median
exploitation fraction has, on average, increased from a recent low of
`r exploitation_med_2012` in 2012 to `r exploitation_med_2020` in 2020
before dropping back to 2012--2015 levels in 2022. There is a considerable
amount of uncertainty around estimates of relative fishing intensity, with
the 95% posterior credibility interval reaching above the $\FSPRforty$ management
level (of 1.0) in 2017 and 2018 over the past decade
(Figure~\@ref(fig:es-fishing-intensity). Exploitation and fishing intensity
rates do not always track well due to a combination of changing age
distributions and changing selectivities over time.

## Management performance {-}

Over the last decade (`r end_yr-10`--`r end_yr - 1`), the mean coast-wide
utilization rate (proportion of catch target removed) has been
`r tot_last_10_yrs_attainment`% (Table~\@ref(tab:es-landings-tac-tab). Over
the last five years (`r end_yr - 5` to `r end_yr - 1`), the mean utilization
rates were `r us_last_5_yrs_attainment`% for the United States
and `r can_last_5_yrs_attainment`% for Canada. While relatively stable during
this time in the United States, the utilization rate in Canada has been
declining since 2020 to a time-series low of 20.3% in 2022. Country-specific
quotas (or catch targets) in 2020 and 2021 were specified unilaterally, due to
the lack of an agreement on coast-wide 2020 and 2021 TACs. The usual
`r us_allotment_percent`% and
`r can_allotment_percent`% allocation of coast-wide TAC, as specified in the
Joint U.S.-Canada Agreement for `r sp`, was once again implemented in 2022.

Total landings last exceeded the coast-wide quota in 2002 when utilization
was 112%, though the fishing intensity was relatively low that year due to
the appearance of the 1999 year class.

(ref:es-exploitation-fraction-cap) Trend in median exploitation fraction
(catch divided by age-2+ biomass) through `r end_yr - 1` with 95% posterior
credibility intervals.
         
```{r es-exploitation-fraction, fig.cap = "(ref:es-exploitation-fraction-cap)", fig.height = 5, fig.width = 8, is.fig = TRUE, alt.text = "This figure shows that the current exploitation fraction of the female spawning biomass is approximately 0.05. This is a drop from the last five years which have been approximately 0.1."}
plot_exploitation_fraction(base_model)
```

```{r es-landings-tac-tab, results = "asis", echo = FALSE}
table_landings_tac(ct,
                   start_yr = end_yr - 10,
                   end_yr = end_yr - 1,
                   caption = paste0(
                     "Recent trends in ", sp, " landings and management ",
                     "decisions. Catch targets in 2020 and 2021 were ",
                     "specified unilaterally. All landings and catch ",
                     "targets are given in tonnes."))
```

(ref:es-phase-cap) Estimated historical path of median relative spawning
biomass in year $t$ and corresponding median relative fishing intensity in
year $t - 1$. Labels show the time series start and end years and the year
after the highest relative fishing intensity; labels correspond to year $t$
(i.e., year of the relative spawning biomass). Gray bars span the 95%
credibility intervals for `r end_yr` relative spawning biomass (horizontal)
and `r end_yr - 1` relative fishing intensity (vertical).
         
```{r es-phase, fig.cap = "(ref:es-phase-cap)", fig.height = 5, fig.width = 8, is.fig = TRUE, alt.text = "This figure shows that we are currently not overfishing nor in an overfished state."}
plot_phase(base_model,
           1966,
           2023,
           init_lbl_x_off = -0.04,
           init_lbl_y_off = -0.04,
           final_lbl_x_off = 0.04,
           final_lbl_y_off = 0.04)
```

The median relative fishing intensity was below 1.0 in all years
(Figures~\@ref(fig:es-fishing-intensity) and~\@ref(fig:es-phase)). The median
relative spawning biomass was above the $\Bforty$ reference point in all
years except 2007--2010 (Figures~\@ref(fig:es-relative-biomass)
and~\@ref(fig:es-phase), and the median relative fishing intensity was below
1.0 (Figure~\@ref(fig:es-phase)).
The benchmark quantities, $\FSPRforty$ and $\Bforty$, result in different median
population sizes (see Table~\@ref(tab:es-reference-points-tab)), highlighting
that there are subtle differences in these conceptual reference points.
Between 2007 and 2010, median relative fishing intensity ranged from
`r median_intensity_2007_to_2010_min`% to
`r median_intensity_2007_to_2010_max`% and median relative spawning biomass
between `r median_relative_bio_2007_to_2010_min` and
`r median_relative_bio_2007_to_2010_max`. Biomass has risen from the 2010 low
with the 2008, 2010, 2014, 2016, and 2020 recruitments, and median relative
spawning biomass has been above the reference point of 40% since
`r median_relative_bio_above_target_since`.

While there is large uncertainty in the estimates of relative fishing
intensity and relative spawning biomass, the model estimates a
`r joint_percent_prob_above_below`% joint probability of being both
above a relative fishing intensity of 1.0 in `r end_yr - 1` and below the
$\Bforty$ relative spawning biomass level at the start of `r end_yr`.

```{r es-reference-points-tab, results = "asis", echo = FALSE}
table_reference_points(base_model,
                       caption = paste0(
                         "Summary of median and 95\\% credibility ",
                         "intervals of equilibrium conceptual reference ",
                         "points for the ", sp, " base assessment model. ",
                         "Equilibrium reference points were computed ",
                         "using 1975--", end_yr - 1, " averages for mean ",
                         "weight-at-age and baseline selectivity-at-age ",
                         "(1966--1990; prior to time-varying ",
                         "deviations)."))
```

## Reference points {-}

The term `reference points' is used throughout this document to describe common
conceptual summary metrics (Table~\@ref(tab:es-reference-points-tab)).
The Agreement specifically identifies $\Fforty$ as the default harvest rate
and $\Bforty$ as a point where the 40:10 TAC adjustment is triggered
(see the Glossary in Appendix~\@ref(chap:glossary)).
The medians of sustainable yields and biomass reference points are similar
to what was reported in the `r last_assess_yr` assessment. The probability
that female spawning biomass at the beginning of `r assess_yr` is below
$\Bforty$ is P$(\mathrm{B}_{`r assess_yr`} < \Bforty) = `r probs_curr_below_b40`$%,
and of being below $\Btwentyfive$ is
P$(\mathrm{B}_{`r assess_yr`} < \Btwentyfive) = `r probs_curr_below_b25`$%.
The probability that the relative fishing intensity was above the $\Fforty$
level of 1.0 at the end of `r end_yr - 1`
is~`r probs_curr_rel_fish_intens_above_1`%.

## Unresolved problems and major uncertainties {-}

Measures of uncertainty in the base model underestimate the total uncertainty
in the current stock status and projections because they do not account for
possible alternative structural models for `r `simple_name` population
dynamics and fishery processes (e.g., selectivity) and the scientific basis
for prior probability distributions. To address such structural uncertainties,
we performed sensitivity analyses to investigate a range of alternative
assumptions and present the key ones in the main document.

The `r sp` stock displays high recruitment variability relative to other west
coast groundfish stocks, resulting in large and rapid biomass changes. This
leads to a dynamic fishery that potentially targets strong cohorts and results
in time-varying fishery selectivity. This volatility results in a high level
of uncertainty in estimates of current stock status and stock projections
because, with limited data to estimate incoming recruitment, the cohorts are
fished before the assessment can accurately determine how big they are (i.e.,
cohort strength is typically not well known until it is observed by the
fishery and survey, typically at a minimum age of three).  While the addition
of the age-1 index helps inform recent recruitment, the survey is conducted
every other year and does not directly address current or future recruitment
expectations. In particular, while the model estimates the 2020 cohort as
above average in size, its absolute size remains highly uncertain. This
uncertainty propagates directly into current and forecasted estimates of female
spawning biomass. The upcoming 2023 acoustic survey will provide additional
information on the size of the 2020 year-class (as well as inform the 2021 and
2022 year classes), which will lessen uncertainty of estimates of female
spawning biomass. Further, the interactions among variance parameters that
govern variability in fishery selectivity and recruitment parameters through
time, as well as those used in relative data weighting, are not well understood
and could propagate uncertainty beyond what is presented in this assessment.

## Forecast decision tables {-}

The catch limit for `r min(forecast_yrs)` based on the default \Ffortyten
harvest policy has a median of `r ct_limit_quantiles["median"]`~t with a
wide range of uncertainty, the 95% credibility interval being
`r ct_limit_quantiles["lower"]`--`r ct_limit_quantiles["upper"]`~t.

```{r es-decisions-biomass, results = "asis", echo = FALSE}
table_decision(base_model,
               label = "tab:es-decisions-biomass-tab",
               caption =
                 paste0("Forecast quantiles of ", sp, " ",
                        "relative spawning biomass at the beginning of ",
                        "the year. Catch alternatives are based on: constant ",
                        "catches (rows ",
                        ct_constant_str,
                        "), including catch similar to ",
                        min(forecast_yrs_extra)-1," (row~",
                        letters[ct_actual_ind],
                        ") and to the TAC from ",
                        min(forecast_yrs_extra)-1," (row~",
                        letters[ct_tac_ind],
                        "); and non-constant catches that result in ",
                        "annual 10\\% declines in catch (rows ",
                        ct_reduction_str,
                        "), median relative fishing intensity of 100\\% (row ",
                        letters[ct_spr100_ind],
                        "), median catch estimated ",
                        "via the default harvest policy ",
                        "(\\Ffortyten, row~",
                        letters[ct_default_policy_ind],
                        "), and the fishing intensity that results in ",
                        "the median ",
                        "projected catch remaining the same in ",
                        min(forecast_yrs_extra),
                        " and ",
                        min(forecast_yrs_extra) + 1,
                        " (row~",
                        letters[ct_stable_ind],
                        ")."),
               font_size = 9,
               space_size = 10,
               type = "biomass",
               placement = "tbp")
```

Decision tables give the projected population status (relative spawning
biomass) and fishing intensity relative to the target under different
catch alternatives for the base model (Tables~\@ref(tab:es-decisions-biomass-tab)
and~\@ref(tab:es-decisions-spr-tab)). The tables are organized to show the
projected outcome for each potential catch level and year (row) across the
quantiles (columns) of the posterior distribution. Tables show results for up
to three years of future catch levels based on subsequent estimates of stock
status and fishing intensity.
Figure~\@ref(fig:es-forecast-depletion-comparison) shows the projected relative
spawning biomass for several of the catch alternatives. Population dynamics
and governing parameters assumed during the forecast period include random
recruitment; selectivity, weight-at-age and fecundity averaged over the five
most recent years (`r assess_yr - 5`--`r assess_yr - 1`); and constant
values for all other parameters.

A relative fishing intensity of 1 should indicate fishing at the $\Fforty$
default harvest rate catch target but the projected median relative fishing
intensity can be slightly different than the target because the $\Fforty$
default harvest-rate catch limit is calculated using baseline
selectivity-at-age (1966--1990; prior to time-varying deviations), whereas the
forecasted catches are removed using selectivity averaged over the last five
years. Recent changes in selectivity will thus be reflected in the
determination of fishing relative to the default harvest policy. For example,
fishing at the $\Fforty$ default harvest-rate catch limit (scenario n: default
HR) in 2023 results in a median relative fishing intensity of 0.91 (Table~\@ref(tab:es-decisions-spr-tab)).

```{r es-decisions-spr, results = "asis", echo = FALSE}
table_decision(base_model,
               label = "tab:es-decisions-spr-tab",
               caption = paste0(
                 "Forecast quantiles of ", sp, " relative fishing intensity ",
                 "\\FishingRate, expressed as a ",
                 "proportion, for the ", min(forecast_yrs), "--",
                 max(forecast_yrs) - 1, " catch alternatives presented in ",
                 "Table~\\@ref(tab:es-decisions-biomass-tab). Values greater ",
                 "than 1 indicate relative fishing intensities greater than ",
                 "the $\\Fforty$ harvest policy calculated using baseline ",
                 "selectivity."),
               font_size = 9,
               space_size = 10,
               type = "spr",
               placement = "tbp")
```

Management metrics that were identified as important to the Joint Management
Committee and the Advisory Panel in 2012 are presented for
`r str_flatten_comma(forecast_yrs[-1], last = ", and ")` projections
(Tables~\@ref(tab:es-risk-year-1-tab), \@ref(tab:es-risk-year-2-tab),
and~\@ref(tab:es-risk-year-3-tab);
Figures~\@ref(fig:es-risk-year-1),
\@ref(fig:es-risk-year-2),
and~\@ref(fig:es-risk-year-3)).
These metrics summarize the probability of various outcomes from the base model
given each potential management action. Although not linear, probabilities can
be interpolated from these results for intermediate catch values in
`r assess_yr` (Table~\@ref(tab:es-risk-year-1-tab) and
Figure~\@ref(fig:es-risk-year-1)).
However, interpolation is not appropriate for all catches in `r assess_yr + 1`
or `r assess_yr + 2` because they are conditional on previous year(s) catch
levels. This explains why a few probabilities decline (rather than rise) with
increased `r assess_yr + 1` and `r assess_yr + 2` catch levels
(Tables~\@ref(tab:es-risk-year-2-tab) and~\@ref(tab:es-risk-year-3-tab)
and Figures~\@ref(fig:es-risk-year-2) and~\@ref(fig:es-risk-year-3)).

(ref:es-forecast-depletion-comparison-cap) Median and 95 posterior
credibility intervals of estimated relative spawning biomass to the start
of `r end_yr` from the base model and projections to the start of `r forecast_yrs[length(forecast_yrs)]` for several management actions, which
are defined in Table~\@ref(tab:es-decisions-biomass-tab).
         
```{r es-forecast-depletion-comparison, fig.cap = "(ref:es-forecast-depletion-comparison-cap)", fig.height = 5, fig.width = 8, is.fig = TRUE, alt.text = "This figure shows that the median relative spawning biomass is projected to remain flat for the next 3 years with zero catch and to decline for all non-zero catch levels evaluated."}
# See the file `forecast-catch-levels.R` at the list called `ct_levels`. The values in
# `fore_inds` below are the indices of those forecast values in that list.
plot_depl_fore_comparison(base_model,
                          fore_inds = c(1, 2, 6, 12, 14),
                          forecast_yrs = forecast_yrs)
```

The predicted relative spawning biomass trajectory through
`r forecast_yrs[length(forecast_yrs)]` is shown in
Figure~\@ref(fig:es-forecast-depletion-comparison) for several of the
management actions. With zero catch for the next three years, the biomass has
a `r zero_catch_prob_bio_down_1`% probability of decreasing from
`r forecast_yrs[1]` to `r forecast_yrs[2]` (Table~\@ref(tab:es-risk-year-1-tab)), a
`r zero_catch_prob_bio_down_2`% probability of decreasing from
`r forecast_yrs[2]` to `r forecast_yrs[3]` (Table~\@ref(tab:es-risk-year-2-tab)),
and a `r zero_catch_prob_bio_down_3`% probability of decreasing from
`r forecast_yrs[3]` to `r forecast_yrs[4]` (Table~\@ref(tab:es-risk-year-3-tab)).

The probability of the female spawning biomass decreasing from `r end_yr` to
`r end_yr + 1` is above 72% for all non-zero catch levels examined
(Table~\@ref(tab:es-risk-year-1-tab) and
Figure~\@ref(fig:es-risk-year-1)). This probability is
81% for a `r end_yr` catch level similar to that for `r end_yr - 1`
(scenario f: `r end_yr` catch). For all explored catches, the maximum
probability of female spawning biomass at the start of `r end_yr + 1` dropping
below $\Bten$ is 0%, and of dropping below $\Bforty$ is 10%
(Table~\@ref(tab:es-risk-year-1-tab) and
Figure~\@ref(fig:es-risk-year-1)).
As the large 2010, 2014, and 2016 cohorts continue to age, their biomass is
expected to decrease as losses from mortality outweigh increases from growth.
The estimated above-average (yet still highly uncertain) 2020 cohort will
continue to play a large role in determining female spawning biomass during
the forecast years presented here.

(ref:es-risk-year-1-cap) Graphical representation of
the probabilities related to spawning biomass, relative fishing intensity, and
the `r end_yr + 1` default harvest policy catch for alternative `r end_yr`
catch options (explained in Table~\@ref(tab:es-decisions-biomass-tab)) as listed in
Table~\@ref(tab:es-risk-year-1-tab). The symbols indicate points that were computed
directly from model output and lines interpolate between the points.
         
```{r es-risk-year-1, fig.cap = "(ref:es-risk-year-1-cap)", fig.height = 4.5, fig.width = 8, is.fig = TRUE, alt.text = "This figure shows that the probability that the stock declines in 2024 is 50 percent or greater for all catch levels including zero. The probability that the stock falls under B40 is almost zero for catches up to approximately 350 thousand tonnes."}
plot_fore_compare(base_model,
                  forecast_yrs = forecast_yrs,
                  fore_yr = forecast_yrs[1],
                  leg_pos = c(0.2, 0.32),
                  remove_x_val = 325)
```

```{r es-risk-year-1-tab, results = "asis", echo = FALSE}
# Index in models[[]]$risks to use, e.g. 1 means forecast year 2 compared
# to forecast year 1
table_risk(base_model,
           forecast_yrs,
           index = 1,
           caption = paste0(
             "Probabilities related to female spawning biomass, ",
             "relative fishing intensity, and the ", end_yr + 1,
             " default harvest policy catch for alternative ",
             end_yr," catch options (explained in ",
             "Table~\\@ref(tab:es-decisions-biomass-tab))."))
```

(ref:es-risk-year-2-cap) Graphical representation
of the probabilities related to spawning biomass, relative fishing intensity,
and the `r end_yr + 2` default harvest policy catch for alternative
`r end_yr + 1` catch options (including associated `r end_yr` catch; catch
options explained in Table~\@ref(tab:es-decisions-biomass-tab)) as listed in
Table~\@ref(tab:es-risk-year-2-tab). The symbols indicate points that were
computed directly from model output and lines interpolate between the points.

```{r es-risk-year-2, fig.cap = "(ref:es-risk-year-2-cap)", fig.height=4.5, fig.width=8, is.fig = TRUE, alt.text = "This figure shows that the probability that the stock declines in 2025 is 74 percent or greater for all catch levels including zero. The probability that the stock falls under B40 is below 0.1 for catches up to approximately 380 thousand tonnes."}
plot_fore_compare(base_model,
                  forecast_yrs = forecast_yrs,
                  fore_yr = forecast_yrs[2],
                  leg_pos = c(0.2, 0.32),
                  remove_x_val = c(325, 342, 740))
```

```{r es-risk-year-2-tab, results = "asis", echo = FALSE}
table_risk(base_model,
           forecast_yrs,
           index = 2,
           caption = paste0(
             "Probabilities related to female spawning biomass, relative ",
             "fishing intensity, and the ", end_yr + 2, " default harvest ",
             "policy catch for alternative ", end_yr + 1, " catch options, ",
             "given the ", end_yr, " catch shown in ",
             "Table~\\@ref(tab:es-risk-year-1-tab) (catch options explained in ",
             "Table~\\@ref(tab:es-decisions-biomass-tab))."))
```

(ref:es-risk-year-3-cap) Graphical representation of
the probabilities related to spawning biomass, relative fishing intensity, and
the `r end_yr + 3` default harvest policy catch for alternative `r end_yr + 2`
catch options (including associated `r end_yr` and `r end_yr + 1` catches;
catch options explained in Table~\@ref(tab:es-decisions-biomass-tab)) as listed in
Table~\@ref(tab:es-risk-year-3-tab). The symbols indicate points that were computed
directly from model output and lines interpolate between the points.

```{r es-risk-year-3, fig.cap = "(ref:es-risk-year-3-cap)", fig.height = 4.5, fig.width = 8, is.fig = TRUE, alt.text = "This figure shows that the probability that the stock declines in 2026 is approximately 65 percent or greater for all catch levels including zero. The probability that the stock falls under B40 is below 0.1 for catches up to approximately 350 thousand tonnes."}
plot_fore_compare(base_model,
                  forecast_yrs = forecast_yrs,
                  fore_yr = forecast_yrs[3],
                  leg_pos = c(0.2, 0.32),
                  remove_x_val = c(259, 621))
```

```{r es-risk-year-3-tab, results = "asis", echo = FALSE}
table_risk(base_model,
           forecast_yrs,
           index = 3,
           caption = paste0(
             "Probabilities related to female spawning biomass, relative ",
             "fishing intensity, and the ", end_yr + 3, " default harvest ",
             "policy catch for alternative ", end_yr + 2, " catch options, ",
             "given the ", end_yr, " and ", end_yr + 1, " catches shown in ",
             "Tables~\\@ref(tab:es-risk-year-1-tab) ",
             "and~\\@ref(tab:es-risk-year-2-tab) (catch options explained in ",
             "Table~\\@ref(tab:es-decisions-biomass-tab))."))
```
\clearpage

## Research and data needs {-}
```{r child = "011-research-needs/research-needs.rmd"}
```

\clearpage

<!--chapter:end:007-executive-summary.rmd-->

\newpage

\rfoot{Introduction}

# Introduction {#sec:introduction}

The Joint U.S.-Canada Agreement for `r sp` (called the Agreement) was signed
in 2003, went into force in 2008, and was implemented in 2010.  The committees
defined by the Agreement were first formed in 2011, and 2012 was the first year
for which the process defined by the Agreement was followed, including stock
assessment. This is the
`r number_to_word(assess_yr - 2011, th = TRUE)` annual stock assessment
conducted under the Agreement process.

Under the Agreement, `r sp` (*`r science_name`*, also referred to as
`r common_name`) stock assessments are to be prepared by the Joint Technical
Committee (JTC) comprised of both U.S. and Canadian scientists and reviewed by
the Scientific Review Group (SRG) that consists of representatives from both
nations. Additionally, the Agreement calls for both of these bodies to include
scientists nominated by an Advisory Panel (AP) of fishery stakeholders.

The primary data sources for this assessment include an acoustic survey,
annual fishery catch, mean weight-at-age data, as well as survey and fishery
age-composition data. The assessment depends primarily upon an acoustic survey
index of biomass time series for information on the scale of the current
population. Age-composition data from the aggregated fishery and the acoustic
survey provide additional information allowing the model to resolve strong and
weak cohorts. The catch is an important source of information regarding changes
in abundance and places a lower bound on the available population biomass in
each year.

This assessment is fully Bayesian, with the base model incorporating prior
information on several key parameters (including informative priors
on natural mortality, $M$, and steepness of the stock-recruit relationship,
$h$) and integrating over parameter uncertainty to provide results that can be
probabilistically interpreted. From a range of alternate models investigated
by the JTC, a subset of sensitivity analyses are also reported to provide a
broad qualitative comparison of structural uncertainty with respect to the
base model (Section~\@ref(sec:assessment-sensitivity-analyses)). The
structural assumptions of this `r assess_yr` base model, implemented using
version `r ss_version` of the Stock Synthesis software
@MethotWetzel2013, are the same as the `r last_assess_yr` base model
[@JTC2022]. All model runs reported in this document are performed in a
Bayesian context. Responses to `r last_assess_yr` SRG requests are in
Section~\@ref(sec:assessment-response-review) and a Glossary of terms appears
in Appendix~\@ref(chap:glossary).

## Stock structure and life history {#sec:intro-stock-structure}

`r sp` is a semi-pelagic schooling species distributed along the west coast
of North America, generally ranging in latitude from 25\degree\ N~to 55\degree\ N
(see Figure~\@ref(fig:main-overview-map) for an overview map). It is among 18
species of hake from four genera (being the majority of the family
*Merluccidae*), which are found in both hemispheres of the Atlantic and Pacific
Oceans [@AlheitPitcher1995; @LlorisMatallanasEtAl2005].
The coastal population of `r sp` is currently the most abundant groundfish
population in the California Current system. Smaller populations of this species
occur in the major inlets of the Northeast Pacific Ocean, including the Strait
of Georgia, the Puget Sound, and the Gulf of California. Each of these smaller
populations are genetically distinct from the coastal population
[@VroomanPaloma1977; @IwamotoFordEtAl2004; @KingMcFarlaneEtAl2012;
@GarciaEtAl2018]. The coastal population is also distinguished from the inshore
populations by larger size-at-age and seasonal migratory behavior and from fish
off the west coast of Baja California by smaller size-at-age and later spawning
[@Zamora-Garcia2020].

The coastal population of `r sp` typically ranges from the waters off southern
California to northern British Columbia and rarely into southern Alaska, with
the northern boundary related to fluctuations in annual migration
[@HamelEtAl2015] depending, in part, on water temperature
[@MalickHunsickerEtAl2020; @MalickSiedleckiEtAl2020]. In spring, adult
`r sp` migrate onshore and northward to feed along the continental shelf and
slope from northern California to Vancouver Island. In summer, `r sp` often
form extensive mid-water aggregations in association with the continental
shelf break, with the highest densities located over bottom depths of
200--300~m [@DornMethot1991; @DornMethot1992].

Older `r sp` exhibit the greatest northern migration each season, with two-
and three-year old fish rarely observed in Canadian waters north of southern
Vancouver Island. During El Ni\~no events (warm ocean conditions such as in
1998 and 2016), a larger proportion of the population migrates into Canadian
waters (Figure~\@ref(fig:main-backscatter-map)), due to temperature effects
[@MalickHunsickerEtAl2020] and possibly intensified northward transport
during the period of active migration [@Dorn1995b; @AgostiniFrancisEtAl2006].
In contrast, La Ni\~na conditions (colder water, such as in 2001, 2011, and
2021) result in a southward shift in their distribution, with a much smaller
proportion of the population found in Canadian waters, as seen in those
surveys (Figure~\@ref(fig:main-backscatter-map)). In general, warmer than
average thermal habitat conditions for mature `r sp` leads to relatively
higher biomass further north and relatively lower biomass around the
U.S.-Canadian border, while cooler than average conditions leads to relatively
higher biomass of immature `r sp` generally spread evenly across their
distribution [@MalickHunsickerEtAl2020]. The distribution of age-1 fish also
changes between years (Figure~\@ref(fig:main-backscatter-map-age1)).

## Ecosystem considerations {#sec:intro-ecosystem-considerations}

`r sp` are important to ecosystem dynamics in the Eastern Pacific Ocean due
to their relatively large total biomass and potentially large role as both prey
and predator [@JTC2013]. Ongoing research investigating abiotic
(environmental conditions) and biotic (e.g., maturity and diet) drivers of the
distribution, recruitment, growth, and survival of `r sp` could provide
insight into how the population is linked with broader ecosystem
considerations. For example, @TurleyRykaczewski2019 found decreased
survival of larval `r sp` as storm events increased, contrary to many other
species in the southern California Current Ecosystem. An analysis of drivers of
recruitment across the maternal preconditioning, egg, and larval phases of
`r sp` indicated recruitment is associated with eddy kinetic energy, the
location of the North Pacific Current bifurcation, and upwelling during
maternal preconditioning, as well as associated with northward long-shore
transport and the number of days between storm events during larval stages
(Vestfals et al., under review). @Phillips2022 suggests temperature
dynamically influences the co-occurrence of `r sp` and krill (i.e.,
euphausiids; *Euphausiacea*), which can influence annual `r sp` growth
and recruitment as the availability of key prey species shifts. Previous
research developed an index of abundance for Humboldt Squid
(*Dosidicus gigas*) and suggested that the abundance of `r sp` decreased
with increasing squid abundance [@StewartHazenEtAl2014, JTC2015]. Many
additional research topics relevant to `r sp` distribution, recruitment,
and growth patterns in relation to oceanographic conditions have been
investigated [@ResslerHolmesEtAl2007; @HamelEtAl2015;
@MalickHunsickerEtAl2020; @MalickSiedleckiEtAl2020] but further research on
this topic is still needed.

Fitting the assessment model to empirical weight-at-age data allows for
time-varying growth without needing a mechanistic relationship or environmental
data, which facilitates an `Ecosystem Approach to Fisheries Management'
(a priority for DFO and NOAA); see Section~\@ref(sec:data-weight-at-age).
Nonetheless, ongoing research investigating spatiotemporal drivers of
weight-at-age will provide more insights into the specific mechanisms
affecting changes in growth, which will enable condition-specific prediction
capabilities (e.g., assumptions of growth, or weight-at-age, during forecast
years).

## Management of `r sp` {#sec:intro-management}

Since the implementation of the Magnuson-Stevens Fishery Conservation and
Management Act in the U.S. and the declaration of a 200-mile
fishery-conservation zone in the U.S. and Canada in the late 1970s, annual
quotas (or catch targets) have been used to limit the catch of `r sp` in
both countries' zones. Scientists from both countries historically
collaborated through the Technical Subcommittee of the Canada-U.S.
Groundfish Committee (TSC), and there were informal agreements on the adoption
of annual fishing policies. During the 1990s, however, disagreements between
the U.S. and Canada on the allotment of the catch limits between U.S. and
Canadian fisheries led to quota overruns; the 1991--1992 national quotas
summed to `r tot_9192_attainment`% of the coast-wide limit, while the
1993--1999 combined quotas were an average of `r tot_9399_attainment`% of the
limit. The Agreement establishes U.S. and Canadian shares of the coast-wide
total allowable  catch (TAC) at `r us_allotment_percent`% and
`r can_allotment_percent`%, respectively, and this distribution has largely
been adhered to since 2005. However, a bilateral agreement on the coast-wide
TAC could not be reached in 2020 or 2021; so, catch targets were set
unilaterally during these years for the first time since the inception of the
Agreement. Catch allocations as specified in the Agreement were once again
applied in 2022.

Since 1999, an upper limit on catch has been calculated using an $\Fforty$
default harvest rate with a 40:10 adjustment. This decreases the catch
linearly from the catch at a relative spawning biomass of 40% to zero catch
at a relative spawning biomass values of 10% or less (called the default
harvest policy in the Agreement); relative spawning biomass is the female
spawning biomass divided by that at unfished equilibrium. Further
considerations have almost always resulted in catch targets being set
lower than the recommended catch limit. Total catch has not exceeded the
coast-wide quota since 2002, and harvest rates are likely to have never
exceeded the $\Fforty$ target.

### Management of `r sp` in the United States {#sec:intro-management-us}

In the U.S. zone, participants in the directed fishery are required to use
pelagic trawls with a codend mesh of at least 7.5~cm. Regulations also
restrict the area and season of fishing to reduce the bycatch of Chinook
Salmon (*Oncorhynchus tshawytscha*), depleted rockfish populations (though
all but Yelloweye Rockfish, *Sebastes ruberrimus*, have rebuilt in recent
years), and other species as related to their specific harvest
specifications. The current allocation agreement, effective since 1997,
divides the U.S. harvest into tribal (17.5%) and non-tribal (82.5%,
including a small amount set aside for research) components. Starting in 1996,
the Makah Tribe has conducted a fishery with the tribal allocation in its
``usual and accustomed fishing area''. The non-tribal harvest allocation is
divided among catcher-processors (34%), motherships (24%), and the shore-based
fleet (42%). Since 2011, the non-tribal U.S. fishery has been fully
rationalized with allocations in the form of Individual Fishing Quotas (IFQs)
to the shore-based sector and group shares to cooperatives in the at-sea
mothership (MS) and catcher-processor (CP) sectors. The At-Sea Hake Observer
Program has been monitoring fishing vessel activity since 1975, originally
monitoring foreign and joint-venture vessels. Observer coverage has been
100% on all domestic vessels since 1991 (including the 2020 and 2021 fishing
seasons, despite the COVID-19 pandemic).

Shortly after the 1997 allocation agreement was approved by the Pacific Marine
Fisheries Commission, fishing companies owning catcher-processor
vessels with U.S. west coast groundfish permits established the Pacific Whiting
Conservation Cooperative (PWCC). The primary role of the PWCC is to distribute
the catcher-processor allocation among its members to achieve greater efficiency and
product quality, as well as promoting reductions in waste and bycatch rates
relative to the former 'derby' fishery in which all vessels competed for a
fleet-wide quota. The mothership fleet has also formed a cooperative where
bycatch allocations are pooled and shared among the vessels. The individual
cooperatives have internal systems of in-season monitoring and spatial closures
to avoid and reduce bycatch of salmon and rockfish.

### Management of `r sp` in Canada {#sec:intro-management-canada}

Canadian groundfish managers distribute their portion of the coast-wide TAC
as quota to individual license holders. In `r last_data_yr`, Canadian hake
fishermen were allocated a TAC of `r last_yr_can_tac`~t, which did not
include any carryover quota. Canadian priority lies with the domestic fishery,
but when there is determined to be an excess of fish for which there is not
enough domestic processing capacity, fisheries managers give consideration to
a Joint-Venture fishery in which foreign processor vessels are allowed to
accept codends from Canadian catcher vessels while at sea. The last year a
Joint-Venture fishery was conducted was in `r latest_yr_can_jv`.

In `r last_data_yr`, all Canadian `r sp` trips were subject to 100%
observer coverage, by electronic monitoring for both the shoreside component
of the domestic fishery and the freezer-trawler component. There were once
again no on-board observers available for the entirety of the fishing season.
This is expected to be the situation moving forward, with no plans for
observers to board any of the Canadian groundfish vessels.

Retention of all catch, with the exception of prohibited species, was
mandatory. The retention of groundfish other than Sablefish, Mackerel,
Walleye Pollock, and Pacific Halibut on dedicated `r sp` trips using
electronic monitoring was not allowed to exceed 10% of the landed catch
weight. The bycatch allowance for Walleye Pollock was 30% of the total landed
weight.

## Fisheries {#sec:intro-fisheries}

The fishery for the coastal population of `r sp` occurs along the coasts of
northern California, Oregon, Washington, and British Columbia primarily during
May-November [@JTC2013]. The fishery is conducted with mid-water trawls and
has met the Marine Stewardship Council (MSC) Fisheries Standard to be
certified as meeting sustainable fishing benchmarks since 2009. Foreign fleets
dominated the fishery until 1991, when domestic fleets began taking the
majority of the catch. Catches were occasionally greater than 200,000~t prior
to 1986, and since then they have been greater than 200,000~t for all except
`r catches_below_200000_since_1986` years.

According to 2020 statistics, the `r sp` fishery was Canada's largest
commercial wild fishery (species with the largest catch), representing 14% of
[Canada's total landings](https://www.dfo-mpo.gc.ca/stats/commercial/land-debarq/sea-maritimes/s2020pq-eng.htm) of all species.
Over CA\$26~million in wages was estimated to have been paid to employees of
the processing industry in British Columbia in 2019, with an exported value of
CA\$100~million in product mainly to Ukraine, China,  Lithuania, and South
Africa [@DFO2021].

In the US, over \$75.2 million in wages was estimated
[to have been paid to employees in 2020](https://dataexplorer.northwestscience.fisheries.noaa.gov/fisheye/PerformanceMetrics/).
This includes wages paid to crew and captains fishing on catcher vessels that
deliver shoreside and at-sea to motherships, workers in shore-based processing
facilities, crew, captains, and workers on catcher-processor vessels, and
workers on mothership vessels. The exported value of `r sp` was
US\$127~million in 2020, including to Ukraine, Nigeria, and Italy, which make
up about 57% of the [total exports](https://foss.nmfs.noaa.gov/apexfoss/f?p=215:200:2797069701321).
The total economic impacts of the `r sp` fishery on the U.S. West Coast in
2020 was US\$289 million in income and 3,950 U.S. jobs.

The Joint Management Committee (JMC) determined an adjusted (for carryovers)
coast-wide TAC of `r last_yr_tac`~t for `r last_data_yr`. The U.S. catch
target was set at `r last_yr_us_tac`~t and the Canadian catch target
at `r last_yr_can_tac`~t. The historical catch of `r sp` for
`r start_yr`--`r last_data_yr` by nation and fishery sector is shown in
Tables~\@ref(tab:intro-catches-US)--\@ref(tab:main-landings-tac) and
Figure~\@ref(fig:main-catches). Table~\@ref(tab:main-landings-tac) also shows
recent catches in relation to targets (see
Section~\@ref(sec:assessment-model-results)). A brief review of the
`r last_data_yr` fishery is presented here by country.  Additional
information is available in annual United States and Canada Advisory Panel
reports
(Appendices~\@ref(chap:us-fishery-report)--\@ref(chap:canada-fishery-report)).

### Fisheries for `r sp` in the United States {#sec:intro-fisheries-us}

The U.S. specified catch target (i.e., adjusted for carryovers) of
`r last_yr_us_tac`~t was further divided among the research, tribal,
catcher-processor, mothership, and shore-based sectors. After the tribal
allocation of 17.5% (`r f(last_yr_us_tribal)`~t), and a
`r f(last_yr_us_research)`~t allocation for research catch and bycatch in
non-groundfish fisheries, the `r last_data_yr` non-tribal U.S. catch limit
of `r f(last_yr_us_non_tribal)`~t was allocated to the catcher-processor
(34%), mothership (24%), and shore-based (42%) commercial sectors.
Reallocation of `r f(last_yr_us_tribal_quota_reallocated)`~t of tribal
quota to non-tribal sectors on
`r noquote(last_yr_us_tribal_reallocate_dates_f)`
 resulted in final quotas for the catcher-processor, mothership, and
 shore-based sectors of
`r f(last_yr_us_cp_quota_reallocated)`~t,
`r f(last_yr_us_ms_quota_reallocated)`~t,
and
`r f(last_yr_us_shore_quota_reallocated)`~t, respectively.

The midwater fishery for `r sp` began on May 15 for the shore-based and
at-sea fisheries. In earlier years, the shore-based midwater fishery began on
June 15 north of 42\degree\ N latitude, but could fish for `r sp` between
40\degree\ 30'N and 42\degree\ N latitudes starting on April 1. Since
2015, the shore-based fishery has been allowed to fish north of 40\degree\ 30'N
latitude starting May 15 and fish south of 40\degree\ 30'N latitude
starting on April 15, although only a small amount of the shore-based
allocation is released for this early period prior to the main opening.
Regulations do not allow at-sea processing or night fishing (midnight to one
hour after official sunrise) south of 42\degree\ N latitude (the
Oregon-California border) at any time during the year.

The total catch of `r sp` in U.S. waters was the fourth highest value ever
recorded (Table~\@ref(tab:intro-catches-US)) and the U.S. utilization rate
(`r last_yr_us_attained`%) continued to be maintained close to what it
has been in recent years (see Appendix~\@ref(chap:us-fishery-report) for more
details). The catcher-processor, mothership, and shore-based fleets caught
`r catcher_processor_ct`%, `r mothership_ct`%, and `r shore_based_ct`% of
their final reallocated quotas, respectively. Tribal landings, which are
included in the shoreside sector totals were `r f(last_yr_us_ti_ct)`~t.
Monthly catch rates in the at-sea sector were on average lower than last year
except for May, which was slightly higher, and August, which in most years
has no catch due to vessels fishing Alaskan pollock at that time
(Figure~\@ref(fig:main-us-catch-rates)). The median fishing depth for the
at-sea fleets was deeper than last year but near the average over the last
five years (Figure~\@ref(fig:main-us-at-sea-depths)). The shore-based fishery
had the largest monthly catches during July, August, and September.

In both U.S. at-sea sectors, age-2, age-6, and age-8 fish, associated with the
2020, 2016, and 2014 year classes, were the most common ages. Unlike last year,
age-2 fish were seen in appreciable numbers in the catch this year.
The reported proportions at age summarize sampling efforts on
`r us_age_n_cp` catcher-processor hauls and `r us_age_n_ms` mothership hauls
(Table~\@ref(tab:main-sampling-history)).
For the catcher-processor sector, the four most abundant age classes (by
numbers) seen in `r last_data_yr` were age-`r us_age_1_prop_age_cp`
(`r us_age_1_prop_cp`%), age-`r us_age_2_prop_age_cp` (`r us_age_2_prop_cp`%),
age-`r us_age_3_prop_age_cp` (`r us_age_3_prop_cp`%), and
age-`r us_age_4_prop_age_cp` (`r us_age_4_prop_cp`%);
Table~\@ref(tab:main-us-cp-age-data).
For the mothership sector, the four most abundant age classes for
`r last_data_yr` were age-`r us_age_1_prop_age_ms` (`r us_age_1_prop_ms`%),
age-`r us_age_2_prop_age_ms` (`r us_age_2_prop_ms`%),
age-`r us_age_3_prop_age_ms` (`r us_age_3_prop_ms`%), and
age-`r us_age_4_prop_age_ms` (`r us_age_4_prop_ms`%);
Table~\@ref(tab:main-us-ms-age-data).

Age-samples from `r pull(us_ss_age_df[us_ss_age_df$year == last_data_yr,
"n.trips"])` shoreside trips showed similar age compositions in the catch
compared to the at-sea fisheries, though not nearly as many age-2 fish.
The four most abundant age classes for highest occurrences being for
`r last_data_yr` were age-`r us_age_1_prop_age_shore`
(`r us_age_1_prop_shore`%), age-`r us_age_2_prop_age_shore`
(`r us_age_2_prop_shore`%), age-`r us_age_3_prop_age_shore`
(`r us_age_3_prop_shore`%), and age-`r us_age_4_prop_age_shore`
(`r us_age_4_prop_shore`%);
Table~\@ref(tab:main-us-shore-age-data). Age-composition differences
between at-sea and shoreside fleets during the 2022 fishing year were larger
than usual due, in part, to seasonal spatiotemporal fleet dynamics. For
example, the timing of the at-sea `r sp` fishery shifted due to low Bering
Sea pollock quotas and stayed south along the Oregon and California border
longer than usual (see Appendix~\@ref(chap:us-fishery-report) for more
details).

### Fisheries for `r sp` in Canada {#sec:intro-fisheries-can}

The `r last_data_yr` Canadian `r sp` domestic fishery removed
`r last_yr_can_landings`~t from Canadian waters
(Table~\@ref(tab:intro-catches-Can)), which was `r last_yr_can_attained`%
of the Canadian TAC of `r last_yr_can_tac`~t. The attainment for Canada
was much lower than usual, due to the fishing vessels having a difficult
time finding fish in Canadian waters (see
Appendix~\@ref(chap:canada-fishery-report) for more details).

The shoreside component made up of vessels landing fresh round product onshore
landed `r last_yr_can_shore`~t, the lowest on record since 1990.
The freezer-trawler component, which freezes headed and gutted product while
at sea, landed `r last_yr_can_freezer`~t. There was no Joint-Venture fishery
in `r assess_yr - 1`.

Fishing started in early April and ended in November. The general view of
the Canadian fleet is that abundance in Canadian-waters was down in 2022,
including areas outside of Southwest Vancouver Island. The freezer trawlers
fished in considerably shallower areas than last year and at shallower depths,
whereas the shoreside vessels fished their gear at deeper depths than in 2021
(Figure~\@ref(fig:main-can-at-sea-depths)). Reports of difficulties finding
fish in 2022, and thus additional searching, is perhaps related to these
standout differences in fishing depths. The fish caught in Canada appeared to
be mostly from three age classes (ages 6, 8, 12, and 5), with very few smaller
fish (less than 500 grams) caught.

The most abundant year classes in the Canadian shoreside catch (by numbers)
were 
age-`r max_shoreside_age_prop_age` (`r max_shoreside_age_prop`%),
age-`r second_shoreside_age_prop_age` (`r second_shoreside_age_prop`%),
age-`r third_shoreside_age_prop_age` (`r third_shoreside_age_prop`%), and
age-`r fourth_shoreside_age_prop_age` (`r fourth_shoreside_age_prop`%);
Table~\@ref(tab:main-can-shore-age-data).
The most abundant year classes in the Canadian freezer-trawler catch were age-
`r max_freezer_trawler_age_prop_age`
(`r max_freezer_trawler_age_prop`%),
age-`r second_freezer_trawler_age_prop_age`
(`r second_freezer_trawler_age_prop`%),
age-`r third_freezer_trawler_age_prop_age`
(`r third_freezer_trawler_age_prop`%), and
age-`r fourth_freezer_trawler_age_prop_age`
(`r fourth_freezer_trawler_age_prop`%);
Table~\@ref(tab:main-can-ft-age-data).



<!--chapter:end:008-introduction.rmd-->

\newpage

\rfoot{Data}

# Data {#sec:data}

Fishery-dependent and fishery-independent data used in this assessment
(Figure~\@ref(fig:main-data-overview)) include the following sources:

- Total catch from all U.S. and Canadian fisheries that target `r sp`
from `r start_yr` to `r last_data_yr` (Tables                                       \@ref(tab:intro-catches-US)--\@ref(tab:main-landings-tac)).

- Fishery age compositions aggregated by year and country-specific sector
for the last ten years are available
(Tables~\@ref(tab:main-us-cp-age-data)--\@ref(tab:main-can-ft-age-data))
to investigate region-specific trends; age compositions aggregated by year,
composed of data from the U.S. fishery
(`r max_fishery_age_prop[1]`--`r max_fishery_age_prop[2]`) and the
Canadian fishery
(`r can_age_yrs_min`--`r can_age_yrs_max`),
are used to fit the model
(Table~\@ref(tab:main-all-age-data-fishery) and Figure~\@ref(fig:main-age-comp-bubbles)).

- Biomass index and age compositions from the `r survey_name`
(`r str_flatten_comma(survey.age.years)`;
 Tables~\@ref(tab:main-all-age-data-survey), ~\@ref(tab:main-survey-history),
 and~\@ref(tab:main-survey-by-country);
 Figures~\@ref(fig:main-age-comp-bubbles) and~\@ref(fig:main-survey-extrap-biomass)).

- The relative age-1 index (billions of age-1 fish) derived from the `r survey_name`
(`r str_flatten_comma(survey_age1_yrs)`;
 Table~\@ref(tab:main-survey-history); Figure~\@ref(fig:main-age-one-index)).

- Mean observed weight-at-age data from fishery and survey catches
(1975--`r max_fishery_age_prop[2]`;
  Figures~\@ref(fig:main-empirical-weight-at-age)--\@ref(fig:main-weight-at-age-lines))
and, thus, derived fecundity-at-age as well (Figure~\@ref(fig:main-maturity)).

The following biological relationships, derived from external analysis of
auxiliary data, were input as fixed values in the assessment model:

- Ageing-error matrices based on cross-read and double-blind-read otoliths.

- Proportion of female `r sp` mature by age, as developed from recent
histological analyses of ovary samples (Table~\@ref(tab:main-ogives) and Figure~\@ref(fig:main-maturity)).

Additional data sources not used in this assessment are discussed in Section
\@ref(sec:data-not-used).

## Fishery-dependent data {#sec:data-fishery-data}

### Total catch {#sec:data-total-catch}

The catch of `r sp` for `r start_yr`--`r last_data_yr` is summarized by
country-specific sectors
(Tables~\@ref(tab:intro-catches-US)--\@ref(tab:main-landings-tac))
and modeled as annual coast-wide catches. Catches in U.S. waters prior to
1978 are available only by year from @BaileyFrancisEtAl1982 and
historical assessment documents. Canadian catches prior to 1989 are also
unavailable in disaggregated form. The U.S. shore-based landings are from the
Pacific Fishery Information Network (PacFIN) database. Foreign and
Joint-Venture catches for 1981--`r terminal_yr_us_jv_foreign` and U.S.
domestic at-sea catches for 1991--`r last_data_yr` are calculated from the
Alaska Fisheries Science Center's North Pacific Groundfish and Halibut
Observer (NORPAC) database, which also stores data from the At-Sea Hake
Observer Program. Canadian Joint-Venture catches from 1989 are from the
Groundfish Biological (GFBio) database. Canadian shore-based landings are
from the Groundfish Catch (GFCatch) database for 1989--1995, the Pacific
Harvest Trawl (PacHarvTrawl) database for 1996--March 31, 2007, and the
Fisheries Operations System (FOS) database for April 2007--present.

Vessels in the U.S. shore-based fishery carry observers and are required to
retain all catch and bycatch for sampling by plant observers. All catches
from U.S. at-sea vessels, Canadian Joint-Venture vessels, and Canadian
freezer trawlers were monitored by at-sea observers from 1996--2019.

In 2020 and 2021 there were no observers on Canadian freezer trawlers due to
staffing issues. Due to the ongoing staffing issues, the decision was made to
stop providing observers on board all Canadian vessels, for 2022 and all
future groundfish trawl trips. This means there is not currently and will not
be in the future, any at-sea sampling on board Canadian vessels. Canadian
managers, scientists, and the sampling contractor, Archipelago Marine Research
Ltd.~(AMR) met in early 2022 to solidify a plan to ensure the ongoing sampling
of `r sp` for Canadian trips. The sampling plan was agreed upon by all parties
and consisted of employees aboard Freezer trawlers freezing two bags of
approximately 50 whole fish from two tows per trip and delivering them to AMR
on return to shore. The bags are stored by AMR until enough have accumulated
to sample in bulk, and they sample them over the period of a day or two. This
plan ensures that there are individual weights taken for fish from the freezer
trawlers, something that was not happening during the at-sea sampling. These
weight data give more Canadian input into the weight-at-age matrix. The
shoreside vessels continue to make landings with sampling happening on shore
at the time of landing.

Canadian trawl catches are monitored autonomously at-sea by cameras onboard
vessels. Catch is recorded by dockside samplers within the Groundfish Trawl
Dockside Monitoring Program using total catch weights provided by processing
plants. Discards are negligible relative to the total fishery catch for all
sectors.

For recent catches with haul- or trip-level information, removals by month
during the fishing season allowed for the estimation of monthly bycatch
rates from observer or dockside information. This information has also
allowed a detailed investigation of shifts in fishery timing
(see Figure~5 in @JTC2014).

Minor updates to catches used in previous assessments were made based on the
best available information extracted from the aforementioned databases.
Tribal catches were available in PacFIN for the U.S. tribal fishery at the
time the data were extracted and were cross-checked with numbers based on
information provided by the Makah Tribe. The Makah Tribe is also working on
providing historical catches such that shore-based catches can be
summarized separately from tribal catches since the onset of the fishery.

### Fishery biological data {#sec:data-fishery-biological-data}

Biological information from the U.S. at-sea fishery was extracted from the
NORPAC database. This included sex, length, weight, and age information
from the foreign and Joint-Venture fisheries from
1975--`r terminal_yr_us_jv_foreign` and from the domestic at-sea fishery
since `r first_yr_us_atsea`. Observers collect data by selecting fish
randomly from each haul. The number of otoliths collected per haul has varied
over time but is currently three fish every third haul.

Biological samples from the U.S. shore-based fishery since 1991 were collected
by port samplers located where there are substantial landings of `r sp`,
primarily Eureka, Newport, Astoria, and Westport. Port samplers routinely take
one sample per offload (or trip) consisting of 100 randomly selected fish for
individual length and weight, and, from these, typically 20 fish are randomly
subsampled for otolith extraction.

When there were observers (1996--2019) aboard Canadian freezer trawler vessels,
they collected 50 otoliths and 300 lengths per sample, sampling once per day
during trips that on average last approximately seven days. For 2022 and
onwards, there are no longer observers on freezer trawlers
(Section~\@ref(sec:data-total-catch)), so the frozen samples that are
delivered for each trip are all sampled for length, weight, sex, and otoliths
are taken. There are approximately 100 fish per trip, in two bags of 50. There
have been some exceptions to this; due to unforeseen circumstances while at
sea, some trips did not bring any samples back and some only brought single
bags.

For electronically observed Canadian shoreside trips, port samplers obtain
biological data from the landed catch. For each sampled trip, 50 ages
and 300 lengths are sampled from the catch. Observed domestic haul-level
information is then aggregated to the trip level to be consistent with the
unobserved trips that are sampled in ports.

When there has been a Canadian Joint-Venture fishery, length samples are
collected every second day of fishing operations, and otoliths are collected
once per week. Length and age samples are taken randomly from a given codend.
The sampled weight from which biological information is collected must be
inferred from length-weight relationships.

The sampling unit for the shore-based fisheries is the trip, while the haul is
the primary unit for the at-sea fisheries
(Table~\@ref(tab:main-sampling-history)). There is no least common denominator
for aggregating at-sea and shore-based fishery samples because detailed
haul-level information is not recorded for trips in the shore-based fishery
and hauls sampled in the at-sea fishery cannot be aggregated to a comparable
trip level. As a result, initial sample sizes are simply the summed hauls and
trips for fishery biological data.

Biological data were analyzed based on the sampling protocols used to collect
them and expanded to estimate the corresponding statistic from the entire
landed catch by fishery and year when sampling occurred. A description of the
analytical steps for expanding the age compositions can be found in earlier
stock assessment documents [@JTC2013; JTC2014].

The aggregate fishery age-composition data
(`r max_fishery_age_prop[1]`--`r max_fishery_age_prop[2]`)
confirm the well-known pattern of large cohorts born in 1973, 1977, 1980,
1984, 1987, 1999, 2008, 2010, 2014, 2016, and 2020
(Table~\@ref(tab:main-all-age-data-fishery) and
Figure~\@ref(fig:main-age-comp-bubbles)).
Recent age-composition data still easily track the 2010 cohort, as well as the
large cohorts born since then (Table~\@ref(tab:main-all-age-data-fishery) and
Figure~\@ref(fig:main-age-comp-bubbles)). Currently, the 2020 cohort is the
largest observed cohort in the U.S. at-sea sector (Tables~\@ref(tab:main-us-cp-age-data)--\@ref(tab:main-us-ms-age-data)),
the 2016 cohort is the largest observed cohort in the U.S. shore-based fleet (Table~\@ref(tab:main-us-shore-age-data)) and both Canadian fleets (Tables~\@ref(tab:main-can-shore-age-data)--\@ref(tab:main-can-ft-age-data)).
Age-1 fish were observed by the fishery this year
(Table~\@ref(tab:main-all-age-data-fishery)) in the U.S. at-sea sector and
shore-based fleet. For the combined data in `r last_data_yr`,
`r top_coh(base_model, last_data_yr, 3, cap = FALSE)`. For the combined data
in `r last_data_yr - 1`,
`r top_coh(base_model, last_data_yr - 1, 3, cap = FALSE)`.

We caution that proportion-at-age data contain information about the relative
numbers-at-age, and these can be affected by changing recruitment, selectivity,
or fishing mortality, making these data difficult to interpret on their own.
For example, the above-average 2005 and 2006 year classes declined in
proportion in the 2011 fishery samples but persisted in small proportions for
years in the fishery catch, although were much reduced starting in 2011 due to
mortality and the overwhelming size of the more recent large cohorts. The
assessment model is fit to these data to estimate the absolute sizes of
incoming cohorts, which become more precise after they have been observed
several times (i.e., encountered by the fishery and survey over several years).

Both the weight-
(Figure~\@ref(fig:main-weight-at-age-lines);
Section \@ref(sec:data-weight-at-age) and length-at-age information suggest
that growth of `r sp` has fluctuated markedly over time (see Figure~7 in
@StewartForrestEtAl2011). This is particularly evident in the frequency of
larger fish ($>55$~cm) before 1990 and a recent linear shift towards larger
fish.Although length-composition data (Section \@ref(sec:data-length-at-age))
are not fit explicitly in the base assessment model presented here, the
presence of the 2008 and 2010 year classes have been clearly observed in
length data from both of the U.S. fishery sectors, and the 2014 year class has
been apparent since 2016.

## Fishery-independent data {#sec:data-fishery-independent}

### Acoustic survey {#sec:data-acoustic-survey}

The `r survey_name` [@StewartForrestEtAl2011] has been the primary
fishery-independent tool used to assess the distribution, abundance, and
biology of coastal age-2$+$ `r sp` along the west coasts of the U.S.A.
and Canada. The acoustic surveys performed in
`r survey.age.years[-length(survey.age.years)]`, and
`r survey.age.years[length(survey.age.years)]` were used in this assessment
(Table~\@ref(tab:main-survey-history)). The acoustic survey samples
transects that represent all waters off the coasts of the U.S.A. and Canada
thought to contain all portions of the age-2$+$ `r sp` stock. Observations
of age-0 and age-1 `r sp` are excluded from the age-2$+$ index due to
largely different schooling behavior relative to older `r sp`, concerns
about their catchability by the trawl gear, and differences in expected
location during the summer months when the survey takes place.
Observations of age-1 `r sp` are recorded during the survey, and additional
analyses, described below, are conducted to develop a relative age-1 index.

The `r survey_end_yr` survey covered U.S. and Canadian waters from Point
Conception to north of Haida Gwaii using 108 transects
(Figure \@ref(fig:main-backscatter-map)). In the U.S.A., transects were
mostly separated by 10~nmi, except 20~nmi spacing was used north of San
Francisco Bay to Cape Mendocino and again in northern Washington to account
for available ship days at sea. In Canada, transects were separated by 10~nmi
along Vancouver Island and then 20~nmi further north. The Bell M. Shimada and
the F/V Nordic Pearl worked collaboratively to completed the full extent of
the survey in `r survey_end_yr`.

Distributions of the backscatter of `r sp` plotted for each acoustic survey
since 1995 illustrate the variable spatial patterns of age-2$+$ fish across
years (Figure~\@ref(fig:main-backscatter-map)). This variability is due in
part to changes in the composition of the age-2$+$ population because older
`r sp` tend to migrate farther north and partly due to environmental and/or
climatic factors. The 1998 acoustic survey is notable because it shows an
extremely northward distribution that is thought to be related to the strong
1997-1998 El Ni\~no. In contrast, distribution of `r sp` during the 2001
acoustic survey was compressed into the lower latitudes off the coast of
Oregon and Northern California. There was a strong La Ni\~na event in 2000.
In 2003, 2005, and 2007 the distribution of `r sp` did not show an unusual
coast-wide pattern despite 2003 and 2007 being characterized as El Ni\~no
years. In 2009, 2011, 2012, and 2013 the majority of the distribution of
`r sp` was again found in U.S. waters, which is more likely due to
age-composition than the environment, although 2013 showed some warmer than
average sea-surface temperatures. In 2015, sea-surface temperatures were
warmer again, resulting in a northern shift in the overall distribution.
The distribution of `r sp` in 2017 was more latitudinally uniform than
observed in 2015.  This is likely a result of having large proportions of two
cohorts (2010 and 2014 year-classes) in 2017 as opposed to many other years
when a single cohort is dominant in the observed samples
(Figure~\@ref(fig:main-backscatter-map)). Weak 2019 El Ni\~no conditions
decreased in their prevalence starting in March of that year, leading to
neutral conditions by July. Consequently, the 2019 survey saw `r sp` on all
survey transects from just north of Morro Bay, California to the northern end
of Vancouver Island, with the greatest offshore extent found off of Cape
Mendocino. The 2021 survey saw the majority of `r sp` in U.S. waters and a
continuation of conditions moving towards higher productivity La Ni\~na
conditions in the California Current from 2020 to 2021. Ongoing research is
looking into relationships between environmental conditions and `r sp`
distribution and recruitment, that will help to inform the mechanisms behind
observations [@MalickSiedleckiEtAl2020; @Phillips2023].

During the acoustic surveys, mid-water trawls are made opportunistically to
determine the species composition of observed acoustic sign and to obtain the
length data necessary to scale the acoustic backscatter into biomass (see
Table~\@ref(tab:main-survey-history) for the number of trawls in each survey
year). Biological samples collected from these trawls are post-stratified,
based on similarity in size composition, and the composite length frequency is
used to characterize the size distribution of `r sp` along each transect and
to predict the expected backscattering cross section for `r sp` based on the
fish-size target-strength (TS) relationship. Any potential biases that might
be caused by factors such as alternative TS relationships are partially
accounted for in catchability. But, variability in the estimated survey
biomass due to uncertainty in TS is not explicitly accounted for in the
assessment.

Data from the acoustic survey are analyzed using kriging, which accounts for
spatial correlation, to provide an estimate of total biomass as well as an
estimate of the year-specific sampling variability due to patchiness of
schools of `r sp` and irregular transects
[@Petitgas1993; @RivoirardSimmondsEtAl2000; @@MelloRose2005;
@SimmondsMacLennan2006]. Advantages to the kriging approach are discussed in
the 2013 stock assessment [@JTC2013].

For the 2016 assessment [@JTC2016], the data from all surveys since 1998 were
scrutinized and reanalyzed using consistent assumptions, an updated version of
the EchoPro software, and a common input-file structure because some previously
generated files had spurious off-transect zeros because of how the data were
exported. The same analytical procedure was carried out during the reanalysis
of 1995 survey data [@JTC2017] and during the preparation of survey data
collected since 2017. The assumptions are as follows:

- fixed minimum ($k_{min}=3$) and maximum ($k_{min}=10$) number of
points used to calculate the value in a cell;

- search radius is three times the length scale that is estimated from the
variogram; and

- biomass decays with distance from the end of the transect when extrapolating
biomass beyond the western end of a transect, which was refined and supported
by the SRG starting with the 2016 assessment [@JTC2016].

The 2021 survey estimate was scaled by factor of 1.06 to convert EK~80 acoustic
data (2021 survey only) to EK~60 acoustic data to standardize the survey time
series. The survey team will eventually be converting all pre-2021 EK~60 data
to an equivalent EK~80 format. Thus, a full time series of consistently
analyzed survey biomass (Table~\@ref(tab:main-survey-history) and
Figure~\@ref(fig:main-survey-extrap-biomass)) and age compositions (Table~\@ref(tab:main-all-age-data-survey) and
Figure~\@ref(fig:main-age-comp-bubbles)) since 1995 are used to fit the stock
assessment model. These data contain many sources of variability (see 
@StewartForrestEtAl2011) but results from research done in 2010 and 2014 on
their representativeness show that trawl sampling and post-stratification is
only a small source of variability. Specifically, repeated trawls at different
depths and spatial locations on the same aggregation of `r sp` were similar
and analyses regarding the method used to stratify the data led to similar
overall conclusions. Estimates of country-specific age-2$+$ biomass are also
provided (Table~\@ref(tab:main-survey-by-country)).

Estimated age-2$+$ biomass in the survey increased steadily over the four
surveys conducted in 2011-2013 and 2015 (Table~\@ref(tab:main-survey-history)
and Figure~\@ref(fig:main-survey-extrap-biomass)). It decreased in 2017 to
`r f(survey_biomass["2017"], 2)`~million~t and then increased to 1.72
million~t in 2019 before decreasing again to
`r last_survey_yr_biomass`~million~t in `r last_survey_yr`. The
`r last_survey_yr` survey age composition was made up of 
`r combine_words(paste0(f(survey_last_yr_age[1:5] * 100), "\\%"))`
from the
`r combine_words(last_survey_yr-type.convert(as.is=TRUE,names(survey_last_yr_age[1:5])))`
year classes, respectively. Note that the estimate of biomass does not include
age-1 fish and the age compositions used to estimate selectivity of the survey
also exclude age-1 fish (Table~\@ref(tab:main-all-age-data-survey)).

A separate relative age-1 index (numbers of fish) was included in the base
model in 2022 and was previously explored as a sensitivity since 2013
[@JTC2013; @JTC2021; @JTC2022]. The relative index of age-1 fish in this
assessment was estimated similarly to previous years, except the estimate of
2021 numbers of age-1 fish was scaled by a factor of 1.06 to account for
differences between the EK~60 and EK~80 echosounders (the same approach used
for the estimate of age-2$+$ biomass). The index (numbers of fish) indicates
relative changes between years, not absolute values. The age-1 index
confirms the large year classes in 2008, 2010, 2014, 2016, and 2020
(Table~\@ref(tab:main-survey-history) and
Figure~\@ref(fig:main-age-one-index)). In 2021, some age-1 fish were found
in isolated homogeneous pockets but they were more so found to be mixed in
with older fish. That same general pattern has occurred since 2015, with
the exception of 2019 where age-1 fish were mostly in isolated pockets.

Incorporating the relative age-1 index results in estimates of recruitment
strength that are informed on average one year earlier than models without the
index (compare the retrospective Figures~54 and~G.1 in @JTC2021). The
suite of sensitivity models related to the relative age-1 index explored over
the past decade indicate that its use typically provides the model with the
correct direction of cohort strength (weak, strong, or neutral). The utility of
an informed recruitment signal is far greater than an uninformed recruitment
assumption. Whereas the assumption for uninformed recruitment is currently
limited to the mean estimated recruitment over a specified range of years.
Finally, the `r survey_name` team supports its use for stock assessment, and
the team is committed to continually evaluating and refining approaches to
improve survey estimates and related uncertainty. A model without the age-1
index was explored as a sensitivity.

## Other data not used in this assessment {#sec:data-not-used}

Some data sources were not included in the base model but have been explored,
used for sensitivity analyses, or were included in previous stock assessments.
Data sources not discussed here have either been discussed at past `r sp`
assessment review meetings or are discussed in more detail in the 2013 stock
assessment document [@JTC2013]. A few are listed below.

- Fishery and survey length compositions.

- Fishery and survey age-at-length compositions.

- Calculation of a reliable fishery catch-per-unit-effort (CPUE) metric is
particularly problematic for `r sp`, and it has never been used as a tuning
index for the assessment of this stock (see @JTC2013 for more details).

- Biomass index and age compositions from the following years of the
`r survey_name`, 1977, 1980, 1983, 1986, 1989, and 1992.

- Bottom trawl surveys in the U.S.A. and Canada (various years and spatial
coverage from 1977--`r last_assess_yr`).

- Northwest Fisheries Science Center/Southwest Fisheries Science
Center/PWCC coast-wide juvenile `r sp` and rockfish surveys 
(2001--`r last_assess_yr`).

- Bycatch of `r sp` in the trawl fishery for Pink Shrimp off the coast of
Oregon (2004, 2005, 2007, and 2008).

- Historical biological samples collected in Canada prior to 1990 but
currently not available in electronic form.

- Historical biological samples collected in the U.S.A. prior to 1975 but
currently not available in electronic form or too incomplete to allow
analysis with methods consistent with more current sampling programs.

- California Cooperative Oceanic Fisheries Investigations (CalCOFI)
larval `r sp` production index, 1951-2006. The data source was
previously explored and rejected as a potential index of `r sp` female
spawning biomass. However, the JTC are exploring new avenues to utilize
CalCOFI data based on recently developed methods (see
Section~\@ref(sec:assessment-response-review)).

- Northwest Fisheries Science Center winter 2016 and 2017 acoustic
research surveys of spawning `r sp`.

## Externally analyzed data {#sec:data-externally-analyzed-data}

### Maturity and fecundity {#sec:data-maturity}

Data related to the fecundity relationship were updated for the 2018
assessment [@JTC2018]. The age-based maturity ogive 
(Table~\@ref(tab:main-ogives) and Figure~\@ref(fig:main-maturity))
was developed using histological estimates of functional maturity from 1,947
ovaries that were associated with age estimates. These samples were collected
from the acoustic survey, winter and summer acoustic research trips, observers
in the U.S. At-Sea Hake Observer Program aboard commercial catcher-processor
vessels, and the U.S. West Coast Groundfish Bottom Trawl Survey
(Table~\@ref(tab:main-ovaries)). Samples from south of Point Conception
(34.44\degree N) were excluded from this analysis because they were thought
to mature at earlier ages and smaller sizes (see @JTC2018 for more
information). Tissue samples for genetic analyses have been collected from
many of the same fish from which ovaries were sampled. It is the hope that
these genetic samples may help determine whether the fish south of
34.44\degree N are from the same stock as the rest of the coastal population.
Additional samples are available to update this relationship (including
samples collected from Canadian waters since 2018) but have yet to be
analyzed.

Time-varying fecundity-at-age was modeled using year-specific weight-at-age
values in the calculation of fecundity [@JTC2019]. Samples from age-15$+$
fish were pooled for both the maturity and weight-at-age estimation due to
limited sample sizes. Consequently, the age 15$+$ estimates were applied to
ages 15-20 in the population dynamics model (Figure~\@ref(fig:main-maturity)).

Some fish at almost every age were found to be functionally immature based
on histological criteria. Older, functionally immature fish are a combination
of ``skip spawners'' that will not be spawning in the upcoming year and
senescent fish that appear to no longer have viable ovaries. Results from
ongoing research investigating the impacts of functionally immature
individuals on estimates of female spawning biomass could help refine the
fraction of fish mature at each age.

### Ageing error {#sec:data-ageing-error}

The large inventory of `r sp` age determinations includes many duplicate reads
of the same otolith, either by more than one laboratory or by more than one
age reader within a laboratory. Recent west coast stock assessments have
utilized the cross- and double-reads approach to generate an ageing-error
matrix describing the imprecision and bias in the observation process as a
function of fish age. New data and analyses were used in the 2009 assessment
to address an additional process influencing the ageing of `r sp`, namely
cohort-specific ageing error related to the relative strength of a
year-class. This process reflects a tendency for uncertain age determinations
to be assigned to predominant year classes. The result is that the presence of
strong year classes is inflated in the age data while neighboring year classes
are under-represented relative to what would be observed if ageing error were
consistent at age across cohorts.

To account for these observation errors in the model, year-specific
ageing-error matrices (defined via vectors of standard deviations of observed
age at true age) are applied, where the standard deviations of strong year
classes are reduced by a constant proportion. For the 2009 and 2010
assessments, this proportion was determined empirically by comparing
double-read error rates for strong year classes with rates for other year
classes. In 2010, a blind double-read study was conducted using otoliths
collected across the years 2003-2009. One read was conducted by a reader who
was aware of the year of collection, and therefore of the age of the strong
year classes in each sample, while the other read was performed by a reader
without knowledge of the year of collection, and therefore with little or no
information to indicate which ages would be more prevalent. The results were
analyzed via an optimization routine to estimate both ageing error and cohort
effect. The resultant ageing error was similar to the ageing error derived
from the 2008 analysis. Since 2011, cohort-specific ageing error has been
used to reduce the ageing-error standard deviation by a factor of 0.55 for the
following largest cohorts: 1980, 1984, 1999, 2010, and 2014. In the 2014 base
model [@JTC2014], the 2008 cohort was also included in this set, but
subsequent estimates show this year class to not be as strong as previously
thought, and thus, cohort-specific ageing error has not been included for the
2008 cohort since 2015. Also, cohort-specific ageing error does not include
the reduction in ageing error for age-1 fish under the assumption that they
never represent a large enough proportion of the samples to cause measurement
error related to the cohort-effect.

Additional exchanges of otoliths between ageing labs within the U.S.A. and
Canada are in process but were not completed in time for this assessment.
The additional across-lab double reads will be informative for updating
the ageing-error matrix. Unfortunately, increased protocols for moving
samples across the border have led to delays.

### Weight-at-age} {#sec:data-weight-at-age}

A matrix of empirically derived population weight-at-age means by year
(Figures~\@ref(fig:main-empirical-weight-at-age)--
\@ref(fig:main-weight-at-age-lines)) is used in the current assessment
model to translate numbers-at-age directly to biomass-at-age. Annual mean
weight-at-age was calculated from year-specific samples pooled from all
fisheries and the acoustic survey for the years 1975 to
`r max_fishery_age_prop[2]`
(Figures~\@ref(fig:main-empirical-weight-at-age)--
\@ref(fig:main-weight-at-age-lines)). Past investigations into calculating
weight-at-age for the fishery and survey independently showed little
impact on model results. New and historical samples were pulled from all
relevant databases such that the derived matrices included the best available
data. Samples from winter and research surveys are not included. Samples from
the Canadian fishery are subset by area to exclude near-shore samples.
Pre-1975 weight-at-age data available in the PacFIN database that were
discovered during the 2018 assessment-review process were confirmed to be
samples collected within Puget Sound and have not been included in any
assessment. Weights from fish ages 15 and above for each year were pooled,
and thus, ages 15--20 are assumed to have the same mean weight-at-age.
Combinations of age and year with no observations were assumed to change
linearly over time between observations at any given age. The number of
samples (Figure \@ref(fig:main-empirical-weight-at-age-numbers)) is
generally proportional to the amount of catch, so the combinations of year
and age with no samples should have relatively little importance in the
overall estimates of the population dynamics.

The biomass at the start of a given year is based on the weight-at-age from
the previous year; for example, the biomass at the start of 2022 is
calculated using the empirical weight-at-age from 2021
(Figure~\@ref(fig:main-empirical-weight-at-age)). Prior to 1975,
weight-at-age is assumed to be equal to the mean of all available
information for each respective age
(1975-`r last_data_yr`), consistent with the `r last_assess_yr` base model
(Figure~\@ref(fig:main-empirical-weight-at-age)). Both forecast
weight-at-age data and forecast selectivity are based on the respective
means from the most recent five years
(`r last_data_yr-4`--`r last_data_yr`), for consistency
(Figure~\@ref(fig:main-empirical-weight-at-age)).

The use of empirical weight-at-age is a convenient method to capture the
variability in both the weight-at-length relationship within and among
years as well as the variability in length-at-age data, without requiring
parametric models to represent these relationships. However, this method
requires the assumption that observed values are not biased by strong
selectivity at length or weight and that the spatial and temporal patterns
of the data sources provide a representative view of the underlying
population. Simulations show that, in general, using empirical
weight-at-age data when many observations are available results in more
accurate estimates of spawning biomass than modeling growth
[@KuriyamaOnoEtAl2015].

The temporal changes in weight-at-age may be due to ecosystem effects such as
prey availability, predator abundance, and ocean temperature
[@ChittaroGrandinetal2022]. Thus, while not explicitly parameterized in
the assessment, such ecosystem effects are somewhat implicitly accounted for,
especially compared to assuming time-invariant weight-at-age.

### Length-at-age {#sec:data-length-at-age}

In the 2006-2010 assessments that attempted to estimate the parameters
describing a parametric growth curve, strong patterns were identified in the
observed data indicating sexually dimorphic and temporally variable growth.
In aggregate, these patterns result in a greater amount of process error for
length-at-age data than is easily accommodated with parametric growth models,
and attempts to explicitly model size-at-age dynamics (including use of both
year-specific and cohort-specific growth) have not been very successful for
`r sp`. The lack of success was particularly evident in the residuals of the
length-frequency data from models prior to 2011. Potential avenues for
explicitly modeling variability in length- and weight-at-age data in this
model have not been revisited since 2011.

## Estimated parameters and prior probability distributions} {#sec:data-estimated-parameters}

Several prior distributions (Table~\@ref(tab:main-params-est-summary)) are
used to fit the model. The priors that are assumed to be informative are
discussed below.

### Natural Mortality {#sec:data-natural-mortality}

Since the 2011 assessment, a combination of the informative prior for natural
mortality used in previous Canadian assessments and results from analyses
using Hoenig's [@Hoenig1983] method support the use of a `r m_prior[1]`
distribution with a median of `r f(exp(as.numeric(m_prior[2])), 2)` and a
standard deviation (in log space) of `r m_prior[3]`. Sensitivity to this prior
has been evaluated extensively in many previous assessments of `r sp`
(see @JTC2013 for a discussion of the historical treatment of natural
mortality and its prior) and is repeated here (see Section
\@ref(sec:assessment-sensitivity-analyses)), including increasing the prior
standard deviation and using an alternative prior distribution altogether
based on a life history meta-analysis [@Hamel2015,HamelCope2022]. This
method used a lognormal prior distribution with a median of 0.22
(based on a maximum age of 25 for `r sp`) and a standard deviation (in log
space) of 0.31. Alternative prior distributions for natural mortality
typically have a significant impact on the model results. But in the absence
of new information on natural mortality there has been little option to update
the prior.

### Steepness {#sec:data-steepness}

The prior for the steepness parameter of the stock-recruitment function is
based on the median (0.79) and the 20th (0.67) and 80th (0.87) percentiles
from the meta-analysis of the family Gadidae [@MyersBowenEtAl1999] and has
been used in U.S. assessments since 2007. This prior has a beta distribution
with parameters 9.76 and 2.80, which translate to a mean of 0.777 and a
log-standard deviation of 0.113. Sensitivities to the variance on the prior
on steepness were evaluated in the 2012 and 2013 assessments
[@JTC2012; JTC2013]. Sensitivities to the mean of the prior are explored in
this assessment (see Section \@ref(sec:assessment-sensitivity-analyses)).

### Variability on fishery selectivity deviations {#sec:data-variability-selectivity}

Time-varying selectivity was introduced in the 2014 assessment [@JTC2014] and
is modeled using annual deviations since 1991 applied to the selectivity-at-age
parameters for the fishery. A normal distribution with a fixed standard
deviation ($\Phi=$ `r sel_phi_val`; see @JTC2018 for justification) is used as
a penalty function to keep deviations from straying far from zero. Selectivity
for age-0 fish is fixed at 0.0 and parameters for ages that are estimated
represent the change in selectivity from the next youngest age. Beyond the age
of 6, age-specific parameters are fixed at zero giving constant selectivity
beyond the last estimated value. The condition that maximum selectivity equals
1.0 results in one fewer degree of freedom than the number of estimated
parameters. Further testing of alternative methods for parameterizing
time-varying selectivity (e.g., @Xu2019) should be investigated in conjunction
with the estimation of additional time-varying parameters.

### Age composition likelihood {#sec:data-age-comp-likelihood}

Since 2018, the assessment has used the linear formulation of the
Dirichlet-multinomial (D-M) likelihood [@ThorsonEtAl2017Dirichlet] to fit the
age-composition data. Estimated parameters $\theta_{\mathrm{fish}}$ and
$\theta_{\mathrm{surv}}$ serve to automatically adjust the weight given to the
fishery- and the survey-composition data, respectively. As of 2021, Stock
Synthesis includes the constant of integration in the likelihood calculation
for the D-M model such that likelihoods are comparable across weighting
methods.

Integration of weighting the composition data within the assessment increases
the efficiency of the assessment process, removes the subjective choice of how
many iterations are required, and ensures that the results of model
sensitivities, retrospective analyses, and likelihood profiles are
automatically tuned, rather than having the age compositions be given the same
weight as the base model. Note that the following description holds for both
the survey data and the fishery data, with $\theta$ equal to
$\theta_{\text{surv}}$ or $\theta_{\text{fish}}$.

The likelihood function for the linear parameterization of the D-M likelihood
(see Equation 10 of @ThorsonEtAl2017Dirichlet) is

\begin{align}
\text{L}(\bm{\pi},\theta|\bm{\tilde{\pi}},n) &= \frac{\Gamma(n+1)}{\prod\limits_{a=1}^{A_{\scriptscriptstyle{\text{max}}}} \Gamma(n\tilde{\pi}_a + 1)} \frac{\Gamma(\theta n)}{\Gamma(n + \theta n)} \prod\limits_{a=1}^{A_{\scriptscriptstyle{\text{max}}}} \frac{\Gamma(n \tilde{\pi}_a + \theta n \pi_a)}{\Gamma(\theta n\pi_a)},
\end{align}

where
$\tilde{\pi}_a$ is the observed proportion at age $a$,
$\pi_a$ is the corresponding expected proportion at age $a$ estimated
by the model,
$\bm{\tilde{\pi}}$ and $\bm{\pi}$ designate the vectors of these proportions,

$A_{\text{max}}$ is the maximum age in the model,
and $n$ is the input sample size. The parameter $\theta$ is defined as a
linear scaling parameter such that $\theta n$ is the variance-inflation
parameter of the D-M distribution. The linear parameterization has been shown
to be superior over the saturation parameterization in simulation testing
[@FischAhrensEtAl2022], and thus corroborates our decision to continue to
use it even though the saturation parameterization is available in Stock
Synthesis.

The effective sample size associated with this likelihood is given by

\begin{align}
n_{\mathrm{eff}} &= \frac{1}{1 + \theta} + \frac{n \theta}{1 + \theta}.
\label{DMeff}
\end{align}

The input sample sizes used in this assessment, which are based on the
number of trips and/or hauls, are large enough that the first term
is insignificant compared to the second term. Consequently,
$\theta / (1 + \theta)$ can be compared to the sample size
multipliers used in the McAllister-Ianelli data-weighting method
[@McAllisterIanelli1997] that was used for assessments prior to 2018
(Table~\@ref(tab:main-assessment-changes)) and
as a sensitivity here (see Section~\@ref(sec:assessment-sensitivity-analyses)).
In short, the McAllister-Ianelli method involves
iteratively adjusting multipliers of the input sample sizes
passed to the multinomial likelihoods until they are
roughly equal to the harmonic mean of the effective sample sizes. The
effective sample size is dependent on how well the model expectation matches
the observed values. Typically, this process involves no more
than four to five iterations.

A uniform prior between $-5$ and $20$ for
$\log \theta_{\text{fish}}$ and $\log \theta_{\text{surv}}$ tends to lead to
inefficient sampling of $\log \theta_{\text{surv}}$ because many
samples occur in a part of the parameter space where the effective sample
size multiplier, $\theta_{\text{surv}} / (1 + \theta_{\text{surv}})$, is
between 0.99 and 1.0 [@JTC2019]. In that area, the input sample sizes given
the uniform prior have full weight and the likelihood surface is almost
completely flat with respect to
$\log \theta_{\text{surv}}$. The current prior on $\log \theta_{\text{surv}}$
can be associated with an approximately uniform prior of the weight
$\theta_{\text{surv}} / (1 + \theta_{\text{surv}})$, where the parameters of
the normal distribution were back-calculated from a uniform distribution with
the bounds of 0 and 1 [@JTC2020]. The normal prior for both
$\log \theta_{\text{fish}}$ and $\log \theta_{\text{surv}}$ has a mean of
`r effn_prior[2]` and a standard deviation of `r effn_prior[3]`.

Composition data can also be weighted using the Francis method (T2.6 in Table
2 of @Francis2011), which is based on variability in the observed ages by
year. This method, like the McAllister-Ianelli method, is iterative, where
the sample sizes are adjusted such that the fit of the expected mean age
should be within the estimated uncertainty at a rate that is consistent with
the variability expected given the effective sample sizes. The Francis method
is known to be sensitive to outliers and prone to convergence issues when
selectivity varies with time. As a result, the Francis method was not
included as a sensitivity.

<!--chapter:end:009-data.rmd-->

\rfoot{Assessment}

# Assessment {#sec:assessment}

## Modeling history {#sec:assessment-modeling-history}

In spite of the relatively short history of fishing, `r sp` have surely been
subject to a larger number of stock assessments than any marine species off the
west coast of the U.S.A.~and Canada. These assessments have included a large
variety of age-structured models. Initially, a cohort analysis tuned to fishery
CPUE was used [@FrancisSwartzmanEtAl1982]. Later, the cohort analysis was
tuned to National Marine Fisheries Service (NMFS) triennial acoustic survey
estimates of absolute biomass at age [@HollowedAdlersteinEtAl1988].
Since 1989, Stock Synthesis models (or base versions of it) fit to
fishery catch-at-age data and acoustic survey estimates of population biomass
and age composition have been the primary assessment method.

While the general form of the age-structured assessment has remained similar
since 1991, modeling procedures have been modified in a variety of ways. There
have been alternative data choices, post-data collection processing routines,
data-weighting schemes, structural assumptions for the stock assessment model,
MCMC sampling algorithms, and control rules 
(Table~\@ref(tab:main-assessment-changes)). Analysts are constantly trying to
improve the caliber and relevance of the assessment by responding to new
scientific developments related to statistics and biological dynamics, policy
requirements, and different or new insights brought up during the peer review
process to ensure a robust stock assessment.

Data processing, filtering, and weighting choices have been modified several
times since the first assessment. For example, modifications to the
target-strength relationship used to scale acoustic data changed in 1997
[@DornSaunders1997], and kriging was implemented to account for the spatial
correlation in the acoustic data in 2010 [@StewartHamel2010]. While survey
data have been the key index for biomass since 1988, surveys that have been
used have varied considerably. The Alaska Fisheries Science Center/Northwest
Fisheries Science Center West Coast Triennial Shelf Survey was used from 1988
before being discarded from the 2009 assessment [@HamelStewart2009]. Acoustic
surveys from the years prior to 1995 were used for assessments in the early
1990s, but @StewartForrestEtAl2011 reviewed these early surveys and deemed
that sampling was insufficient to be comparable with more recent data. Several
recruitment indices have been considered but ultimately none were identified
as adding appreciable contribution to model results [@HelserDornEtAl2002;
@HelserFleischerEtAl2005; @StewartHamel2010], except for the
fishery-independent acoustic-based age-1 index which has been included in the
base model since the 2022 assessment. The process for generating
fecundity-at-age from weight-at-age data changed in 2019 from using
time-invariant to year-specific values. Even where data have been consistently
used, the weighting of these data in the statistical likelihood has changed
through the use of various emphasis factors (e.g., @Dorn1994,
@DornSaundersEtAl1999), a multinomial sample size on age compositions (e.g.,
@DornSaundersEtAl1999, @HelserDornEtAl2002, @HelserFleischerEtAl2005,
@StewartForrestEtAl2011), internal estimations of effective sample size using
the Dirichlet-multinomial distribution [@JTC2018], and assumptions regarding
year-specific survey variance. Since 2021, a more computationally efficient
Bayesian MCMC sampler (No-U-Turn Sampler; NUTS; @HoffmanGelman2014) was used
to estimate posterior distributions [@Monnahan2018; @Monnahan2019], a change
from previous assessments that used the random walk Metropolis Hastings (rwMH)
sampler (details described in @JTC2021). The list of changes discussed above
is for illustrative purposes only and represents a small fraction of the
different choices analysts have made and that reviewers have required.

The structure of the assessment models has perhaps had the largest number of
changes. In terms of spatial models, analysts have considered
spatially explicit forms [@Dorn1994; @Dorn1997], spatially implicit forms
[@HelserStewartEtAl2006], and single-area models [@JTC2012]. Predicted
recruitment has been modeled by sampling historical recruitment (e.g.,
@Dorn1994, @HelserFleischerEtAl2005), using a stock-recruitment
relationship parameterized using maximum sustainable yield ($\text{MSY}$) and
the fishing mortality rate estimated to produce the MSY ($\Fmsy$;
@Martell2010), and using several alternative steepness priors [@JTC2012;
@JTC2013]. Selectivity has also been modeled in several ways: invariant
[@JTC2012; @JTC2013], time-varying with [@HelserDornEtAl2002] and without
[@Dorn1994; @DornSaunders1997; @JTC2012; @JTC2013] a random walk,
alternative levels of allowable deviation through time [@JTC2013; @JTC2017],
age-based [@Dorn1994; @DornSaunders1997; @JTC2012; @JTC2013}, and length-based
[@HelserMartell2007].

Several harvest control rules have been explored for providing catch limits
from stock assessment output. `r sp` stock assessments have presented decision
makers with constant $\mathrm{F}$, variable $\mathrm{F}$, and the following
hybrid control rules: $\FSPRthirtyfive$, $\Fforty$, \Ffortyten,
$\FSPRfortyfive$, \Ffortyfivefortyten, and $\FSPRfifty$ (e.g., @Dorn1996,
@JTC2013). Changes to policies such as the United States' National Standards
Guidelines in 2002 and the \Ffortyten harvest control rule in the Agreement
(Appendix~\@ref(chap:glossary)) have required specific changes to control
rules.

In addition to the examples given above and changes documented in stock
assessments, there have been many more investigations conducted at review
panel meetings. Starting in 2013, the addition of the MSE [@JTC2013; 
@JacobsenEtAl2021] facilitated investigating changes to the modeling
procedure in terms of pre-specified objectives that aim for a sustainable
coast-wide fishery.

## Description of base model {#sec:assessment-base-model}

The `r assess_yr` base model has the same population dynamics structure as the
`r last_assess_yr` assessment's base model. The statistical-catch-at-age model
assumes that the `r sp` population is a single coast-wide stock subject to
one aggregated fleet with combined male and female population dynamics. Stock
Synthesis [@MethotWetzel2013] version `r ss_version` was the modeling platform
used. The largest change between the `r last_assess_yr` and `r assess_yr`
stock assessments is the addition of another year of fishery data into the base
model.

The `r assess_yr` base model includes a time series (1995 to
`r last_survey_yr`) of acoustic age-2$+$ biomass estimates and acoustic
estimates of age-1 fish (see Section~\@ref(sec:data-acoustic-survey) for more
details on the age-1 index). Maturity is assumed to be time-invariant and the
maturity ogive updated in 2018 was retained
(see Section~\@ref(sec:data-maturity)). Fecundity is defined as weight-at-age
multiplied by the maturity ogive and is time-varying across years with
empirical weight-at-age data (`r start_yr_age_comps`--`r last_data_yr`; see
Section~\@ref(sec:data-weight-at-age)). The D-M likelihood approach
[@ThorsonEtAl2017Dirichlet] is again used to estimate the weights associated
with age-composition data, rather than iteratively tuning the sample size
multiplier as in 2017 and earlier assessments (see
Section~\@ref(sec:data-age-comp-likelihood)). Time-varying fishery
selectivity is retained in the `r assess_yr` base model with the magnitude
of the allowable deviations unchanged from the `r last_assess_yr` base model
(see Section~\@ref(sec:data-variability-selectivity)). The general
parameterization of selectivity was retained, although additional parameter
s were required to estimate an additional year of deviations. The selectivity
of the acoustic survey is assumed to be time invariant. Selectivity curves
were modeled as non-parametric functions estimating age-specific values for
each age beginning at age-2 for the index of age-2$+$ biomass and age-1 for
the fishery until a maximum age of 6, after which all ages are assumed to have
the same selectivity. Selectivity for the age-1 index was set to one for age-1
and zero for all other ages.

Prior probability distributions are used for a select few parameters and fixed
values are used for several parameters. For the base model, the instantaneous
rate of natural mortality ($M$) is estimated with a `r m_prior[1]` prior
having a median of `r f(exp(as.numeric(m_prior[2])), 2)` and a standard
deviation (in log-space) of 0.1 (see
Section~\@ref(sec:data-natural-mortality)). The stock-recruitment function is
a Beverton-Holt parameterization, with the log of the mean unexploited
recruitment (log~$R_0$) freely estimated. This assessment uses the same
beta-distributed prior for stock-recruit steepness ($h$), based on
@MyersBowenEtAl1999, that has been applied since 2011
[@StewartForrestEtAl2011]. Year-specific recruitment deviations were estimated
from `r main.recdev.early`--`r main.recdev.end + 1` as well as the years
`r assess_yr - 1`--`r assess_yr + 3` for purposes of forecasting. The standard
deviation, $\sigma_r$, of recruitment variability serves as a recruitment
deviation constraint and is fixed at `r base_model$sigma_R_in` in this
assessment. This value is based on consistency with the observed variability
in the time series of recruitment deviation estimates and is the same as
assumed in assessments from 2013 to `r last_assess_yr`
(Table~\@ref(tab:main-assessment-changes)). Catchabilities associated with the
biomass index ($q_b$) and with the age-1 index ($q_1$) were calculated
analytically as per @LudwigWalters1981 for each sample of posterior parameters,
resulting in a distribution of catchability for each.

Statistical likelihood functions used for data fitting are typical of many
stock assessments. The biomass index was fit via a lognormal likelihood
function, using the observed (and extra 2009) sampling variability, estimated
via kriging, as year-specific weighting. The age-1 index was also specified as
having lognormal error structure. An additional constant and additive standard
deviation on the log-scale component is included for both the biomass index
and the age-1 index, which were freely estimated to accommodate
unaccounted-for sources of process and observation error. A D-M likelihood was
applied to age-composition data, with input sample sizes equal to the sum of
the number of trips and hauls sampled across all fishing fleets or the number
of trawl sets in the research surveys
(see Section~\@ref(sec:data-age-comp-likelihood)).

Model results and statistical inference were based on 
`r f(num_mcmc_samples)` MCMC samples (using the \texttt{adnuts} R package;
@Monnahan2018) to describe posterior distributions for model
parameters and derived quantities. The number of samples used for bridging
models, sensitivity models, and retrospective models was also
`r f(num_mcmc_samples)`. Medians (50% quantiles) are reported together with
the bounds of 95% credibility intervals calculated as the 2.5% quantile and
the 97.5% quantile of posterior distributions from the MCMC samples, to
give equal-tailed intervals. A full explanation of the NUTS algorithm and the
\texttt{adnuts} package, including an analysis with the `r sp` stock can be found
in @Monnahan2019.

## Response to 2022 Scientific Review Group (SRG) review {#sec:assessment-response-review}

The Scientific Review Group (SRG) meeting was held virtually from February
14-17, 2022.

The following are the 'SRG Recommendations and Conclusions for the Stock
Assessment' from the 2022 SRG report and the associated responses from the
JTC:

1. **The SRG notes that $\sigma_R$ is an influential parameter and that
  determining the choice of $\sigma_R$ remains a challenge and encourages the
  JTC to continue to work on the issue.**

> *Response -- Developing best practices for modeling mean unfished
> equilibrium recruitment ($R_0$) and recruitment variability ($\sigma_R$)
> remain broad topics of contemporary research. Recent recommendations
> suggest that the next generation of stock assessment modeling frameworks
> should concomitantly treat recruitment deviations as a random effect and
> estimate $\sigma_R$ [@Punt2020]. The JTC continues to conduct,
> collaborate on, and monitor ongoing research projects concerning
> approaches for advancing recruitment estimation, as applied to `r sp` and
> in general. Many of these issues are widespread in stock assessment and
> scientific-based solutions are likely to be the result of medium to
> long-term research projects. Here, we provide a few updates to our previous
> response on this topic, including specific advances in research endeavors
> where applicable.*

> *The JTC continues to participate in collaborative research to investigate
> the concurrent estimation of multiple variance parameters within stock
> assessments. For `r sp`, this includes the estimation of the variability
> associated with time-varying selectivity ($\Phi$), $\sigma_R$, extra
> standard deviation parameters on index data, and Dirichlet-multinomial
> parameters $\theta_{\text{fish}}$ and $\theta_{\text{surv}}$. In this
> assessment, $\Phi$ and $\sigma_R$ are input as fixed parameters because
> Stock Synthesis uses penalized likelihood and therefore is not formulated
> to estimate random effects. Additionally, estimation of these variance
> parameters using MCMC requires the specification of hyperpriors for which
> there has been little research. The Laplace approximation
> [@ThorsonHicksEtAl2015] was investigated as an alternative means to
> estimate these parameters. However, estimates from this method were large
> and simulation shows them to be biased high. Additional research still
> in its infancy suggests that stock assessment frameworks with the ability
> to estimate random effects internally are better at estimating
> autocorrelated processes than random processes. Next steps for the JTC
> include fitting Stock Synthesis to these same data sets to determine
> best practices when variance parameters cannot be estimated and fitting
> a wide variety of stock assessment frameworks to data when multiple random
> processes are present in the true dynamics.*

> *The Management Strategy Evaluation (MSE) framework for `r sp` creates
> considerable advantages for examining recruitment. The stock assessment
> model in the MSE is written in Template Model Builder (TMB), which
> provides efficient estimation of random effects using the Laplace
> approximation, while being parameterized to mimic many (but currently not
> all) of the pertinent features of Stock Synthesis used in this assessment.
> Thus, the performance of using restricted maximum likelihood to estimate
> $\sigma_R$ [@Thorson2019] can be investigated in terms of management as
> well as statistical performance. Research projects using the MSE framework
> are underway to evaluate the robustness of recruitment modeling
> assumptions and the advantages of including environmentally-driven
> recruitment indices on management performance and uncertainty.  Research
> (under review) by Dr.~Cathleen Vestfals and colleagues at the Northwest
> Fisheries Science Center has identified specific climate drivers associated
> with `r sp` early life-history stages and recruitment and is being used to
> select which environmental variables to fit as an index of recruitment
> within the stock assessment model. Further development of
> environmentally-driven recruitment indices using updated environmental
> predictions is also underway. The utility of fitting to a recruitment index
> will be investigated in terms of forecasting skill and management
> performance within the MSE by the MSE working group.*

> *The number of stock assessment frameworks written in TMB or other
> platforms that allow for the estimation of random effects is increasing.
> These frameworks, specifically the Woods Hole Assessment Model (WHAM;
> @StockMiller2021) and State-Space Assessment Model (SAM;
> @NielsenBerg2014) are both peer reviewed and currently being used for
> management. The JTC has fit WHAM to data on `r sp` and explored the
> estimates of several variance parameters that are currently only explored
> via sensitivity analyses in Stock Synthesis. Next steps include fitting
> data using SAM and using estimates from both frameworks as inputs to Stock
> Synthesis.*

> *The JTC is also following work being conducted by the International
> Council for the Exploration of the Sea (ICES) Methods Working Group which,
> among other things, is looking at meta-analytical approaches for
> estimating recruitment parameters. Results from this work could be used to
> develop informative prior distributions on key recruitment parameters.
> Deliverables were put on hold as a result of COVID-19 but the project
> continues to be making progress.*

2. **The SRG recommends exploring alternative methods to simulate recruitment
in the projections. Although Stock Synthesis currently does not have the
capability to characterize a different process other than the assumed lognormal
distribution, improvements such as drawing from past observations or using a
mixture distribution to simulate recruitment should be considered for modelling
platforms in the future.**

> *Response -- The JTC continues to explore approaches to make informed
> decisions about current and future recruitment in projections. The
> inclusion, and associated justification, of the age-1 index in the 2022
> and 2023 base model is one example of this (see
> Sections~\@ref(sec:data-acoustic-survey) and
> \@ref(sec:assessment-base-model)). Additionally, the JTC is working with
> Dr.~Kristin Marshall to further explore the fit of oceanographic and
> environmental variables identified by Dr.~Cathleen Vestfals as being
> informative about the early life history of `r sp` as indices of
> recruitment within Stock Synthesis. Ongoing research includes expanding
> the variables (originally only amalgamated from 1980--2010) to 2010
> onwards to create a single time series, and investigating relationships
> leading to better informed recent, current, and potential near-term
> forecast recruitment estimates.*

> *Available options in Stock Synthesis for recruitment during the
> projection period are the stock-recruitment curve, the
> stock-recruitment curve with a multiplier, and the mean across a
> user-defined time period. The MSE tool could be used to consider
> alternative recruitment distributional assumptions as future research.
> A member of the JTC is on the development team for NOAA's next
> generation stock assessment modeling platform (Fisheries Integrated
> Modeling System; FIMS), which ensures features such as recruitment
> forecast options will be taken into consideration. Plans are for the
> `r sp` stock assessment to be a test model.*

> *The JTC has requested DFO funding to collaborate with Australian, U.S.,
> and Canadian researchers on developing two potential approaches for
> developing an index of age-0 `r sp`. The first approach is based on the
> method of @SuthersWhiteEtAl2022, who proposed and simulation-tested a
> novel method for estimating growth and mortality of fish larvae based on
> size distributions. In 2022, Suthers visited NOAA's Southwest Fisheries
> Science Center to start applying the method to CalCOFI data (which
> include 1.3 million hake larvae) and compare results to estimates of
> recruitment from the last hake assessment [@JTC2022]. The second approach
> will apply a method proposed by @HinchliffePepinEtAl2019 that
> relates the mortality/growth ratio of larval fish to the slope of the
> zooplankton size spectrum (which characterises the size distribution of
> zooplankton) to quantify the recruitment potential of larval `r sp`. The
> proposed work will support collaborations to work on both approaches, will
> utilise recent improvements in fitting size spectra to data
> [@EdwardsRobinsonEtAl2020], and aims to provide new information on `r sp`
> recruitment.*

> *We also include Figure~\@ref(fig:main-recruitment-scale-all) (as
> developed in the 2022 assessment) which presents a novel approach to
> visualise estimates of recruitment, to avoid misunderstanding of how large
> some recruitment events might be.*

3. `r sp` dynamics are highly variable even without fishing mortality. **The
SRG applauds the efforts of the JTC and the MSE Working Group to add
capabilities for specifying dynamic reference points within the assessment and
MSE platforms, and encourage those groups to work together and develop a
discussion of alternative reference points, including dynamic reference points,
for future SRG consideration.**

> *Response -- The JTC agrees that future reference point discussions
> stemming from simulation work, preferably through the MSE, would be
> beneficial. In particular, the JTC continues to have interest in exploring
> the utility of dynamic reference points. The MSE can now utilize dynamic
> reference points in management procedure scenarios, and Stock Synthesis
> models can now incorporate dynamic reference point capabilities into
> routine stock assessment output. In the coming year, the JTC plans to
> initiate simulations that explore alternative dynamic F-based target
> reference points coupled with static (equilibrium-based) biomass limit
> reference points in exploratory harvest control rule scenarios.*

> *Over the past year, the JTC has continued to engage in research
> activities and outreach related to dynamic reference points broadly, as
> well as specifically for `r sp`.  In particular, the JTC conducted a
> learning session at the summer JMC meeting to promote internal awareness
> and basic understanding of the key concepts, methods, and assumptions
> associated with dynamic reference point calculations. The JTC also engaged
> with external partners, the Western and Central Pacific Fisheries
> Commission science provider (Secretariat of the Pacific Community), to
> learn from their experience developing and applying dynamic reference
> points to operational highly migratory species assessments and management
> plans. Additionally, the JTC is contributing to, and following, updates to
> Canadian and United States national guidance documentation on the
> incorporation of prevailing environmental conditions into stock
> assessments and subsequent management advice (e.g., defining reference
> points).*

4. The SRG encourages work to develop a picture of the `r sp` reproductive
cycle both seasonally and at the life-time scale based on histological and
physiological measurements. In addition, the SRG notes that Canadian
samples and those from the winter research cruises should be included in the
maturity analysis. **The SRG encourages continued sampling and analysis to
improve understanding of the `r sp` reproductive cycle.**

> *Response -- `r sp` ovary samples were not collected over the past year,
> but plans include more sample collections in the coming years. Including
> Canadian samples in subsequent maturity analyses still remains a goal, but
> barriers (lab training, capacity, and moving bio-samples across the border)
> still remain. Research is in-progress by Melissa Head (NWFSC) focusing on
> temporal and spatial trends in hake reproduction. The analysis will include
> over a decade of maturity samples, spanning much of the U.S. West Coast.
> The project aims to evaluate how interannual changes affect size and age at
> maturity across a latitudinal gradient and how the timing of spawning and
> rate of skip spawning differs spatio-temporally. A presentation summarizing
> progress to date and future plans is planned for the SRG meeting.*

> *Research being led by Adam Luckenbach at the Northwest Fisheries Science
> Center looking at physiological indices of fish reproductive and metabolic
> status is expected to bolster the current practice of using gonadal
> histology alone for surveyed `r sp` and provide important data to more
> accurately determine the reproductive cycle of females. Data generated to
> date indicate that two types of lipids, triacylglycerols and
> phospholipids, in the livers of `r sp` are inversely related and
> predictive of sexual maturity in females. Levels of these lipids are also
> considerably shifted when aborted, atretic ovarian follicles are observed,
> suggesting that lipid levels may be predictive of skipped spawning, which
> can reduce the effective female spawning biomass. Data analyses will
> continue in 2023. New developments are expected to inform maturity in
> future `r sp` stock assessments.*

5. **The SRG also recommends continuing to conduct the following
sensitivities: steepness, natural mortality, $\sigma_R$ , excluding the
age-1 index, alternative standard deviations for time-varying selectivity,
and down-weighting fishery age-composition data.**

> *Response -- The JTC has conducted all of the requested sensitivities
> (and many others) and provides summaries in written
> (Section~\@ref(sec:assessment-sensitivity-analyses)), tabular (beginning
> with Table~\@ref(tab:main-parameter-estimates-sens-1)), and graphical
> (beginning with Figure~\@ref(fig:main-biomass-base-alternative-1)) formats
> in this document.*

6. Based on the preliminary results shown, previous assessments have
correctly predicted an increase or decrease in recruitment and female
spawning biomass in subsequent years, although the projections are usually
less definitive than the current base model results. Given that this
analysis provides some confidence in the current expectations of continued
stock decline, **the SRG recommends that the JTC continue to explore and
refine this analysis for future assessments. The SRG encourages the JTC to
explore, with the JMC and AP, the value of a threshold for specifying the
probability of projected declines or increases of the stock in future
assessments.**

> *Response -- The JTC has again updated this analysis to continue comparing
> estimates from the current base model with forecasts from previous
> assessments (Figures~\@ref(fig:main-historical-1)--
> \@ref(fig:main-historical-retro-bforty-all)). Related, the JTC is
> continuing to explore options for improving recruitment estimation and
> predictions (see Responses~1--4 and~7).*

> *The JTC has not had an opportunity to meet with JMC, AP, or the MSE
> working group to explicitly explore threshold values for specifying the
> probability of projected declines or increases of the stock in future
> assessments. This endeavor is well suited for upcoming MSE-related
> performance metrics discussions.*

7. The SRG notes that there are currently multiple strong cohorts in the
stock where previously there was only one strong cohort during the period of
sample collection for the ageing error matrix that supports the assessment
model. **Based on this observation, the SRG recommends that an ageing error
study using samples collected during the past decade be conducted in
conjunction with the Committee of Age Reading Experts (CARE).**

> *Response -- An ageing error study in conjunction with CARE has commenced,
> including planned sample exchanges between United States and Canada ageing
> labs. However, a full exchange remains on hold due to difficulties with
> permits to send biological specimens across the border.*

8. **The SRG recommends that historical sources of data be investigated to
determine whether they can be used to supplement the weight-at-age matrix**,
including unaged otolith samples (and associated data) from the 1970s that
may be available in the Burke Museum in Seattle.

> *Response -- The JTC has conducted analyses previously showing that small
> changes to historical data have little relevance to current management
> quantities of interest. So at this time, the JTC does not expect small
> amounts of historical weight-at-age data to significantly alter stock
> assessment results used for management decisions. The JTC has not had the
> opportunity to visit the Burke Museum in Seattle to ascertain whether
> `r sp` age structures are available and in a usable state.*

9. Uncertainty in weight-at-age is not accounted for in the stock assessment
and a five-year average of recent observations is used for all years of the
projections. **The SRG requests that the JTC explore alternative methods for
forecasting weight-at-age and evaluate whether they can improve projections.**

> *Response -- It is important to capture key, mechanistic, and/or stochastic
> population processes in stock assessment projections to sufficiently
> characterize levels of prediction uncertainty that are consistent with
> available information to adequately contextualize metrics used to aid
> management decisions. Likewise, it is as important to evaluate the basic
> population-dynamics assumptions used in such projections. Recent, current,
> and future recruitment are perhaps the most influential sources of
> uncertainty in stock assessment projections. As a result, the JTC has
> prioritized research on recruitment, including supporting analyses and
> other related analyses mentioned in this section. Over the next few
> years, the JTC plans to work with the MSE working group on a newly funded
> research project aimed at incorporating environmentally-driven growth into
> the operating model and testing consequences of climate-driven changes in
> recruitment, growth, and movement concomitantly.*

> *Empirical weight-at-age data indicate inter-annual variation in `r sp`
> growth, and this variation could be related to individual cohort effects
> (e.g., large cohorts have a negative growth influence on adjacent
> cohorts). The JTC has future plans to explicitly evaluate these
> relationships using random effects models to partition the variance
> components (year and cohort) in available weight-at-age data and to
> explore spatial patterns [@Indiveroetal2023]. This work could rely or
> build upon research currently in progress by a graduate student looking
> at variation in `r sp` weight-at-age data. The JTC also plans to explore
> new weight-at-age forecasting capabilities in Stock Synthesis (once fully
> tested). A simulation experiment that evaluates the influence of variable
> weight-at-age data relative to other sources of variance in stock
> assessment projections (e.g., recruitment) would also be useful. Until
> this work is completed, the JTC continues to use a recent five-year
> average in the projection period because it is consistent with recent data
> (Figures~\@ref(fig:main-empirical-weight-at-age) and
> \@ref(fig:main-weight-at-age-lines)). This assumption is consistent with
> what is allowable within other commonly used stock assessment
> frameworks that accommodate time-varying dynamics.*

10. The parameter weighting the acoustic survey age samples was often
estimated near the upper bound of 1.0 and could not upweight the age samples.
Investigations during the SRG meeting showed that the posterior distribution
of the parameter may have some probability of upweighting the age samples from
the base assessment inputs, although likely had little difference on stock
assessment outcomes. **The SRG encourages the JTC to consider methods to
determine the maximum input sample size for the survey age compositions.
Previous work of @StewartHamel2014 may be useful for this purpose.**

> *Response -- The JTC concurs that determining maximum input sample sizes,
> as well as relative maximums across years, is a worthwhile endeavor.
> Determining appropriate input samples sizes for composition data is a
> long-standing issue with much debate. Progress made for `r sp` will
> undoubtedly provide useful for stock assessment more broadly. The JTC has
> yet to undertake any specific analyses investigating input sample sizes.
> Researchers at the Alaska Fisheries Science Center have recently begun
> similar inquires, indicating that a collaborative approach may be mutually
> beneficial.*

11. The use of high-performance computing (e.g., a dedicated server or cloud
computing) allowed for the complete set of assessment results to be
characterized using MCMC at a minimal cost. **The SRG recommends future use
of high-performance computing to provide complete and thorough assessment
results in a timely manner.**

> *Response -- Resources were made available for the JTC to use a new
> high-performance computing network server with 80 processors to complete
> all model runs (bridging, base, sensitivity, retrospectives, and
> forecasts). Another high-performance server unit and two high-performance
> laptops have also been acquired for completing the `r sp` assessment.
> These resources are used for data preparation, diagnostic examination,
> running test models, and exploring alternative model configurations.*

> *A new server was purchased and used to run all the models and for running
> the software that builds the document. The server has 80 Intel Xeon Gold
> CPUs and 128 GB of RAM and is running Ubuntu Linux version 22.04.1 LTS
> which was the newest stable version at the time of writing. The server was
> set up with user account for each JTC member, with a remote desktop server
> (X-Remote Desktop Protocol; XRDP) running for easy access. All connections
> were through a 4096-bit passwordless Secure SHell (SSH) and the server was
> otherwise locked down from a security standpoint. The entire server is
> automatically backed up on a mirrored RAID device once per day, with model
> input files also backed up to a Google drive. If everything were lost the
> models could be re-run very quickly and the document regenerated in full.*

> *Scripts were written in the Bash shell scripting language to allow
> operating system level control and monitoring over parallel model runs.
> Each run was also parallelized internally with 16 chains per model; that
> parallelism was controlled from within R using the \texttt{future} and
> \texttt{furrr} packages. With each model needing 16 CPUs, the JTC were able to
> run 4 models at a time, taking up 64 CPUs and leaving 16 available for use
> in writing and building the document. The total runtime for these models
> is now on the order of 1-3 hours, depending on the CPU and memory load on
> the server at the time.*

> *The server setup allowed all JTC members to work together in a way not
> possible before. This integrated setup will ensure an ideal workflow in
> the coming years, with a centralized system housing all model runs and
> document software.*

12. The SRG appreciates the investigation of alternative model structures,
including alternative modelling platforms. **The SRG encourages the JTC
to continue these types of investigations.**

> *Response -- The JTC continues to explore the implementation of a
> hake-like assessment in WHAM and SAM, in addition to the custom TMB
> estimation model used in the MSE, to evaluate the impact of
> platform-specific configurations, assumptions, and capabilities.*

13. **The SRG appreciates the dedication and teamwork displayed by the JTC
in producing the best available scientific information and advice on the
Pacific Hake stock during the COVID-19 pandemic.**

> *Response -- Teamwork and collaboration is an attribute of great interest
> and pride within the JTC, and we believe it is fundamental to successfully
> achieving the science objectives as outlined in the Agreement.*

## Modeling results {#sec:assessment-modeling-results}

### Changes from `r last_assess_yr` {#sec:assessment-changes}

A set of `bridging' models was constructed to evaluate the component-specific
effects of the steps to change from the `r last_assess_yr` base model to
the `r assess_yr` base model. The steps are:

- Update to the latest version of Stock Synthesis, version `r ss_version`, to
follow current best practices;
- Add new catch data for `r last_data_yr` and update historical catches;
- Add weight-at-age data for `r last_data_yr` and update historical
weight-at-age data;
- Add fishery age-composition data for `r last_data_yr` and update historical
fishery age-composition data.

Stock Synthesis version `r ss_version` includes a number of changes since the
version used by @JTC2022. Changes relevant to this assessment include a fix to
the forecasting module that ensures weight-at-age information in the first
year of the forecast is as specified rather than carried forward from the
previous year. This fix was implemented and used in the `r last_assess_yr`
assessment for all forecasts provided to management. Additional changes were
made to Stock Synthesis to ensure models that use empirical weight-at-age data
do not report tables in the output that use growth parameters because even
though growth parameters are not used they must still be provided as
placeholders in the input files. Adaptations within the Stock Synthesis
modeling framework itself had little effect on parameter estimates compared to
the `r last_assess_yr` base model and thus no effect on resulting time series
(Figure~\@ref(fig:main-bridge-5-panel-1).

The update of pre-`r last_data_yr` data occurs because databases are
continually updated; this yielded minor adjustments to the data. Samples that
were recently aged but not available for the `r last_assess_yr`
assessment were included. These changes to pre-`r last_assess_yr` data were
small enough that they had little impact on the model results and are thus
combined with steps that add data from the `r last_data_yr`.

The addition of the `r last_data_yr` catch data extends the model to the start
of `r assess_yr`. Recruitment estimates and historical stock trajectory were
relatively unchanged, and the new data suggest a slight increase in female
spawning biomass from `r assess_yr - 1` to `r assess_yr`
(Figure~\@ref(fig:main-bridge-5-panel-1)). Adding the weight-at-age data for
`r last_data_yr` makes little change, though slightly increases the estimated
female spawning biomass (Figure~\@ref(fig:main-bridge-5-panel-1)).

<!-- Include survey update here -->
The final step added the fishery age-composition data for `r last_data_yr`,
which shifted the ending year of the deviations in the selectivity parameters
from `r last_data_yr - 1` to `r last_data_yr`. These data had relatively
little impact on the historical biomass estimates, but did shift recent
recruitment estimates (Figure~\@ref(fig:main-bridge-5-panel-1)).
The estimated 2019 recruitment decreased, while the estimated large 2020
cohort was shifted even larger. The increase in 2020 recruitment contributes
to a considerable increase in female spawning biomass by the start of
`r assess_yr`, as these fish are considered mostly mature at the start of
`r assess_yr`. Despite both fishery age compositions and the relative age-1
index pointing towards a strong 2020 cohort, estimates of `r assess_yr` female
spawning biomass remain highly uncertain, largely due to underlying
uncertainty in recent recruitment (Figure~\@ref(fig:main-bridge-5-panel-1)).
Uncertainty related to the 2020 cohort should decrease once these fish have
been observed by the acoustic survey and the fishery during
`r last_data_yr + 1`.

### Assessment model results {#sec:assessment-model-results}

**Model Fit**

Stationarity of the posterior distribution for model parameters was assessed
via a suite of standard single-chain and multi-chain diagnostic tests
via graphical summaries and interactive web applications
([ShinySTAN](https://mc-stan.org/users/interfaces/shinystan)).
Key diagnostic figures are given in Appendix~\@ref(chap:mcmc-diagnostics) and
now discussed. All estimated parameters showed good mixing during sampling,
no evidence for lack of convergence, and acceptable autocorrelation (results
for some key parameters are shown in
Figures~\@ref(fig:main-mcmc-diag-m-r0)--\@ref(fig:main-mcmc-diag-dm)).
Correlation-corrected effective sample sizes were sufficient to summarize the
posterior distributions and neither the Geweke nor the Heidelberger and Welch
statistics for these parameters exceeded critical values more frequently than
expected via random chance (Figure~\@ref(fig:main-mcmc-diag-hists)). The
Gelman-Rubin multi-chain diagnostic test, which compares within-chain variance
to among-chain variance, further indicated that convergence was adequately
achieved (examined via \texttt{ShinySTAN}). Correlations among key parameters were
generally low, with the exception of $M$ and $\log R_0$
(Figure~\@ref(fig:main-mcmc-pairs)). Estimates of recruitment in 2014 and 2016
were correlated with the derived quantity of catch from the default harvest
rule in `r end_yr`, as to be expected given the dependencies among these
quantities (Figure~\@ref(fig:main-mcmc-pairs)). An examination of deviations
in recruitment (log-scale differences between estimated and expected
recruitment values) from recent years
(Figure~\@ref(fig:main-mcmc-pairs-recruit-devs)) indicates the highest
correlation
(`r round(cor(base_model$mcmc$Main_RecrDev_2014,base_model$mcmc$Main_RecrDev_2016),2)`)
was between the 2014 and 2016 recruitment deviations. This is an increase in
correlation relative to the last assessment despite the fact that each cohort
has been observed for an additional year.

Regarding the Dirichlet-multinomial parameter $\theta_{\text{fish}}$,
the estimate (median and 95% credible interval) for
$\log \theta_{\text{fish}}$ is `r log_theta_fishery_median`
(`r log_theta_fishery_lower`, `r log_theta_fishery_upper`), giving an
effective sample size multiplier
$\theta_{\text{fish}} / (1 + \theta_{\text{fish}})$ of
`r dm_weight_fishery_median` (`r dm_weight_fishery_lower`,
`r dm_weight_fishery_upper`).
The related survey age-composition parameter $\theta_{\text{surv}}$ has
\protect{$\log \theta_{\text{surv}}$} estimated as
`r log_theta_survey_median` (`r log_theta_survey_lower`,
`r log_theta_survey_upper`), and the resulting effective sample size
multiplier $\theta_{\text{surv}} / (1 + \theta_{\text{surv}})$ of
`r dm_weight_survey_median` (`r dm_weight_survey_lower`,
`r dm_weight_survey_upper`).

The base model fit to the acoustic survey biomass index
(Figure~\@ref(fig:main-mcmc-survey-fit)) remains similar to the
`r last_assess_yr` base model, which is not surprising given no new survey
information is available for this assessment. For the
`r last_assess_yr` base model the `r survey_end_yr` survey biomass estimate
resulted in a slight upward shift in the fit to the `r penult_survey_yr`
survey data points, but the result of a relatively stable biomass trend from
2013--2019 remained unchanged from the previous assessment. At the time, the
addition of the 2021 fishery data was the main reason for this change in fit
to the 2019 data point. The 2021 survey estimate was lower than in 2019
(second lowest since 2013), and the model fit indicates a slight decline in
biomass from 2019 to 2021. The 2001 survey biomass index continues to be well
below any model predictions that were evaluated, and no direct cause for this
is known.  The survey did begin earlier that year than all other surveys
between 1995 and 2009 (Table~\@ref(tab:main-survey-history)), which may
explain some portion of the anomaly, along with El Ni\~no conditions and age
structure. The underestimation of the 2009 biomass estimate is larger than
the underestimation of any other year. The uncertainty of this point (both 
modeled and actual) is high because of the presence of large numbers of
Humboldt Squid during the survey. Humboldt Squid have similar target
strength to hake which could introduce bias in the biomass estimate for that
year, and which also likely influenced hake population dynamics through
predation in that year.

The median posterior density estimates from the fit to the survey were less
than the 2015 survey index, greater than the 2017 and 2019 survey indices,
and closely fit the 2021 index (Figure~\@ref(fig:main-mcmc-survey-fit)).
This is likely due to slight differences in what the fishery composition data
and survey composition data, when considered independently, would otherwise
suggest as population trends. Additionally, the population has undergone
recent high, but declining, catch levels and produced a couple of
above-average cohorts that are now mature.

The base model fit to the index of age-1 fish highlights an overall general
confirmation of relative cohort strength 
(Figure~\@ref(fig:main-mcmc-age1-fit)). In particular, the 2008 and 2014
cohorts were estimated to be less than the index, while the 1994 and 2016
cohorts were estimated to be larger than indicated by the index. The age-1
fish in 2011 (the large 2010 cohort) was closely fit.  Age-1 fish in 2021
(2020 cohort) were estimated slightly above the index value and, being so
young, include a large amount of uncertainty. The model indicates that the
2020 cohort may be similar in size to the 2014 cohort, based on information
in the age-1 index, age-1 fish caught in the 2021 fishery, and from age-2
fish caught in the 2022 fishery. The high age-1 survey index from 2021 is
largely in concurrence with oceanographic conditions, as summarized in
NOAA's annual Ecosystem Status Report of the California Current
[@HarveyGarfieldEtAl2021]. Recruitment is generally impacted by oceanographic
conditions both during maternal preconditioning and during egg and larval
stages. During maternal preconditioning (spring-fall, 2019) upwelling
conditions were variable but near average [@HarveyGarfieldEtAl2020]. Weaker
upwelling conditions are associated with higher `r sp` recruitment during this
phase (Vestfals et al., under review). During egg and larval phases (2020),
ocean conditions were broadly associated with high productivity across many
taxa [@HarveyGarfieldEtAl2021]. These conditions were marked by strong winter
upwelling which brings nutrients to coastal waters, cooler temperatures, an
energy-rich copepod community, and high productivity of krill, a key food
source for `r sp` [@BuckleyLivingston1997; @HarveyGarfieldEtAl2021].

Fits to the age-composition data continue to show close correspondence to the
dominant and small cohorts observed in the data when the data give a
consistent signal (Figure~\@ref(fig:main-age-comp-fits)). Because of the
time-varying fishery selectivity, the fit to commercial age-composition data
is particularly good, although models with time-invariant selectivity used in
previous years also fit the age compositions well. In the `r last_data_yr`
fishery, `r top_coh(base_model, last_data_yr, 3, cap = FALSE)`. Age
compositions from the `r survey_end_yr` acoustic survey suggest a similar age
structure for older fish. The 2020 cohort has not yet been observed by the
acoustic survey. Combined, the 2015--`r last_data_yr` fishery age-composition
data and the 2017--`r survey_end_yr` acoustic survey age-composition data
suggest that 2014 was a strong recruitment year, and the model was able to
adequately fit to these observations (Figure~\@ref(fig:main-age-comp-fits)).
The 2016 cohort, which has been observed twice by the survey, still appears
to be smaller than the 2014 cohort. The `r survey_end_yr` survey was the first
to sample the `r survey_end_yr - 2` cohort, confirming that it was not large
(`r survey_a2_prop`% of the `r survey_end_yr` survey catch). The 2020 cohort,
which has been observed twice by the fishery, once by the age-1 index, but
not the acoustic survey is currently expected to be above average in size.
Residual patterns to the fishery and survey age data do not show patterns
that would indicate systematic bias in model predictions
(Figure~\@ref(fig:main-age-comp-pearson)).

The median estimates for numbers, biomass, exploitation rate, and catch (in
numbers and in biomass) for each age class in each year are given in
Tables~\@ref(tab:main-est-numbers-at-age)--
\@ref(tab:main-est-catch-at-age-biomass).
For the major cohorts, the resulting estimated age-specific catch, natural
mortality, and surviving biomasses are given in
Table~\@ref(tab:main-cohort-effects). For example, the catch weight of the
2014 cohort at age-5 was slightly less than that of the 2010 cohort at age-5
and the resulting surviving biomass of the 2014 cohort was approximately half
of the surviving biomass of the 2010 cohort.

Posterior distributions for both steepness and natural mortality are
influenced by priors (Figures~\@ref(fig:main-prior-posterior)--
\@ref(fig:main-prior-posterior-truncated)). The posterior for steepness is
only slightly updated by the data, as expected given the low level of
information available to inform steepness as found in previous hake
assessments. The posterior of natural mortality, on the other hand, is shifted
to the right of the prior distribution and the prior may be constraining the
posterior distribution from shifting further. Broadening the prior
distribution by increasing the prior standard deviation for the natural
mortality parameter is examined in sensitivity runs (see
Section~\@ref(sec:assessment-sensitivity-analyses)). Other parameters showed
updating from diffuse priors to posterior distributions, including
$\theta_{\text{fish}}$ and  $\theta_{\text{surv}}$ (as outlined in
Section~\@ref(sec:data-age-comp-likelihood)).

The `r assess_yr` base model specified the same level of variation (standard
deviation of $\Phi = `r sel_phi_val`$) associated with time-varying fishery
selectivity as the `r last_assess_yr` base model, effectively allowing the
model flexibility (i.e., a lower penalty on the overall likelihood) to fit to
data that suggests high variability among years for each age. This level of
variation led to results that remained consistent with the `r survey_end_yr`
acoustic survey biomass estimate and gave reasonable fits to the fishery
age-composition data, given that there is considerable uncertainty associated
with spatial changes in fish availability (due to movement) and recent
variability in oceanographic conditions. Estimated selectivity deviations for
age-3 and age-4 fish are larger from 2010 to 2012 than in subsequent years
until 2020 when the deviation for age-4 was large again
(Figures~\@ref(fig:main-tv-selex) and \@ref(fig:main-tv-selex-uncertainty)).
The median selectivity peaks at age-4 in 2010, 2012 and 2020 and at age-3 in
2011 suggesting targeting (or generally higher availability) of the younger
cohorts in those years. This pattern is consistent with the 2008 cohort
appearing strong in the fishery age compositions initially, but decreasing in
prominence from 2013 onward (Figure~\@ref(fig:main-age-comp-fits)). Fishery
selectivity on age-2 fish was at its highest in 2016. Fishery selectivity for
the most recent year was characteristic by a logistic pattern, where
selectivity generally increased smoothly from age 3 to a peak at age 6 and
older ages (Figure~\@ref(fig:main-tv-selex-uncertainty)). However, age-2
selectivity was slightly higher than for other younger fish, likely as a
result of increased availability of the above-average 2020 cohort. Even
though the survey selectivity is time invariant, the posterior shows a broad
band of uncertainty between ages 2 and 5
(Figure~\@ref(fig:main-tv-selex-uncertainty-lines)). The decline in survey
selectivity between ages 3 and 4 may be an artifact of the interaction between
large cohorts and the biennial timing of recent surveys, with the 2010, 2014,
and 2016 cohorts occurring in the survey at ages 3 and 5 but not age 4.
Fishery selectivity is likewise very uncertain
(Figures~\@ref(fig:main-tv-selex-uncertainty) and
\@ref(fig:main-tv-selex-uncertainty-lines)), but in spite of this uncertainty,
changes in year-to-year patterns in the estimates are still evident,
particularly for age-2, age-3, and age-4 fish, though these patterns might
also reflect time-varying mortality processes.

#### Stock biomass {-}

The base stock assessment model indicates that, since the 1960s, `r sp` female
spawning biomass has ranged from well below to above unfished equilibrium
(Figures~\@ref(fig:main-female-spawning-biomass) and
\@ref(fig:main-relative-spawning-biomass) and
Tables~\@ref(tab:main-median-posterior) and \@ref(tab:main-ci-posterior). The
model estimates that it was below the unfished equilibrium in the 1960s, at
the start of the assessment period, due to lower than average recruitment. The
stock is estimated to have increased rapidly and was above unfished
equilibrium in the mid-1970s and mid-1980s (after two large recruitments in
the early 1980s). It then declined steadily to a low in 1999. This was
followed by a brief increase to a peak in 2002 as the very large 1999 year
class matured. The 1999 year class largely supported the fishery for several
years due to relatively small recruitments between 2000 and 2007. With the
aging 1999 year class, median female spawning biomass declined throughout the
late 2000s, reaching a time-series low of `r median_bio_min` million~t in
`r median_bio_min_yr`. The assessment model estimates that median female
spawning biomass then peaked again in 2013 and 2014 due to a very large 2010
year class and an above-average 2008 year class. The subsequent decline from
2014 to 2016 is primarily from the 2010 year class surpassing the age at
which gains in weight from growth are greater than the loss in weight from
mortality (growth-mortality transition). The 2014 year class is estimated to
be large, though not as large as the 1999 and 2010 year classes, resulting
in an increased biomass in 2017. The estimated biomass was relatively steady
from 2017 to 2019, and then declined in 2020 and 2021 due to the 2014 and
2016 year classes moving through the growth-mortality transition during a
period of high catches. The increase in female spawning biomass since 2021 is
due to the expected above average 2020 cohort entering maturity and the recent
declining trend in catch.

The median estimate of the `r end_yr` relative spawning biomass (spawning
biomass at the start of `r end_yr` divided by that at unfished equilibrium,
$B_0$) is `r curr_depl_median`%. However, the uncertainty is large, with a
95% posterior credibility interval from `r curr_depl_lower`% to
`r curr_depl_upper`% (Tables~\@ref(tab:main-median-posterior) and
\@ref(tab:main-ci-posterior), due to remaining unknowns about the size of the
2020 cohort because the acoustic survey only provided one year of age-1
information, which is more uncertain than the 2+ estimate.

The median estimate of the `r end_yr` female spawning biomass is
`r curr_bio_median` million~t (with a 95% posterior credibility interval from
`r curr_bio_lower` to `r curr_bio_upper` million~t). The current estimate of
the `r end_yr - 1` female spawning biomass is `r prev_bio_median`
(`r prev_bio_lower`--`r prev_bio_upper`) million~t. This is a somewhat higher
median and broader credibility interval than the
`r prev_bio_median_last_assess` (`r prev_bio_lower_last_assess`--
`r prev_bio_upper_last_assess`) million~t estimated in the `r end_yr - 1`
assessment, but there is considerable overlap of the credibility intervals.
The increase appears to be due to the addition of 2022 fishery age
composition data, which suggests the 2020 cohort may be larger than the age-1
index alone was indicating in the last assessment (as outlined in 
Section~\@ref(sec:assessment-changes)).

**Recruitment**

The new data for this assessment do not significantly change the pattern of
recruitment estimated in recent assessments. However, estimates of absolute
recruitment for the most recent years can change with new data. For example,
this assessment's median estimate of the 2020 recruitment is
`r f(((recruitment_med_to_compare - prev_assess_recruitment_med)["2020"]), 1)`~billion
fish higher than in the last assessment
(a `r f(((((recruitment_med_to_compare - prev_assess_recruitment_med)["2020"]) /
(prev_assess_recruitment_med)["2020"]) * 100), 0)`% increase).
Similarly, estimates for 2019 and 2021 recruitments have changed by
`r f(((((recruitment_med_to_compare - prev_assess_recruitment_med)["2019"]) /
(prev_assess_recruitment_med)["2019"]) * 100), 0)`%
(`r f((recruitment_med_to_compare - prev_assess_recruitment_med)["2019"], 1)`~billion fish) and
`r f(((((recruitment_med_to_compare - prev_assess_recruitment_med)["2021"]) /
(prev_assess_recruitment_med)["2021"]) * 100), 0)`%
(`r f(((recruitment_med_to_compare - prev_assess_recruitment_med)["2021"]), 1)`~billion fish),
respectively, but the general notion remains that recent recruitment is highly uncertain.

`r sp` have low average recruitment with occasional large year classes
(Figures~\@ref(fig:main-recruitment) and \@ref(fig:main-recruitment-devs),
Tables~\@ref(tab:main-median-posterior) and \@ref(tab:main-ci-posterior)).
Very large year classes in 1980, 1984, and 1999 supported much of the
commercial catch from the 1980s to the mid-2000s. From 2000 to 2007, estimated
recruitment was at some of the lowest values in the time series, but this was
followed by an above average 2008 year class. The very strong 2010 year class
comprised `r top_coh(base_model, 2014, ret_cohort = 2010)`% of the coast-wide
commercial catch in 2014,
`r top_coh(base_model, 2016, ret_cohort = 2010)`% of the 2016 catch,
`r top_coh(base_model, 2018, ret_cohort = 2010)`% of the 2018 catch,
`r top_coh(base_model, 2020, ret_cohort = 2010)`% of the 2020 catch, and
`r top_coh(base_model, 2022, ret_cohort = 2010)`% of the 2022 catch.
The decline from 2014 to 2016 was partly due to the large influx of the 2014
year class (`r top_coh(base_model, 2016, ret_cohort = 2014)`% of the 2016
catch was age-2 fish from the 2014 year class; this was larger than the
proportion of age-2 fish, `r top_coh(base_model, 2012, ret_cohort = 2010)`%,
from the 2010 year class in 2012).

The current assessment also estimates a strong 2014 year class
(Figure~\@ref(fig:main-numbers-at-age)) comprising
`r top_coh(base_model, 2016, ret_cohort = 2014)`% of the 2016 catch,
`r top_coh(base_model, 2017, ret_cohort = 2014)`% of the 2017 catch,
`r top_coh(base_model, 2018, ret_cohort = 2014)`% of the 2018 catch,
`r top_coh(base_model, 2019, ret_cohort = 2014)`% of the 2019 catch,
`r top_coh(base_model, 2020, ret_cohort = 2014)`% of the 2020 catch
`r top_coh(base_model, 2021, ret_cohort = 2014)`% of the 2021 catch, and
`r top_coh(base_model, 2022, ret_cohort = 2014)`% of the 2022 catch.
The 2016 cohort also appears to be above average, comprising
`r top_coh(base_model, 2018, ret_cohort = 2016)`% of the 2018 catch,
`r top_coh(base_model, 2019, ret_cohort = 2016)`% of the 2019 catch,
`r top_coh(base_model, 2020, ret_cohort = 2016)`% of the 2020 catch, and
`r top_coh(base_model, 2021, ret_cohort = 2016)`% of the 2021 catch, and
`r top_coh(base_model, 2022, ret_cohort = 2016)`% of the 2022 catch.
The absolute size of the 2014 year class has now stabilized after observations
across eight years of fishery observations and three acoustic surveys. The
2016 year class is estimated to be above average (similar in size to the 2008
year class) from six years of fishery data and two years of survey data.
Since 2020, the model currently estimates small 2011, 2013, 2015, 2018, 2019,
and 2021 year classes (median recruitment well below the mean of all median
recruitments) and near average 2012 and 2017 year class. With the addition of
the age-1 index, there is information beyond just fishery encounters in the
data to estimate the size of the 2020 year class. Collectively, these data
indicate that the 2020 year class is likely well above average. The much
smaller 2019 year class is informed by the `r last_survey_yr` biomass index
and fishery data, but has no age-1 index, and the 2021 year class is only
informed by fishery data. There is no information in the data to estimate the
sizes of the `r end_yr-1` and `r end_yr` year classes. Retrospective analyses
of year class strength for young fish have shown the estimates of recent
recruitment to be unreliable prior to at least model age-3 (observed at age-2)
without a survey in the most recent year and age-2 (observed at age-1) with a
survey. While the 2020 cohort was observed by the age-1 index in 2021, it
will not be observed by the acoustic survey until 2023.

From Figure~\@ref(fig:main-recruitment) it looks as though the 2014
recruitment could be as large as the 2010 recruitment. However, the assessment
model estimates a `r prob_percent_2014_rec_gt_2010_rec`% chance that this
could be the case. The overlapping of the credible intervals in
Figure~\@ref(fig:main-recruitment) is because large MCMC estimates of 2010
recruitment are associated with large estimates of 2014 recruitment
(presumably with large estimates of $R_0$). By scaling all recruitments by
the 2010 recruitment, Figure~\@ref(fig:main-recruitment-scale-all) provides
an intuitive way to compare recruitment across years (see Appendix~H of
@JTC2022 for motivation and full methods). It shows that there have only been
two historical recruitment events (1980 and 1984) that might be as large as
in 2010, whereas Figure~\@ref(fig:main-recruitment) suggests that 1970, 1999
and 2014 could also possibly be larger than in 2010, giving an over-optimistic
impression of how often we can expect cohorts the size of the 2010 cohort to
occur. The 2020 cohort is still very uncertain but has a
`r prob_percent_2020_rec_gt_2010_rec`% chance of exceeding the 2010 cohort,
while the 2021 cohort is definitely smaller than the 2010 cohort
(Figure~\@ref(fig:main-recruitment-scale-all)). Participants in the `r sp`
process have an intuition that the 2010 is a very large recruitment event --
Figure~\@ref(fig:main-recruitment-scale-all) shows how it is the largest for
at least 30 years, and that such large cohorts are rarer than is inferred
from Figure~\@ref(fig:main-recruitment).

The estimated recruitments with uncertainty for each year and the overall
stock recruit relationship are provided in
Figure~\@ref(fig:main-mcmc-sr-variability). Extremely large variability about
the expectation and about the joint uncertainty of individual recruitment and
female spawning biomass pairs are evident. High and low recruitments have
been produced throughout the range of observed female spawning biomass
(Figure~\@ref(fig:main-mcmc-sr-variability)). The standard deviation of the
time series of median recruitment deviation estimates for the years 1970--
`r last_data_yr - 1`, which are informed by the age compositions and the
age-1 index, is `r sd_med_recr_dev_estimates`.

**Exploitation status**

The median estimated relative fishing intensity on the stock is below
$\Fforty$ for all years (Figure~\@ref(fig:main-fishing-intensity) and
Tables~\@ref(tab:main-median-posterior) and \@ref(tab:main-ci-posterior)).
It was close to $\Fforty$ in 2008 and 2010, but harvest in those years did
not exceed the catch limits that were specified, based on the best available
science and harvest control rules in place at the time. Exploitation fraction
(catch divided by biomass of fish of age-2 and above) has shown relatively
similar patterns (Figure~\@ref(fig:main-exploitation-fraction) and
Tables~\@ref(tab:main-median-posterior) and \@ref(tab:main-ci-posterior)).
Although displaying similar patterns, the exploitation fraction does not
necessarily correspond to fishing intensity because fishing intensity more
directly accounts for the age-structure of both the population and the catch.
Median relative fishing intensity is estimated to have declined from
`r median_intensity_2010`% in 2010 to `r median_intensity_2015`% in 2015, and
then it leveled off around 70% from 2016 to 2019 before declining to
`r median_intensity_2022`% in 2022. The median exploitation fraction has
increased from a recent low of `r exploitation_med_2012` in 2012 to
`r exploitation_med_2017` in 2017 where it remained relatively stable before
dropping back to 2012--2015 levels in 2022. Although there is a considerable
amount of imprecision around these recent estimates due to uncertainty in
recruitment and spawning biomass, the 95% posterior credibility interval of
relative fishing intensity was below $\Fforty$ from 2012 through 2016 and
again from 2019 to 2022 (Figure~\@ref(fig:main-fishing-intensity)). The
median estimate for 2017 and 2018 is below $\Fforty$ though the 95%
posterior credibility interval does include $\Fforty$.

**Management performance**

Over the last decade (`r end_yr - 10`--`r end_yr - 1`), the mean coast-wide
utilization rate (i.e., proportion of catch target removed) has been
`r tot_last_10_yrs_attainment`% and catches have been below coast-wide
targets (Table~\@ref(tab:main-landings-tac)). From `r end_yr - 5` to
`r end_yr - 1`, the mean utilization rates differed between the United States
(`r us_last_5_yrs_attainment`%) and Canada (`r can_last_5_yrs_attainment`%).
In 2015, the utilization rate for the coast-wide fishery was the lowest of
the previous decade (`r tot_2015_attainment`%) due, in part, to difficulties
locating aggregations of fish and possibly economic reasons. Before 2015,
the under-utilization in the United States was mostly a result of unrealized
catch in the tribal apportionment, while reports from stakeholders in Canada
suggested that hake were less aggregated in Canada and availability had
declined. In 2016, the utilization rate increased but remained below pre-2015
levels, despite the total 2016 catch being one of the highest of the preceding
years. This is in large part due to increasing catch targets as biomass
continues to increase. While the total utilization rate between 2017--2021 was
relatively steady and close to the average over the last decade
(`r tot_last_10_yrs_attainment`%), it decreased in 2022 to
`r tot_last_yr_attainment`%. This is primarily due to the utilization rate in
Canada declining since 2020 to a time-series low of 20.3% in 2022.
Country-specific quotas (or catch targets) in 2020 and 2021 were specified
unilaterally, due to the lack of an agreement on coast-wide 2020 and 2021
TACs. The usual `r us_allotment_percent`% and `r can_allotment_percent`%
allocation of coast-wide TAC, as specified in the Joint U.S.-Canada
Agreement for `r sp`, was once again implemented in 2022.
Total landings last exceeded the coast-wide quota in 2002 when utilization
was 112%.

As noted above, the median relative fishing intensity was below $\Fforty$
in all years. The median relative spawning biomass was above the $\Bforty$
reference point in all years except 2007--2010
(Table~\@ref(tab:main-median-posterior) and
Figure~\@ref(fig:main-relative-spawning-biomass)).
These are also shown on a phase plot of the joint history of relative
spawning biomass and relative fishing intensity (Figure~\@ref(fig:main-phase)).
Relative spawning biomass increased from the lows in 2007--2010 with above
average recruitment in 2008, 2010, 2014, 2016, 2017, and 2020.
Correspondingly, relative fishing intensity has remained well below $\Fforty$,
and total catch has been declining since the time series high in 2017. While
there is large uncertainty in the `r end_yr-1` estimates of relative fishing
intensity and relative spawning biomass, the model estimates a
`r joint_percent_prob_above_below`% joint probability of being both above the
$\Fforty$ relative fishing intensity in `r end_yr - 1` and below the $\Bforty$
relative spawning biomass level at the start of `r end_yr`.

## Model uncertainty {#sec:assessment-model-uncertainty}

The base assessment model integrates over the substantial uncertainty
associated with several important model parameters including: biomass
index and age-1 index catchabilities ($q_b$ and $q_1$, respectively), the
magnitude of the stock (via the $R_0$ parameter for equilibrium recruitment),
productivity of the stock (via the steepness parameter, $h$, of the
stock-recruitment relationship), the rate of natural mortality ($M$), annual
selectivity for key ages, recruitment deviations, and survey and fishery data
weights (via the Dirichlet-multinomial parameters
$\theta_{\text{fish}}$ and $\theta_{\text{surv}}$).

The medians of the key parameters from the posterior distribution are
similar to those in last year's base model
(Table~\@ref(tab:main-parameter-estimates)). The largest change was a doubling
of the 2020 cohort size. Medians of some of the derived quantities also change
somewhat; in particular, recruitment in 2019 and 2015 decreased
(39% and 11%, respectively) from those estimated in the `r assess_yr - 1`
assessment.

The `r sp` stock displays a very high degree of recruitment variability,
perhaps the largest of any west coast groundfish stock, resulting in large and
rapid biomass changes. This volatility, coupled with a dynamic fishery that
potentially targets strong cohorts (resulting in time-varying selectivity)
will in most circumstances continue to result in highly uncertain
estimates of current stock status and even less-certain projections of the
stock trajectory. This is particularly true for female spawning biomass
estimates in `r assess_yr` and throughout the current forecast period, because
there is considerable uncertainty associated with the size of the 2020 year
class, now mostly mature, that propagates into forecasts. Further
observations of this year class, including during the 2023 acoustic survey,
will help to refine these estimates and reduce uncertainty. The addition of
the age-1 index in this assessment will, in some cases, help to reduce this
uncertainty (as it currently does in this case; see
Figure~\@ref(fig:main-recruit-base-alternative-2) discussed later). However,
further work is needed to improve upon the characterization of uncertainty
in the age-1 index itself, which is based on a time invariant assumption
about index observation error and catchability.

Uncertainty measures in the base model underestimate the total uncertainty in
the current stock status and projections, because they do not account for
alternative structural models for hake population dynamics and fishery
processes (e.g., recruitment, selectivity, or spatial fleet or population
structure), the effects of alternative data-weighting choices, survey
catchability, and the scientific basis for prior probability distributions. To
address structural uncertainties, the JTC investigated a range of alternative
models, and we present the key sensitivity analyses along with other
informative sensitivity analyses using full MCMC results
(Section~\@ref(sec:assessment-sensitivity-analyses)).

%We also present an appendix showing results for the sensitivity model that
excludes %the age-1 survey index (Appendix~\@ref(chap:age1-survey)). The
exclusion of the age-1 %survey model was chosen because it matches the
model structure of the base assessment model.

The JTC continues to be committed to advancing MSE analyses, by coordinating
research with the `r sp` MSE Working Group and other scientists in the region
engaged in similar research. Incorporating feedback from the
Working Group and stakeholders will ensure that operating models will be able
to provide insight into the important questions defined by interested parties.
Specifically, the development of MSE tools will evaluate major sources of
uncertainty relating to data, model structure and the harvest policy for this
fishery, and will compare potential methods to address them. In the coming
years, this will include a host of research evaluations (see
Section~\@ref(sec:assessment-response-review) and
Section~\@ref(sec:research)), including evaluating the utility of
incorporating environmentally-driven age-0 recruitment indices into the stock
assessment.

## Reference points {#sec:assessment-reference-points}

The term 'reference points' is used throughout this document to describe
common conceptual summary metrics. The Agreement specifically identifies
$\Fforty$ as the default harvest rate and $\Bforty$ as a point where the
40:10 TAC adjustment is triggered (see the Glossary in
Appendix~\@ref(chap:glossary)).

We report estimates of the base reference points (e.g., $\Fforty$, $\Bforty$,
$\Bmsy$, and MSY) with posterior credibility intervals in
Table~\@ref(tab:main-reference-points). The median of the female spawning
biomass at $\Fforty$ (namely the median of $\BSPRforty$) and the median yield
at $\Fforty$ have remained about the same as estimates in the
`r last_assess_yr` assessment (Table~\@ref(tab:main-parameter-estimates)).

As part of the DFO Sustainable Fisheries Framework, @DFO2009 defined a limit
reference point as being a biomass below which serious harm is believed to be
occurring to the stock, and an upper stock reference point above which the
stock is considered to be healthy. These would equate to the Agreement
reference points of $\Bten$ and $\Bforty$ (the female spawning biomass being
10% and 40%, respectively, of the unfished equilibrium female spawning
biomass). The probabilities of the female spawning biomass at the start of
`r assess_yr` being above each of these points are
P$(\mathrm{B}_{`r assess_yr`} > \Bten) = `r probs_curr_b10`$% and
P$(\mathrm{B}_{`r assess_yr`} > \Bforty) = `r probs_curr_b40`$%
such that the stock is estimated to be in the 'healthy zone' (above the upper
stock reference point of $\Bforty$). This probability was higher than in last
year's assessment, where the equivalent calculation was
P$(\mathrm{B}_{`r assess_yr - 1`} > \Bforty) = 90.5$%. Note that a probability
of '100%' (or '0%') is based on the MCMC results, and is not meant to imply
that something definitely occurs (or definitely does not occur).

With respect to DFO's provisional limit reference point of $0.4\Bmsy$ and
provisional upper stock reference point of $0.8\Bmsy$, the probabilities are
P$(\mathrm{B}_{`r assess_yr`} > 0.4\Bmsy) = `r f(dfo_probs_curr[1, 2], 0)`$%
and
P$(\mathrm{B}_{`r assess_yr`} > 0.8\Bmsy) = `r f(dfo_probs_curr[1, 3], 1)`$%
such that the stock is estimated to be in the provisional `healthy zone'.
For completeness, we note that
P$(\mathrm{B}_{`r assess_yr`} > \Bmsy) = `r f(dfo_probs_curr[1, 1], 1)`$%.

Reference levels of stock status that are used by the U.S. Pacific Fisheries
Management Council (PFMC) for `r sp` include $\Bforty$ and a Minimum Stock
Size Threshold (MSST) of $\Btwentyfive$. For `r min(forecast_yrs)`, the
estimated posterior median relative spawning biomass is
`r curr_depl_median`%, such that the female spawning biomass is well above
$\Bforty$ and $\Btwentyfive$. The probability that female spawning biomass
at the beginning of `r assess_yr` is above $\Bforty$ is
P$(\mathrm{B}_{`r assess_yr`} > \Bforty) = `r probs_curr_b40`$% (as noted
above), and of being above $\Btwentyfive$ is
P$(\mathrm{B}_{`r assess_yr`} > \Btwentyfive) = `r probs_curr_b25`$%.

## Model projections {#sec:assessment-model-projections}

The catch limit for `r min(forecast_yrs)` based on the default \Ffortyten
harvest policy has a median of `r ct_limit_quantiles["median"]`~t and a wide
range of uncertainty (Figure~\@ref(fig:main-projected-catch-density)), with the
95% credibility interval being `r ct_limit_quantiles["lower"]`--
`r ct_limit_quantiles["upper"]`~t.

Decision tables give projected population status (relative spawning biomass)
and relative fishing intensity under different catch alternatives for the base
model
(Tables~\@ref(tab:main-decisions-biomass) and~\@ref(tab:main-decisions-spr)).
The tables are organized such that the projected outcome for each potential
catch level and year (each row) can be evaluated across the quantiles
(columns) of the posterior distribution. The tables use the new format
demonstrated by @JTC2021 arising from discussions at the 2021 SRG meeting.
Table~\@ref(tab:main-decisions-biomass) shows projected relative spawning
biomass outcomes, and Table~\@ref(tab:main-decisions-spr) shows
projected fishing intensity outcomes relative to $\Fforty$ (based on SPR;
see table legend).

Population dynamics and governing parameters assumed during the forecast
period include random recruitment; selectivity, weight-at-age and fecundity
averaged over the five most recent years (`r assess_yr - 5`--
`r assess_yr - 1`); and all estimated parameters constant (at their
estimates for each particular MCMC sample).

Relative fishing intensity exceeding 1 (or 100% when shown as a percentage)
indicates fishing in excess of the $\Fforty$ default harvest rate limit.
This can happen for the median relative fishing intensity in
`r forecast_yrs[1:(length(forecast_yrs) - 2)]` and
`r forecast_yrs[(length(forecast_yrs) - 1)]` because the $\Fforty$ default
harvest-rate catch limit is calculated using baseline selectivity-at-age
(1966--1990; prior to time-varying deviations), whereas the forecasted
catches under the default harvest-rate are removed using selectivity averaged
over the last five years. Recent changes in selectivity could be reflected
in the projection of over- or under-fishing relative to the desired $\Fforty$
rate.

Key management metrics are presented for
`r forecast_yrs[2:(length(forecast_yrs) - 1)]` and
`r forecast_yrs[length(forecast_yrs)]`
projections (Tables~\@ref(tab:main-risk-year-1)--
\@ref(tab:main-risk-year-3) and
Figures~\@ref(fig:main-forecast-depletion-comparison)--
\@ref(fig:main-forecast-risk-comparison-year-3)). These metrics summarize the
probability of various outcomes from the base model given each potential
management action. Although not linear, probabilities can be interpolated from
this table for intermediate catch values in `r assess_yr`
(Table~\@ref(tab:main-risk-year-1) and
Figure~\@ref(fig:main-forecast-risk-comparison-year-1)). However,
interpolation may not be applicable for all catches in `r assess_yr + 1` and
`r assess_yr + 2` because they are conditional on previous year(s) catch
levels. This explains why a few probabilities decline (rather than rise) with
increased `r assess_yr + 1` and `r assess_yr + 2` catch levels in
Tables~\@ref(tab:main-risk-year-2) and~\@ref(tab:main-risk-year-3) and
Figures~\@ref(fig:main-forecast-risk-comparison-year-2)
and \@ref(fig:main-forecast-risk-comparison-year-3).

Figure~\@ref(fig:main-forecast-depletion-comparison) shows the projected
relative spawning biomass trajectory through
`r forecast_yrs[length(forecast_yrs)]` for several of these management
actions. With zero catch for the next three years, the biomass has a
`r zero_catch_prob_bio_down_1`% probability of decreasing from
`r forecast_yrs[1]` to `r forecast_yrs[2]` (Table~\@ref(tab:main-risk-year-)
and Figure~\@ref(fig:main-forecast-risk-comparison-year-1)), a
`r zero_catch_prob_bio_down_2`% probability of decreasing from
`r forecast_yrs[2]` to `r forecast_yrs[3]` (Table~\@ref(tab:main-risk-year-2)
and Figure~\@ref(fig:main-forecast-risk-comparison-year-2)), and a
`r zero_catch_prob_bio_down_3`% probability of decreasing from
`r forecast_yrs[3]` to `r forecast_yrs[4]` (Table~\@ref(tab:main-risk-year-3)
and Figure~\@ref(fig:main-forecast-risk-comparison-year-3)).

The probability of the female spawning biomass decreasing from `r end_yr` to
`r end_yr + 1` is above 72% for all non-zero catch levels examined
(Table~\@ref(tab:main-risk-year-1) and
Figure~\@ref(fig:main-forecast-risk-comparison-year-1)). It is 81% for the
`r end_yr` catch level similar to that for `r end_yr - 1`
(catch alternative~f). For all explored catches, the maximum probability of
the female spawning biomass dropping below $\Bten$ at the start of
`r end_yr + 1` is near 0%, at the start of `r end_yr + 2` is 1%, and at the
start of `r end_yr + 3` is 4% (Tables~\@ref(tab:main-risk-year-1)--
\@ref(tab:main-risk-year-3) and
Figures~\@ref(fig:main-forecast-risk-comparison-year-1)--
\@ref(fig:main-forecast-risk-comparison-year-3)). The similar maximum
probability of dropping below $\Bforty$ at the start of `r end_yr + 1` is 10%,
at the start of `r end_yr + 2` is 24%, and at the start of `r end_yr + 3`
is 35%. As the large 2010, 2014, and 2016 cohorts continue to age, their
biomass is expected to decrease as losses from mortality continue to outweigh
increases from growth. The estimated above-average 2020 cohort has already
begun to play a large role in determining female spawning biomass during the
forecast years presented here.

It should be noted that forecasted biomass is not only influenced by catch
levels. As the large 2010 and 2014 cohorts continue to age, their biomass
will continue to decrease (Tables~\@ref(tab:main-est-biomass-at-age) and
\@ref(tab:main-cohort-effects)) as losses from mortality outweigh increases
from growth. The smaller above-average 2016 cohort entered this
growth-mortality transition period around 2019
(Tables~\@ref(tab:main-est-biomass-at-age) and
\@ref(tab:main-cohort-effects)). The below-average 2015 and 2018 cohorts
will contribute much less to forecasted spawning biomass than the larger
cohorts. During 2023, the age-3 2020 cohort will likely move through the
growth-mortality transition and thus no longer contribute to an increase
in total biomass (note that fecundity will increase which will influence
the exact change in female spawning biomass, Figure~\@ref(fig:main-maturity)).

The age composition (in numbers) of the catch in `r forecast_yrs[1]` is
projected to be (using MCMC medians)
`r fore_catch_prop$Age3`% age-3 fish from the `r forecast_yrs[1] - 3` cohort,
`r fore_catch_prop$Age7`% age-7 fish from the `r forecast_yrs[1] - 7` cohort,
`r fore_catch_prop$Age6`% age-6 fish from the `r forecast_yrs[1] - 6` cohort,
`r fore_catch_prop$Age9`% age-9 fish from the `r forecast_yrs[1] - 9` cohort,
and only
`r fore_catch_prop$Age13`% age-13 fish from the large `r forecast_yrs[1] - 13`
cohort (Figure~\@ref(fig:main-age-comp-forecast)). However, those estimates
are highly uncertain with the 95% credibility interval for the age-3 fraction
spanning `r f(fore_catch_prop_age3_lower)`%--
`r f(fore_catch_prop_age3_upper)`%.

Due to the higher average weight of older fish compared to younger fish, the
median expected proportion of the `r forecast_yrs[1]` catch by weight
is `r f(fore_catch_prop_wt_age3_median)`% for the age-3
`r forecast_yrs[1] - 3` cohort (compared to `r fore_catch_prop$Age3`% by
numbers) and `r f(fore_catch_prop_wt_age7_median)`%
for the age-7 `r forecast_yrs[1] - 7` cohort
(compared to `r fore_catch_prop$Age7`% by numbers;
Figure~\@ref(fig:main-age-comp-forecast)).

With respect to the DFO reference points, with the largest 
`r assess_yr` catch of `r largest_next_catch`~t given in
Table~\@ref(tab:main-risk-year-1), at the start of `r assess_yr + 1` the
stock is expected to be above the critical zone with a probability of
P$(\mathrm{B}_{`r assess_yr + 1`} > \Bten) = `r prob_next_over_b10`$%
and in the healthy zone with a probability of
P$(\mathrm{B}_{`r assess_yr + 1`} > \Bforty) = `r prob_next_over_b40`$%.
With respect to the DFO provisional reference points (based on $\Bmsy$), the
stock is expected to be above the provisional critical zone with a probability
of
P$(\mathrm{B}_{`r assess_yr + 1`} > 0.4\Bmsy) = `r dfo_prob_next_over_40bmsy`$%,
in the healthy zone with a probability of
P$(\mathrm{B}_{`r assess_yr + 1`} > 0.8\Bmsy) = `r dfo_prob_next_over_80bmsy`$%,
and above $\Bmsy$ with a probability of
P$(\mathrm{B}_{`r assess_yr + 1`} > \Bmsy) = `r dfo_prob_next_over_bmsy`$% for
this catch.

With respect to PFMC stock size reference points, a level of `r assess_yr`
catch consistent with the Agreement default harvest control rule
(`r next_treaty_catch`~t) has a `r pfmc_prob_next_yr_below_b40`% estimated
probability of resulting in the biomass going below $\Bforty$ at the start of
`r assess_yr + 1` (and `r pfmc_prob_next_yr_below_b25`% probability of going
below $\Btwentyfive$; Table~\@ref(tab:main-risk-year-1)).
If catches in `r assess_yr` and `r assess_yr + 1` are the same as in
`r assess_yr - 1` (`r same_catch_as_last_yr`~t,
catch scenario~`r letters[ct_actual_ind]`)
then the probability of the biomass going below $\Bforty$ is
`r same_catch_prob_next_year_below_b40`% for the start of
`r assess_yr + 1` and
`r same_catch_prob_yr_after_next_below_b40`% for the start of
`r assess_yr + 2`.

## Sensitivity analyses {#sec:assessment-sensitivity-analyses}

Sensitivity analyses were conducted to investigate influence of data inputs
and structural uncertainty of the base model by investigating how changes to
the model affected the estimated values and derived quantities. All
sensitivity analyses compared MCMC posteriors that were created using the
\texttt{adnuts} R package [@Monnahan2018; @Monnahan2019] to implement the NUTS
algorithm with a similar number of posterior samples as the base model.
Several key underlying structural model assumptions were identified that have
persisted across many previous hake assessments, and thus warrant revisiting
annually as a set of reference sensitivity examinations to new base models.
Many additional sensitivity runs were conducted when developing and testing the
`r assess_yr` base model. Here we focus on the main sensitivities which,
relative to the base model, are:

1. Consideration of higher standard deviations on the prior distribution for
natural mortality;

1. Consideration of an alternative prior distribution (mean and standard
deviation) for natural mortality based on the @Hamel2015 and @HamelCope2022
life history meta-analytic method;

1. Consideration of an alternative prior distribution and a fixed value for
steepness, to change the resiliency of the stock;

1. Assumption of higher and lower variation about the stock-recruitment curve
($\sigma_r$);

1. Removal of the age-1 index as a data source;

1. Downweighting the fishery age-composition data; and

1. Consideration of alternative standard deviations for time-varying
selectivity.

Comparisons of the parameter estimates between the main sensitivity models
with those from the base model are shown in
Tables~\@ref(tab:main-parameter-estimates-sens-1)--
\@ref(tab:main-parameter-estimates-sens-2). None of the sensitivities resulted
in any substantial departure from the main population dynamics of the base
model. All sensitivity models showed large estimated increases in female
spawning biomass in the early- to mid-2010s that continues to be driven by the
2010, 2014, and 2016 cohorts, followed by several years of steady decline
(2019--2021) before increasing again due to the strong 2020 cohort. All
sensitivity models indicate that `r assess_yr` relative spawning biomass is
above $\Bforty$. The overall scale of the population was impacted by various
alternative assumptions, and the highly uncertain size of the recent cohorts
were more variable across sensitivity analyses than earlier cohorts which have
been observed for more years.

Figures~\@ref(fig:main-biomass-base-alternative-2) and
\@ref(fig:main-recruitment-base-alternative-2). In general, the estimated
population dynamics are similar, regardless of extrapolation, throughout most
of the time series. However, there is some divergence in recent year 
estimates; e.g., the estimated relative spawning biomass in `r end_yr` is
`r f(100 * sens_models[[2]][[1]]$derived_quants["Bratio_2016","Value"],1)`%
for the base model (with extrapolation) and
`r f(100 * sens_models[[2]][[2]]$derived_quants["Bratio_2016","Value"],1)`%
for the model without extrapolation. The 2016 default harvest control catch
limit coming from the base model is
`r f(sens_models[[2]][[1]]$derived_quants["ForeCatch_2016","Value"])`~t
compared to
`r f(sens_models[[2]][[2]]$derived_quants["ForeCatch_2016","Value"])`~t
for the model using no extrapolation (using MLE values).

The standard deviation of the prior distribution on natural mortality was
increased from the base model value of 0.1 to 0.2 and 0.3. The median of the
MCMC posteriors for natural mortality increased from
`r f(nat_m[2], 3)` with a 95% credible interval of `r f(nat_m[1], 3)`--
`r f(nat_m[3], 3)` for the base model (prior standard deviation of 0.1) to
`r f(nat_m_03[2], 3)` with a 95% credible interval of
`r f(nat_m_03[1], 3)`--`r f(nat_m_03[3], 3)` for the sensitivity run with the
prior standard deviation set to 0.3
(Table~\@ref(tab:main-parameter-estimates-sens-1)). The @HamelCope2022 prior
model estimated natural mortality at `r f(nat_m_hamel[2], 3)` with a 95%
credible interval of `r f(nat_m_hamel[1], 3)`--`r f(nat_m_hamel[3], 3)`
(Table~\@ref(tab:main-parameter-estimates-sens-1)). In addition to allowing a
higher estimated value for natural mortality, these $M$ sensitivity models
increased the overall scale of the population, the estimated stock status
relative to $B_0$ prior to 1990, the uncertainty in female spawning biomass on
both absolute and relative scales, halved estimated relative fishing intensity
in `r end_yr - 1`, and doubled equilibrium yield at $\BSPRforty$
(Table~\@ref(tab:main-parameter-estimates-sens-1) and
Figures~\@ref(fig:main-biomass-base-alternative-1) and
\@ref(fig:main-status-base-alternative-1)).

The mean of the prior distribution on steepness was decreased from 0.777
(base) to 0.5 and, separately, steepness was fixed at 1.0. The decrease in
the mean of the prior resulted in a decrease in the MCMC estimate of steepness
from a median of `r f(steep[2], 3)` with a 95% credible interval of
`r f(steep[1], 3)`--`r f(steep[3], 3)` to a median of
`r f(steep_prior_05[2], 3)` with a 95% credible interval of
`r f(steep_prior_05[1], 3)`--`r f(steep_prior_05[3], 3)`
(Table~\@ref(tab:main-parameter-estimates-sens-1)). However, neither steepness
sensitivity analysis had a large impact on the overall model results
(Figures~\@ref(fig:main-biomass-base-alternative-1) and
\@ref(fig:main-status-base-alternative-1)), because `r sp` female spawning
biomass has remained above levels where changes in steepness would appreciably
influence stock-recruit dynamics (Figure~\@ref(fig:main-mcmc-sr-variability)).

The value of $\sigma_r$ was changed from a value of `r sigma_r` (base) to
alternative high (`r sigma_r_sens[2]`) and low (`r sigma_r_sens[1]`) states.
Both sensitivities were similar to the base model in that the calculated
standard deviation of recruitment deviations (from the main period) was
higher than the input $\sigma_r$, i.e., `r sigma_r_lo_main` and
`r sigma_r_hi_main` when $\sigma_r$ was `r sigma_r_sens[1]` and
`r sigma_r_sens[2]`, respectively. Where, in theory the calculated standard
deviation should match the input value used for $\sigma_r$. However, the high
$\sigma_r$ model had a larger difference between the female spawning biomass
at unfished equilibrium and the female spawning biomass at the initial year of
the model than the low $\sigma_r$ model
(Figure~\@ref(fig:main-status-base-alternative-1)). Similar to previous
assessments, estimates of unfished equilibrium recruitment and relative
spawning biomass are sensitive to $\sigma_r$, whereas absolute estimates of
female spawning biomass are relatively insensitive. The method
@MethotTaylor2011 proposed to tune $\sigma_r$ was developed in the context of
maximum likelihood estimation and not Bayesian inference, where the latter
potentially allows for estimating $\sigma_r$ using random effects, and thus,
this proposed method is not used here to tune the fixed input value.

The sensitivity of the base model to the removal of the age-1 index provides
a comparative evaluation of how the base model incorporates information
about juvenile fish. Compared to the base model, estimates of female spawning
biomass throughout most of the time series are similar, but do diverge near
the end of the time series
(Table~\@ref(tab:main-parameter-estimates-sens-1),
Figures~\@ref(fig:main-biomass-base-alternative-2) and
\@ref(fig:main-status-base-alternative-2)). The `r end_yr` estimates of
relative spawning biomass are `r f(100 * bratio_curr[2], 1)`% for the base model
(95% credible interval of `r f(100*bratio_curr[1], 1)`--
`r f(100 * bratio_curr[3], 1)`%) and `r f(100 * bratio_age1[2], 1)`%
for the removal of the age-1 index model (95% credible interval of
`r f(100 * bratio_age1[1], 1)`--`r f(100*bratio_age1[3], 1)`%). This
difference is due to the age-1 index providing additional information on
recruitment for cohorts associated with recent age-1 indices (i.e., 2018 and
2020 cohorts detected in the 2019 and 2021 age-1 indices). In particular, the
base model with the age-1 index suggests that the 2020 year class is estimated to
be large, but not as large as the 2021 and 2022 fishery data alone (i.e.,
removing the age-1 index) would otherwise suggest
(Figure~\@ref(fig:main-biomass-base-alternative-2)). Removing the age-1 index
led to minor changes in fit to the age-2+ survey biomass index, with 2019
showing a slight improvement and 2021 a deterioration compared to the base
model (Figure~\@ref(fig:main-index-base-alternative-2)).

The base model includes a Dirichlet-multinomial likelihood component, which
uses two estimated parameters to automatically weight each of the fishery and
survey age compositions. The base model was compared to a sensitivity model
that downweighted the fishery age compositions relative to the survey age
compositions. The data weighting used in the sensitivity model was based on
the McAllister-Ianelli method. This method requires manual iterative
adjustments to the input sample sizes using a derived multiplier. The
McAllister-Ianelli method, which was used in assessments prior to 2018
(Table~\@ref(tab:main-assessment-changes)), attempts to make the arithmetic
mean of the input sample size approximately equal to the harmonic mean of the
effective sample size. The McAllister-Ianelli method suggested a weighting
factor of 0.14 and 0.46 (ratio of 0.30) for fishery and survey age
compositions, respectively. The median estimate from Dirichlet-multinomial
method used in the base model was `r dm_weight_fishery_median` and
`r dm_weight_survey_median` (ratio of
`r f(as.numeric(dm_weight_fishery_median) / as.numeric(dm_weight_survey_median),2)`).
Downweighting fishery composition data using the McAllister-Ianelli method
led to minor changes in relative spawning biomass, recruitment estimates, and
increased uncertainty in estimates of early recruitments compared to the base
model (Figures~\@ref(fig:main-status-base-alternative-2) and
\@ref(fig:main-recruit-base-alternative-2)).

The degree of flexibility of annual variation in the fishery selectivity was
tested using three sensitivities which set alternative values of the $\Phi$
parameter (Figures~\@ref(fig:main-biomass-base-alternative-4)--
\@ref(fig:main-index-base-alternative-4)). The consideration of alternative
standard deviations ($\Phi$) for time-varying selectivity is discussed earlier
in Section~\@ref(sec:data-variability-selectivity). Changing the values of the
parameter $\Phi$ controlling the flexibility in time-varying selectivity from
the base model value of $\Phi = 1.40$ to alternative values of 0.21, 0.70,
and 2.10, did not appreciably influence the estimates, or precision,
associated with recruitment in 2014, but it did impact more recent
recruitments (Figure~\@ref(fig:main-recruit-base-alternative-4)). In
particular, recruitment estimates for 2016 and 2020 are linked to the choice
of $\Phi$, where the model with the smallest $\Phi$ (0.21) estimates the 2016
and 2020 recruitment deviation as the highest of the $\Phi$ sensitivity
models (Figure~\@ref(fig:main-recruit-devs-base-alternative-4)),
leading to a large increase in female spawning biomass in recent years
compared to the base model
(Figure~\@ref(fig:main-biomass-base-alternative-4)).
The value $\Phi = 0.21$ also provides the worst fit to the most recent age-2+
survey biomass index (Figure~\@ref(fig:main-index-base-alternative-4)).

## Retrospective analyses {#sec:assessment-retrospective-analyses}

Retrospective analyses were performed by iteratively removing the terminal
years' data (going back 10 years) and estimating the posterior distribution of
parameters under the assumptions of the base model. This year's base model
shows similar retrospective results to last year's
(Figure~\@ref(fig:main-retrospective-recruitment), @JTC2022).
The addition of the age-1 index in last year's base model found estimates
of recruitment strength to come closer to the long-term stable estimate by
age-2 in some cases compared to the model without the age-1 index [@JTC2022].
However, some cohort recruitments are still over or under-estimated at age-2.
Over-estimation can be seen most clearly with the 2014, 2015, 2017, and 2018
cohorts (Figures~\@ref(fig:main-retrospective-recruitment) and
\@ref(fig:main-relative-retrospective-recruitment)). The 2014 cohort reached
a high deviation after two years, then even higher after three years only to
drop back down to a lower value and then stabilize at around age-4 with the
addition of more data. A similar pattern can be seen with the smaller 2017 and
2018 cohorts. Even with the addition of new data, the size of the very small
2015 cohort has not fully stabilized. Under-estimation is slight, but
apparent, for the 2016 cohort as recruitment estimates have risen since the
estimate at age-3. Cohort strength is further informed once at least one year
of age-2+ survey biomass index age-composition data are available for a
cohort, which for even-numbered recruitment years typically does not occur
until the cohort reaches age-3, due to the acoustic survey occurring in odd
years; though the age-1 index does provide some information.

The stability of the recruitment estimates seen in this plot is also evident
in the uncertainty estimates of each cohort. Uncertainty of the 2016--2019
cohorts has been substantially reduced compared to removing five years of
data (Figure~\@ref(fig:main-biomass-recruitment-retrospective), bottom
figure). However, the uncertainty of the 2020 cohort has actually increased
with the addition of another year of fishery data compared to last year's
base model. Medians of various quantities of interest are given in
Table~\@ref(tab:main-parameter-estimates-retro).

Overall, there is little retrospective change to the relative spawning biomass
trajectory up to the mid-2010s, and most retrospective change occurs in the
final years of the retrospective model with the most years removed
(Figure~\@ref(fig:main-biomass-recruitment-retrospective)). In this
assessment, there is very little retrospective bias, with only slight
year-specific positive and negative bias in female spawning biomass, some
minor adjustments to recruitment deviates, and a slight trend in $B_0$ as the
retrospective year increases. All of these retrospective differences are well
within the range of estimation uncertainty across all retrospective years.
There is no indication from retrospective evaluations that the base model is
displaying a systematic bias.

A comparison of the actual assessment models used in each year since
`r min(assess_history_df$Year, na.rm = TRUE)` is shown in
Figure~\@ref(fig:main-historical-assessments). There have been substantial
differences in the structural assumptions of the models and, thus, results
submitted each year. The variability between model results, especially
early on in the time series, is larger than the uncertainty (95%
credibility interval) reported from any single model in recent years. Prior
to 2004, survey catchability was fixed at 1.0 and this assumption was
heavily investigated between 2004 and 2007, leading to variability in model
results because of the use of several different, but fixed, values of survey
catchability. Since 2008, catchability has been freely estimated by the model
($q$ = `r base_model$extra_mcmc$Q_vector %>% median() %>% f(2)`). The fixing
of survey catchability had the effect of driving the estimate of initial
biomass upward, which in turn scaled the entire biomass trajectory up,
leading to higher estimates of relative spawning biomass than in more recent
assessments. The median estimates of female spawning biomass for recent years
have remained similar to the previous assessment but declined relative to the
2015--2017 assessments. The difference is most likely related to the recent
under-fitting of the 2017 survey estimate of biomass despite the consistency
in the structure of the assessment model in recent years. In addition to more
information about the 2014 and 2016 cohorts, the 2018 assessment model also
included a change in the data weighting method, an update to maturity and
fecundity, and a change to selectivity parameterization
(Table~\@ref(tab:main-assessment-changes)). The uncertainty interval
associated with the `r end_yr` assessment brackets the majority of the
historical estimates.

The level of uncertainty associated with each assessment's estimate of that
year's current female spawning biomass (i.e., that used to convey current
stock status and inform management advice) changes from assessment to
assessment given updates in data and `r sp` population structure and
dynamics. While uncertainty around the absolute amount of 2023 female
spawning biomass is the second largest (behind the 2017 assessment) since
2012, the relative amount of dispersion (or variability relative to the
stock size; similar to a coefficient of variation) is not inconsistent with
previous assessments (Figure~\@ref(fig:main-historical-dispersion)).

## Performance of past projections {#sec:assessment-past-projections}

Without rigorous simulation experiments it can be difficult to operationally
assess the accuracy of projections in stock assessments because the truth is
never known with 100% certainty. For `r sp`, hindsight comparisons have been
conducted since 2021 [@JTC2021] to evaluate performance of projections
provided in decision tables (such as Tables~\@ref(tab:main-risk-year-1) and~\@ref(tab:main-risk-year-2)) of past assessments relative to updated
assessments. Overall, results indicate that assessment model projections give
a relatively good idea of general projected trends and status.

As an example, the 2019 assessment [@JTC2019] gave the estimated probability
of the female spawning biomass declining in the subsequent year,
i.e.,~P($\mathrm{B}_{2020} < \mathrm{B}_{2019}$), for several possible catches
in 2019, such as 0~t, 180,000~t, 350,000~t, 410,000~t etc. Now that we 'know'
the catch in 2019 was 412,015~t, we can select the 410,000~t row (close
enough to 412,015~t) in the table from the 2019 assessment to give that
assessment's
P$(\mathrm{B}_{2020} < \mathrm{B}_{2019}) =$ `r prob_decline_from_2019_to_2020_historic`%;
Figure~\@ref(fig:main-historical-1). We can also calculate this probability
from the current assessment model, which implicitly includes the
412,015~t catch from 2019, giving
P$(\mathrm{B}_{2020} < \mathrm{B}_{2019}) =$ `r prob_decline_from_2019_to_2020_curr`%;
Figure~\@ref(fig:main-historical-1). We extracted similar probabilities
from past assessment documents going back to 2012 and calculate analogous
probabilities,
P$(\mathrm{B}_{t+1} < \mathrm{B}_{t})$, from the current base model
(Figure~\@ref(fig:main-historical-1); see @JTC2022 for full methods).

Each assessment correctly predicted whether the stock would increase or
decrease the following year (except for 2018 and 2021;
Figure~\@ref(fig:main-historical-1)). Estimates from previous assessments
are closer to 50% than those from the current base model (except for 2021;
Figure~\@ref(fig:main-historical-1)), because the current assessment model
has more information and thus provides a more definitive probability (closer
to 0% or to 100%) than year $t$'s assessment model. It is desirable that the
probabilities from the assessment documents are not too definitive (too close
to 0% or to 100%), because they are admitting a wide range of uncertainty
given unknown recent recruitments.

The 2018 and 2021 assessments 'incorrectly' projected the stock would likely
decline the following year (given the catch that subsequently occurred),
because the current assessment model estimates a likely increase
(Figure~\@ref(fig:main-historical-1)). In 2018, this occurred because the
biomass trend was relatively flat
(Figure~\@ref(fig:main-female-spawning-biomass)) so even slight changes in
biomass could influence binomial outcomes of an 'increase' or 'decrease' in
biomass, despite the overall change in biomass not being very substantial. The
2021 assessment [@JTC2021] had no information on the 2020 cohort and predicted
the biomass would probably decline in 2022 even with zero catch in 2021.
However, the current assessment estimates that the 2020 cohort was
particularly large, which highlights how impactful a realized large deviation
from average recruitment (rather than assuming average recruitment) can be
on forecasted outcomes. Similarly, the 2012 assessment had no information on
the very large 2010 recruitment, and so also over-estimated the probability
of decline the following year (Figure~\@ref(fig:main-historical-1)).

A range of catch alternatives are shown for the current assessment because
realized `r assess_yr` catches are not yet known
(Figure~\@ref(fig:main-historical-1)). Catching zero fish in `r assess_yr`
gives the lowest probability that the stock will decline from `r assess_yr`
to `r assess_yr + 1`, with any realistic `r assess_yr` catch leading to a
likely decline in female spawning biomass given current information.

A similar approach was used to calculate the probability of the biomass
falling below $\Bforty$ in the subsequent year,
i.e.,~P$(\mathrm{B}_{t+1} < \Bforty)$; Figure~\@ref(fig:main-historical-2).
The 2012 assessment was the only one that gave a $>50%$ chance of the
biomass falling below $\Bforty$ in the subsequent year, but later data
determined that the 2010 year class was indeed substantial and so in
hindsight the probability of going below $\Bforty$ was 0% (based on the
current assessment). Since the 2018 assessment, the estimated probabilities
of the biomass falling below $\Bforty$ were $>10%$ and continued to rise (Figure~\@ref(fig:main-historical-2)), until falling due to the
incoming 2020 cohort. Note that the biomass has been relatively high
during the time period shown, so 'correctly expecting' the biomass to remain
$>\Bforty$ may not be a particular high bar to attain.

Retrospective versions of Figures~\@ref(fig:main-historical-1)
and \@ref(fig:main-historical-2) are calculated using the current base model
but with data only up to a certain year
(Figures~\@ref(fig:main-historical-retro-1)--
\@ref(fig:main-historical-retro-bforty-all)). While there are some minor
exceptions, the retrospective probabilities of decline (colored squares in
Figures~\@ref(fig:main-historical-retro-1)--
\@ref(fig:main-historical-retro-all)) are generally close to the
probabilities currently estimated using all available data (blue triangles).
An exception is P$(\mathrm{B}_{2016} < \mathrm{B}_{2015})$ which is
underestimated (compared to the current base model) until data to 2017 are
included (the 2015 values in each panel of
Figure~\@ref(fig:main-historical-retro-2)). This is due to the retrospective
uncertainty of the 2014 cohort, seen as an increase and then decrease in
expected cohort size in Figure~\@ref(fig:main-retrospective-recruitment).
The retrospective calculations for P$(\mathrm{B}_{t+1} < \Bforty)$ show
little change as more data are added
(Figure~\@ref(fig:main-historical-retro-bforty-all)), except for 2015 and
2021 as information becomes available about the strong 2014 and 2020 cohorts.
Combined, these results enhance confidence in the projected outcomes from the
assessment model.


\newpage

<!--chapter:end:010-assessment.rmd-->

\rfoot{Research and data needs}

## Research and data needs {#sec:research}

```{r child = "011-research-needs/research-needs.rmd"}
```

```{r child = "011-research-needs/research-needs-extra.rmd"}
```

<!--chapter:end:011-research-needs-loader.rmd-->

\clearpage

# REFERENCES {-}

<!--chapter:end:099-references.rmd-->

