---
title: "Fisheries, data, and inputs used in the 2024 Pacific Hake stock assessment"
params:
  sp: "Pacific Hake"
  common_name: "Pacific whiting"
  science_name: "Merluccius productus"
  simple_name: "hake"
  survey_name: "Joint U.S. and Canadian Integrated Acoustic and Trawl Survey"
  assess_yr: 2023
  last_assess_yr: 2022
  last_data_yr: 2022
  model_version: "01"
  last_yr_model_version: "01"
author: Pacific Hake Joint Technical Committee
date: "SRG meeting -- `r assess_yr`"
subtitle: "Disclaimer: These materials do not constitute a formal publication and are for information only. They are in a pre-review, pre-decisional state and should not be formally cited or reproduced. They are to be considered provisional and do not represent any determination or policy of NOAA or the Department of Commerce."
output:
  beamer_presentation:
    theme: Singapore
    slide_level: 2
    keep_tex: true
classoption: "aspectratio=169"
fontsize: 11pt
urlcolor: blue
header-includes:
  - \usepackage{makecell, booktabs, array}
  - \usepackage[outdir=./knitr-figs-pdf/]{epstopdf}
  - \AtBeginSubsection{}
  - \AtBeginSection{}
---

```{r setup, echo = FALSE, cache = FALSE, message = FALSE, results = "hide", warning = FALSE}
library(knitr)
devtools::load_all("~/github/pacific-hake/hake")

if(is_latex_output()){
  knitr_figs_dir <<- "knitr-figs-pdf/"
  knitr_cache_dir <<- "knitr-cache-pdf/"
  fig_out_type <<- "png"
}else{
  knitr_figs_dir <<- "knitr-figs-docx/"
  knitr_cache_dir <<- "knitr-cache-docx/"
  fig_out_type <<- "png"
}
fig_width <<- 7.5
fig_dpi <<- 200
fig_align <<- "center"
fig_pos <<- "htb"
opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  results = "hide",
  comment = "#>",
  fig.path = knitr_figs_dir,
  cache.path = knitr_cache_dir,
  fig.width = fig_width,
  echo = FALSE,
  autodep = FALSE,
  cache = TRUE,
  cache.lazy = FALSE,
  cache.comments = FALSE,
  dev = fig_out_type,
  dpi = fig_dpi,
  fig.align = fig_align,
  fig.pos = fig_pos)

devtools::load_all(here::here())

fig_dir <- here::here("beamer", "srg", "data", "knitr-figs-pdf")
if(!dir.exists(fig_dir)){
  dir.create(fig_dir)
}
```

```{r loading, include = FALSE, results = "asis"}
res <- knitr::knit_child("../../../doc/001-load-packages.rmd")
cat(res, sep = '\n')
res <- knitr::knit_child("../../../doc/002-load-globals.rmd")
cat(res, sep = '\n')
res <- knitr::knit_child("../../../doc/003-load-models.rmd")
cat(res, sep = '\n')
res <- knitr::knit_child("../../../doc/004-load-project-variables.rmd")
cat(res, sep = '\n')
```

# Review
## Year in review
```{r pchangecatch}
last_yr_catch <- tail(last_5_yrs_total_ct, 1)
penult_yr_catch <- tail(last_5_yrs_total_ct, 2)[1]
pchangecatch <- percent(abs((last_yr_catch - penult_yr_catch)) / penult_yr_catch)
pchangecatch <- ifelse(last_yr_catch > penult_yr_catch,
                       paste0(pchangecatch, " increase"),
                       paste0(pchangecatch, " decrease"))

rank_catch_last_year <- rank(base_model$catch$Obs * -1) |> 
  tail(1) |> 
  scales::ordinal()

# If odd year, create survey text. If even, create "No survey this year" text
surv_text <- ifelse(last_data_yr %% 2,
                    paste0(last_survey_yr,
                           " acoustic survey biomass estimate was ",
                           last_survey_yr_biomass,
                           " Mt (",
                           as.numeric(last_factor_penult) * 100,
                           "% of ",
                           penult_survey_yr,
                           " estimate)."),
                    paste0("No survey was performed in ",
                           last_assess_yr,
                           "."))
```

* `r last_assess_yr` TAC, adjusted for carryovers, was `r last_yr_tac` t.
* Canadian and U.S. fisheries predominantly started in April and May,
  respectively.
* `r rank_catch_last_year` highest coast-wide catch.
* `r pchangecatch` in catch from last year.
* No Canadian Joint-Venture Fishery.
* Highest proportion-at-age by sector
  - Age-`r us_age_1_prop_age_cp` fish in U.S. catcher-processor sector,
  - Age-`r us_age_1_prop_age_ms` fish in U.S. mothership sector,
  - Age-`r us_age_1_prop_age_shore` fish in U.S. shore-based sector,
  - Age-`r max_freezer_trawler_age_prop_age` fish in Canadian freezer-trawler
    sector, and
  - Age-`r max_shoreside_age_prop_age` fish in Canadian shoreside sector.
* `r surv_text`

## Summary of data sources used
:::::: {.columns}
::: {.column width="40%"}
* Fishery-dependent data
  - Annual catch (`r start_yr`--`r end_yr - 1`)
  - Age compositions (1975--`r end_yr - 1`; 1$^+$)
* Acoustic survey (`r survey_start_yr`--`r survey_end_yr`)
  - Biomass index age 2$^+$
  - Age compositions (2$^+$)
  - Numbers of age-1 fish
* Weight-at-age (1975--`r end_yr - 1`)
* Ageing imprecision and biases
  - double reads
  - blind reads
* Maturity ogive (NWFSC, 2017)
:::

::: {.column width="60%"}
```{r data-overview-map, out.height = "3in", out.width = "1\\columnwidth"}
plot_data_summary(base_model,
                  label_y_placement = c(1.8, 2.5, 2.0))
```
:::
::::::

# Catches and Allocations
## Catches
```{r catches, fig.height = 3.9, out.height = "3in", out.width = "1\\columnwidth"}
plot_catches(ct, xlim = c(start_yr, last_data_yr),
             leg_font_size = 7,
             leg_key_size = 0.2,
             leg_ratio = c(1, 4))
```

## Allocations of `r end_yr - 1` TAC of `r last_yr_tac` t
:::::: {.columns}
::: {.column width="50%"}
\center \textbf{\textcolor{blue}{Canada}} \center

\

\center \textbf{TAC was `r last_yr_can_tac` t} \center

* TAC includes `r last_yr_can_carryover` t of carryover
* Freezer Trawlers and Shoreside -- `r last_yr_can_shoreside_tac` t
* Joint Venture -- `r last_yr_can_tac_jv` t
:::

::: {.column width="50%"}
\center \textbf{\textcolor{blue}{United States}} \center

\

\center \textbf{TAC was `r last_yr_us_tac` t} \center

* Research and bycatch -- `r f(last_yr_us_research)` t
* Tribal  -- `r f(last_yr_us_tribal)` t -
  `r f(last_yr_us_tribal_quota_reallocated)` t reallocated on
  `r last_yr_us_tribal_reallocate_dates`
* Catcher Processor -- `r f(last_yr_us_cp_quota_reallocated)` t
* Mothership -- `r f(last_yr_us_ms_quota_reallocated)` t
* Shore-Based -- `r f(last_yr_us_shore_quota_reallocated)` t
:::
::::::

## Catches of `r end_yr - 1` TAC of `r last_yr_tac` t
:::::: {.columns}
::: {.column width="50%"}
\center \textbf{\textcolor{blue}{Canada}} \center

\

\center \textbf{TAC was `r last_yr_can_tac` t} \center
`r last_yr_can_landings` t, `r last_yr_can_attained`% of the Canadian TAC

* Freezer Trawlers -- `r last_yr_can_freezer` t,
  `r last_yr_can_freezer_percent`% of Canadian catch
* Shoreside -- `r last_yr_can_shore` t,
  `r last_yr_can_shore_percent`% of Canadian catch
* Joint Venture -- `r last_yr_can_jv` t,
`r last_yr_can_jv_percent`% of Canadian catch
:::

::: {.column width="50%"}
\center \textbf{\textcolor{blue}{United States}} \center

\

\center \textbf{TAC was `r last_yr_us_tac` t} \center
`r last_yr_us_landings` t, `r last_yr_us_attained`% of the U.S. TAC

* Catcher Processor -- `r f(last_yr_us_cp_ct)` t,
  `r last_yr_us_cp_ct_percent`% of US CP allocation
* Mothership `r f(last_yr_us_ms_ct)` t,
  `r last_yr_us_ms_ct_percent`% of US MS allocation
* Shore-Based -- `r f(last_yr_us_shore_ct)` t,
  `r last_yr_us_shore_ct_percent`% of shore-based allocation, includes
  `r f(round(sum(subset(us_ti_ct_by_month_df, year == last_assess_yr)$catch), 0))`
   t of tribal catches
:::
::::::

## Cumulative catch by month
```{r cumulative-catches, fig.height = 4, out.height = "3in", out.width = "1\\columnwidth"}
plot_cumulative_catches(list(us_ss_catch_by_month_df,
                             can_ss_catch_by_month_df,
                             us_cp_catch_by_month_df,
                             can_ft_catch_by_month_df,
                             us_ms_catch_by_month_df),
                        list("U.S. Shore-Based",
                             "Canadian Shorside",
                             "U.S. Catcher-processor",
                             "Canadian Freezer-Trawlers",
                             "U.S. Mothership"),
                        type = "cumulative",
                        ax_title_font_size = 10,
                        ax_tick_font_size = 8,
                        leg_font_size = 8)
```
  
# Depths
## Canada freezer-trawler depth distribution
```{r depthcaft, fig.height = 4, out.height = "3in", out.width = "1\\columnwidth"}
plot_depth_2_panel(can_ft_gear_depth_df,
                   can_ft_bottom_depth_df,
                   yrs = (last_data_yr - 4):last_data_yr)
```

## Canada shoreside depth distribution
```{r depthcass, fig.height = 4, out.height = "3in", out.width = "1\\columnwidth"}
plot_depth_2_panel(can_ss_gear_depth_df,
                   can_ss_bottom_depth_df,
                   yrs = (last_data_yr - 4):last_data_yr)
```

## U.S. at-sea depth distribution
```{r depthus, fig.height = 4, out.height = "3in", out.width = "1\\columnwidth"}
plot_depth_2_panel(us_atsea_fishing_depth_df,
                   us_atsea_bottom_depth_df,
                   yrs = (last_data_yr - 4):last_data_yr)
```

# Ages
## Age composition by sector
```{r age-comp-comparison, fig.height = 4, out.height = "3in", out.width = "1\\columnwidth"}
plot_age_comp_bubbles_data(list(can_ss_age_df,
                                can_ft_age_df,
                                us_ss_age_df,
                                us_cp_age_df,
                                us_ms_age_df),
                           list("Canadian Shorside",
                                "Canadian Freezer-Trawlers",
                                "U.S. Shore-Based",
                                "U.S. Catcher-processor",
                                "U.S. Mothership"),
                           ax_title_font_size = 8,
                           ax_tick_font_size = 8)
```

## Acoustic survey age compositions
```{r survey-age-comps, fig.height = 4, out.height = "3in", out.width = "1\\columnwidth"}
plot_age_comp_bubbles(base_model,
                      type = "survey",
                      clines = c(1984, 1999, 2010, 2014, 2016, 2020),
                      inc_mean_age_line = FALSE,
                      point_alpha = 0.4,
                      xlim = c(survey_start_yr, last_data_yr))
```

## Survey and fishery age-composition comparison
```{r age-comp-comparison-fishery-survey, fig.height = 4, out.height = "3in", out.width = "1\\columnwidth"}
plot_age_comp_comparison_bubbles(base_model)
```

# Surveys
## Acoustic survey backscatter (age-2$^+$) and age composition
![](../../../doc/main-figures/hake_survey_1995-21_NASCTimeSeries_BiomassAtAgeHistograms_grayblue)

## Acoustic survey backscatter of age-1 fish
![](../../../doc/main-figures/age1hake_03-21_sA_squareroot_bin_narrow-panel_grayblue)

## Acoustic survey age-2$^+$ biomass estimates
```{r survey-compare-extrap-noextrap, fig.height = 4, out.height = "3in", out.width = "1\\columnwidth"}
plot_survey_biomass(base_model, index = "age2")
```

## Acoustic survey age-1 fish estimates
```{r survey-age1, fig.height = 4, out.height = "3in", out.width = "1\\columnwidth"}
plot_survey_biomass(base_model, index = "age1", y_lim = c(0, 16))
```

# Weight-at-age
## Weight-at-age data
* Pre-1975 U.S.~weight-at-age data are not included because they were
  collected from the Puget Sound.
* Historical fecundity uses mean weight-at-age data from all years.
* Future fecundity uses mean weight-at-age data from most recent five years.

## Weight-at-age by year
```{r wt-at-age, fig.height = 4, out.height = "3in", out.width = "1\\columnwidth"}
plot_weight_at_age(wt_at_age,
                   ages = 2:10,
                   bold_ages = 5,
                   cols = c("purple",
                            "darkblue",
                            "yellow",
                            "darkgreen"),
                   max.overlaps = 15)
```

## Sample sizes of weight-at-age by year
```{r main-weight-at-age-numbers, fig.height = 4, out.height = "3in", out.width = "1\\columnwidth"}
plot_heatmap_sample_size_weight_at_age(
  base_model,
  cell_font_size = 2,
  sample_size_df = weight_age_sample_sizes_df,
  pre_yrs = start_yr_age_comps:base_model$endyr,
  pre_func = mean,
  post_yrs = (base_model$endyr - 4):base_model$endyr,
  post_func = mean,
  cols = c("purple",
           "lightgreen",
           "yellow",
           "dodgerblue"),
  ax_tick_font_size = 6)
```

# Maturity and Fecundity
## Ovary sampling
* Sample sources
  - Bottom trawl survey (2009, 2012 -- 2017)
  - Acoustic survey (2012 -- 2013, 2015 -- 2017)
  - At-sea fishery (2013 -- 2017)
* Length stratified sampling from surveys with target numbers for 2 cm length bins.
* Data from 2018 and 2019 are expected to be analyzed in 2021.

## Status of Canadian ovary samples
```{r ovary-table, results = "asis", echo = FALSE, out.width="1\\columnwidth"}
table_ovary_samples(
  ovary_samples_df,
  font_size = 7,
  header_font_size = 6)
```

## Maturity
```{r maturity.ogive.figure, fig.height = 4, out.height = "3in", out.width = "1\\columnwidth"}
plot_maturity_ogives(base_model,
                     maturity_samples_df)
```

## Fecundity
```{r fecundity.figure, fig.height = 4, out.height = "3in", out.width = "1\\columnwidth"}
plot_fecundity(base_model,
               d = maturity_samples_df,
               yrs = start_yr_age_comps:(end_yr - 1),
               leg_pos = c(0.6, 0.2))
#axis_title_font_size = 10,
#axis_tick_font_size = 8)
```

## Fecundity
* Fecundity-at-age is set to maturity-at-age $*$ weight-at-age in Stock
  Synthesis.
* We need a better understanding of:
  - Batch spawning.
  - Links between fecundity and size, age, and weight.
  - How the above topics provide further information about factors that
    influence varying reproductive output.
* More winter acoustic surveys may provide further information about these questions.

# Summary
## Data sources **NOT** used in the base model
* Fishery independent
  - Length / sex frequencies from the acoustic survey.
  - Bottom-trawl survey age-composition data.
  - Juvenile and pre-recruit surveys from the Southwest Fisheries Science
    Center and Pacific Whiting Conservation Cooperative.
* Fishery dependent
  - Length frequencies from the fishery.
  - Fishery CPUE.
  - Bycatch in non-target fisheries.
  - Mexican landings / sample data.
* Externally derived environmental / ecosystem covariates
