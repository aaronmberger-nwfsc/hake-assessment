---
title: "`r assess_yr` Pacific Hake Stock Assessment Methods and Results"
project_variables:
  sp: "Pacific Hake"
  common_name: "Pacific whiting"
  science_name: "Merluccius productus"
  simple_name: "hake"
  survey_name: "Joint U.S. and Canadian Integrated Acoustic and Trawl Survey"
  assess_yr: 2023
  last_assess_yr: 2022
  last_data_yr: 2022
  model_version: "01"
  last_yr_model_version: "01"
author: Pacific Hake Joint Technical Committee
date: "SRG meeting -- `r assess_yr`"
subtitle: "Disclaimer: These materials do not constitute a formal publication and are for information only. They are in a pre-review, pre-decisional state and should not be formally cited or reproduced. They are to be considered provisional and do not represent any determination or policy of NOAA or the Department of Commerce."
output:
  beamer_presentation:
    theme: Singapore
    slide_level: 2
    keep_tex: true
classoption: "aspectratio=169"
fontsize: 11pt
urlcolor: blue
header-includes:
  - \usepackage{makecell, booktabs, makecell, array, longtable, bm}
  - \makeatletter\def\fnum@table{\usebeamercolor{caption name}\usebeamerfont*{caption name}\tablename~\thetable}\makeatother
  - \usepackage[outdir=./knitr-figs/]{epstopdf}
  - \AtBeginSubsection{}
  - \AtBeginSection{}
  - \newcommand{\PreserveBackslash}[1]{\let\temp=\\#1\let\\=\temp}
  - \newcolumntype{C}[1]{>{\PreserveBackslash\centering}p{#1}}
  - \newcolumntype{R}[1]{>{\PreserveBackslash\raggedleft}p{#1}}
  - \newcolumntype{L}[1]{>{\PreserveBackslash\raggedright}p{#1}}
  - \input{../../hake-beamer.tex}
---

```{r setup, echo = FALSE, cache = FALSE, message = FALSE, results = "hide", warning = FALSE}
library(knitr)

opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  autodep = FALSE,
  cache = TRUE,
  cache.lazy = FALSE,
  cache.comments = FALSE,
  results = "hide",
  comment = "#>",
  dev = "png",
  dpi = 200,
  cache.path = "knitr-cache/",
  fig.path = "knitr-figs/",
  fig.align = "center",
  fig.pos = "htb",
  fig.width = 7.5)

devtools::load_all(here::here())
fig_dir <- here::here("beamer/srg/assessment/knitr-figs")
if(!dir.exists(fig_dir)){
  dir.create(fig_dir)
}
```

```{r loading, include = FALSE, results = "asis"}
library(here)
res <- knit_child(here("doc/001-load-packages.rmd"))
cat(res, sep = "\n")
res <- knit_child(here("doc/002-load-globals.rmd"))
cat(res, sep = "\n")
res <- knit_child(here("doc/003-load-models.rmd"))
cat(res, sep = "\n")
res <- knit_child(here("doc/004-load-project-variables.rmd"))
cat(res, sep = "\n")
# Read in latex globals from 004-load-project-variables.rmd
# The knit_child() command above does not load them in
# readLines(here("doc/004-load-project-variables.rmd"))
# grep("\\\\newcommand\\{", d, value = TRUE)
# cat(latex_lines)
```

# Outline
* Model changes from `r last_assess_yr`
* Show some MCMC diagnostics
* Fits to data
* Estimates of key quantities
* Brief response to `r last_assess_yr` SRG assessment recommendations
* Summary

# Changes from `r last_assess_yr`
## Changes from the `r last_assess_yr` assessment
* Update Stock Synthesis to version `r ss_version`
* Add new catch data for `r last_assess_yr` and update historical catches 
* Add new weight-at-age data for `r last_assess_yr`and update
  weight-at-age data
* Add the `r last_assess_yr` acoustic survey biomass estimate and age data
* Add the `r last_assess_yr` age-1 index estimate
* Add new fishery age composition data for `r last_assess_yr` and historical
  fishery age composition data
* No changes to acoustic survey biomass estimates or age-1 index
  estimates this year
* All model runs in the assessment use MCMC

## Bridging: Model Updates and Additions
```{r bridge-biomass, fig.height=4, out.height = "2.7in", out.width = "1\\columnwidth"}
p <- list()
p[[1]] <-
  plot_rel_biomass(d_obj = d_obj_bridge_rel_biomass[[1]],
                   ylim = c(0, 2.5),
                   x_labs_mod = 10,
                   wrap_y_label = TRUE,
                   leg_pos = "none")
p[[2]] <-
  plot_recdevs(d_obj = d_obj_bridge_recdev[[1]],
               leg_pos = "none",
               x_labs_mod = 10,
               line_width = 0.1)

plot_grid(plotlist = p,
          nrow = 1,
          ncol = 2)
```

## Bridging: Model Updates and Additions (survey)
```{r bridge-survey, fig.height=4, out.height = "2.7in", out.width = "1\\columnwidth"}
p <- list()
p[[1]] <-
  plot_survey_index_fits(d_obj = d_obj_bridge_age2_index[[1]],
                         survey_type = "age2",
                         rev_colors = FALSE,
                         leg_pos = "none")

p[[2]] <-
  plot_survey_index_fits(d_obj = d_obj_bridge_age1_index[[1]],
                         survey_type = "age1",
                         xlim = c(1995, 2022),
                         ylim = c(0, 11),
                         y_breaks = seq(0, 11, by = 2),
                         rev_colors = FALSE,
                         leg_pos = "none")

plot_grid(plotlist = p,
          nrow = 1,
          ncol = 2)
```

## Bridging: Summary
* Updating Stock Synthesis software has no effect on results. Relevant
  changes include:
  - Weight-at-age specified in first year of forecast, rather than
    carried forward
  - Report files for models using empirical weight-at-age for growth do
    not supply output that uses growth parameters
* Updating data previous to `r last_data_yr` had very little effect on the
  stock trajectory
  \pause
* Adding `r last_data_yr` catch and weight-at-age data resulted in a slight
  upward shift in current female spawning biomass, because the mean weights
  in `r last_data_yr` were mostly above the recent 5-year average mean
  weights (assumption before the addition of these data)
* Adding the `r last_data_yr` survey biomass estimate and age compositions
  leads to slightly more optimistic estimates of biomass for the last few
  years and reduces uncertainty
* The addition of the age-1 index resulted in a small increase in $B_0$,
  an increase in relative spawning biomass from 2019--2022, and an
  increase in the estimated size of the 2018 and 2020 cohorts
* Adding `r last_assess_yr` fishery age composition data had little impact
  on historical estimates, shifted recent recruitment estimates
  (esp. 2019--2021), and increased estimates of 2022 (slightly) and 2023
  (considerably) female spawning biomass.

# MCMC Diagnostics
## Diagnostics: Summary
* Summary diagnostics for key parameters are shown in Appendix A of the
  assessment document
* Additional diagnostic evaluations were performed using the ShinySTAN
  application, an analysis and visualization GUI for MCMC, including:
  - Effective sample sizes for all parameters
  - Number and location of divergent transitions in parameter space for
    all parameters
  - Multiple chain comparison statistics (Rhat)
  - Many others
* Posterior correlations among key parameters and summary diagnostics for
  all chains combined are shown in Appendix A (no issues identified)

## Diagnostics for all parameters and spawning biomass
```{r main-mcmc-diag-hists, fig.height=4, out.height = "2.7in", out.width = "1\\columnwidth"}
plot_mcmc_diagnostics_all_params(base_model,
                                 show_ro = TRUE,
                                 ro_arrow_lengths = c(10, 20, 7, 20),
                                 ro_text_nudges = c(0.15, 0, -0.55, 0),
                                 ro_text_size = 3)
```

# Fits to data
## Fit to the acoustic survey index of abundance
```{r mcmc-survey-fit, fig.height=4, out.height = "2.7in", out.width = "1\\columnwidth"}
base_model$plots$survey_fit
```

## Fit to the age-1 relative index
```{r mcmc-age1-fit, fig.height=4, out.height = "2.7in", out.width = "1\\columnwidth"}
base_model$plots$age1_index_fit
```

## Fit to acoustic survey age comps
:::::: {.columns}
::: {.column width="40%"}
* Relative cohort strength captured well, but some over- and under-fitting
* Predicted higher: 1999 cohort and 2010 cohort in 2017 survey
* Predicted lower: some young cohorts in 2003--2011, 2014 cohort in
  2017 survey
* Predictions for 2014 and 2016 cohorts are similar in the 2019 and 2021
  surveys, despite differences in survey estimates (although well within the
  range of uncertainty)
:::

::: {.column width="60%"}
```{r survey-age-comp-fits, fig.height=4, out.height = "2.7in", out.width = "1\\columnwidth"}
plot_age_comp_fit(base_model,
                  n_col = 4,
                  type = "survey",
                  x_breaks = seq(2, 15, 2),
                  label_font_size = 4,
                  label_loc = c(12, 0.7))
```
:::
::::::

## Fit to fishery age comps
:::::: {.columns}
::: {.column width="40%"}
* Large 1999, 2010, and 2014 cohorts fit particularly well
* Some over- and under-fitting in 1980 and 1984 cohorts
* The 2016 cohort is slightly under-fit in recent years
* Fishery data in 2022 imply a slightly larger size for the 2020 cohort than
  the model prediction
:::

::: {.column width="60%"}
```{r fishery-age-comp-fits, fig.height=4, out.height = "2.7in", out.width = "1\\columnwidth"}
plot_age_comp_fit(base_model,
                  label_font_size = 3,
                  type = "fishery",
                  n_col = 4)
```
:::
::::::

## Pearson residual for fit to the age data
:::::: {.columns}
::: {.column width="50%"}
\center Fishery \center
```{r fishery-pearson, fig.height=4, out.height = "2in", out.width = "1\\columnwidth"}
plot_pearson_bubbles(base_model,
                     type = "fishery",
                     leg_pos = "top")
```
:::

::: {.column width="60%"}
\center Survey \center
```{r survey-pearson, fig.height=4, out.height = "2in", out.width = "1\\columnwidth"}
plot_pearson_bubbles(base_model,
                     type = "survey",
                     alpha = 0.7)
```
:::
::::::
Dark bubbles are positive residuals (observed > expected) and white bubbles
are negative residuals (observed < expected)

# Estimated Quantities
## Key parameters
:::::: {.columns}
::: {.column width="40%"}
* Prior for natural mortality looks to be influencing posterior
* Posterior for steepness does not shift much from prior
* DM for fishery has a relatively narrow posterior distribution
* Prior for survey DM parameter looks to be influencing posterior (discussed
  further in sensitivity section)
:::

::: {.column width="60%"}
```{r priors-posts, fig.height=4, out.height = "2.7in", out.width = "1\\columnwidth"}
plot_priors_vs_posts(base_model,
                     x_range = "prior",
                     ncol = 2,
                     nrow = 3)
```
:::
::::::

## Acoustic survey catchability (\emph{$q_b$}) posterior for this assessment
```{r catchability-density, fig.height=4, out.height = "2in", out.width = "0.8\\columnwidth"}
plot_catchability_density(base_model,
                          last_yr_base_model,
                          type = "age2",
                          line_widths = c(1, 1),
                          line_types = c("solid", "solid"))
```

```{r table-catchability-medians, results = "asis"}
k <- function(){

  d <- tibble(a = c(paste0("Median (", assess_yr, ")"),
                    f(median(last_yr_base_model$extra_mcmc$q_vector), 2)),
              b = c(paste0("Median (", last_assess_yr, ")"),
                    f(median(base_model$extra_mcmc$q_vector), 2)))

  kbl(d,
      format = "latex",
      booktabs = TRUE,
      col.names = NULL,
      align = c("c", "c"),
      linesep = "",
      escape = FALSE) |>
    row_spec(0, bold = TRUE) |> 
    column_spec(1, color = "blue") |> 
    column_spec(2, color = "red") |> 
    kable_styling(position = "center")
}

k()
```

## Time-varying selectivity
:::::: {.columns}
::: {.column width="50%"}
```{r selectivity-mountains, fig.height=4, out.height = "2.8in", out.width = "1\\columnwidth"}

tv_selex_start_yr <- 1990

plot_selex_mountains(base_model,
                     yrs = tv_selex_start_yr:last_data_yr,
                     ages = 1:8,
                     fill_num_colors = 50,
                     scale = 20)
```
:::

::: {.column width="50%"}
```{r selectivity-uncertainty, fig.height=4, out.height = "2.8in", out.width = "1\\columnwidth"}
plot_selex_uncertainty(base_model,
                       n_col = 2,
                       label_loc = c(1, 0.65),
                       label_font_size = 3)
```
:::
::::::

## Posterior distributions for survey (left) and fishery (right) selectivity
:::::: {.columns}
::: {.column width="50%"}
```{r selectivity-posterior-survey, fig.height=4, out.height = "2.8in", out.width = "1\\columnwidth"}
plot_selex_posteriors(base_model,
                      type = "survey",
                      probs = probs,
                      age_range = c(1, 8),
                      post_med_line_color = "red3",
                      unc_line_color = "red3",
                      glow = TRUE)
```
:::

::: {.column width="50%"}
```{r selectivity-posterior-fishery, fig.height=4, out.height = "2.8in", out.width = "1\\columnwidth"}
plot_selex_posteriors(base_model,
                      type = "fishery",
                      probs = probs,
                      age_range = c(1, 8),
                      glow = TRUE)
```
:::
::::::

## Key quantities
```{r table-parameter-ests, results = "asis"}
table_param_est(
  models = list(base_model, last_yr_base_model),
  model_nms = c(base_model_name, last_yr_base_model_name),
  end_yr = end_yr,
  section_bold = TRUE,
  section_italics = TRUE,
  section_underline = TRUE,
  section_line_above = FALSE,
  section_line_below = FALSE,
  digits = 3,
  font_size = 5.5,
  header_font_size = 7)
```
